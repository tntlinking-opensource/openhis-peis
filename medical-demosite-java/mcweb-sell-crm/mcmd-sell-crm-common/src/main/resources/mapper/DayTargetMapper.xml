<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.sellcrm.dao.DayTargetMapper">



    <!-- 查询列表数据 -->
    <select id="getPage" resultType="com.center.medical.sellcrm.bean.vo.DayTargetVo">
        select * from (
                          select
                              u.user_no userid,
                              u.user_name,
                              null bz,
                              IFNULL(sum(pcm.moneyamountpaid),0) complete,
                              b.fzx,
                              TimeStampDiff( year, u.entry_date ,now() ) AS workingAge
                          from sys_user u
                                   inner join sys_user_dep qud on qud.user_id=u.user_no
                              and qud.dep_id='402881b757417af40157417f62eb0009'
                                   left join md_peispatient p on p.id_opendoctor=u.user_no
                                    and p.hospitalcode = u.cid
                                <if test="param.startTime!=null">
                                    and p.dateregister >= #{param.startTime}
                                </if>
                                <if test="param.endTime!=null">
                                    and p.dateregister <![CDATA[<=]]> #{param.endTime}
                                </if>
                                <if test="param.branchIds!=null and param.branchIds.size > 0">
                                    AND u.cid IN
                                    <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                                        #{brandId}
                                    </foreach>
                                </if>
                                   left join md_peispatientcharge pcm on pcm.patientcode=p.patientcode
                              and (pcm.is_add is null or pcm.is_add=0)
                              left join sys_branch b on b.branch_id = u.cid
                          <where>
                              u.del_flag = 0
                              <if test="param.userNo!=null and param.userNo!=''">
                                  AND u.user_no = #{param.userNo}
                              </if>
                          </where>
                          group by
                              u.user_no,
                              u.user_name,
                              u.cid

                          union all

                          select
                              u.user_no userid,
                              u.user_name,
                              '服务单' bz,
                              IFNULL(sum(pcm.moneyamountpaid),0) complete ,
                              b.fzx,
                              TimeStampDiff( year, u.entry_date ,now() ) AS workingAge
                          from sys_user u
                                   inner join sys_user_dep qud on qud.user_id=u.user_no
                              and qud.dep_id='402881b757417af40157417f62eb0009'
                                   inner join md_peispatient p on p.id_opendoctor=u.user_no
                                    <if test="param.startTime!=null">
                                        and p.dateregister >= #{param.startTime}
                                    </if>
                                    <if test="param.endTime!=null">
                                        and p.dateregister <![CDATA[<=]]> #{param.endTime}
                                    </if>
                                    <if test="param.branchIds!=null and param.branchIds.size > 0">
                                        AND u.cid IN
                                        <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                                            #{brandId}
                                        </foreach>
                                    </if>
                                   inner join md_peispatientcharge pcm on pcm.patientcode=p.patientcode
                              and (pcm.is_add is null or pcm.is_add = 0 )
                                   inner join sys_user_branch qub on qub.user_id = u.user_no
                              and qub.branch_id = p.hospitalcode
                            left join sys_branch b on b.branch_id = p.hospitalcode
                          <where>
                              u.cid!=p.hospitalcode
                              and u.del_flag = 0
                              <if test="param.userNo!=null and param.userNo!=''">
                                  AND u.user_no = #{param.userNo}
                              </if>
                          </where>
                          group by
                              u.user_no ,
                              u.user_name,
                              p.hospitalcode
                      ) as aaaa
        order by user_name
    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultType="com.center.medical.sellcrm.bean.model.Selltarget">

    </select>



    <!-- 获取总结数据 -->
    <select id="getSummaryData" resultType="java.lang.Double">
        select sum(complete) from (
        select
        u.user_no userid,
        u.user_name,
        null bz,
        IFNULL(sum(pcm.moneyamountpaid),0) complete,
        b.fzx,
        TimeStampDiff( year, u.entry_date ,now() ) AS workingAge
        from sys_user u
        inner join sys_user_dep qud on qud.user_id=u.user_no
        and qud.dep_id='402881b757417af40157417f62eb0009'
        left join md_peispatient p on p.id_opendoctor=u.user_no
        and p.hospitalcode = u.cid
        <if test="param.startTime!=null">
            and p.dateregister >= #{param.startTime}
        </if>
        <if test="param.endTime!=null">
            and p.dateregister <![CDATA[<=]]> #{param.endTime}
        </if>
        <if test="param.branchIds!=null and param.branchIds.size > 0">
            AND u.cid IN
            <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                #{brandId}
            </foreach>
        </if>
        left join md_peispatientcharge pcm on pcm.patientcode=p.patientcode
        and (pcm.is_add is null or pcm.is_add=0)
        left join sys_branch b on b.branch_id = u.cid
        <where>
            u.del_flag = 0
            <if test="param.userNo!=null and param.userNo!=''">
                AND u.user_no = #{param.userNo}
            </if>
        </where>
        group by
        u.user_no,
        u.user_name,
        u.cid

        union all

        select
        u.user_no userid,
        u.user_name,
        '服务单' bz,
        IFNULL(sum(pcm.moneyamountpaid),0) complete ,
        b.fzx,
        TimeStampDiff( year, u.entry_date ,now() ) AS workingAge
        from sys_user u
        inner join sys_user_dep qud on qud.user_id=u.user_no
        and qud.dep_id='402881b757417af40157417f62eb0009'
        inner join md_peispatient p on p.id_opendoctor=u.user_no
        <if test="param.startTime!=null">
            and p.dateregister >= #{param.startTime}
        </if>
        <if test="param.endTime!=null">
            and p.dateregister <![CDATA[<=]]> #{param.endTime}
        </if>
        <if test="param.branchIds!=null and param.branchIds.size > 0">
            AND u.cid IN
            <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                #{brandId}
            </foreach>
        </if>
        inner join md_peispatientcharge pcm on pcm.patientcode=p.patientcode
        and (pcm.is_add is null or pcm.is_add = 0 )
        inner join sys_user_branch qub on qub.user_id = u.user_no
        and qub.branch_id = p.hospitalcode
        left join sys_branch b on b.branch_id = p.hospitalcode
        <where>
            u.cid!=p.hospitalcode
            and u.del_flag = 0
            <if test="param.userNo!=null and param.userNo!=''">
                AND u.user_no = #{param.userNo}
            </if>
        </where>
        group by
        u.user_no ,
        u.user_name,
        p.hospitalcode
        ) as aaaa
    </select>




    <!-- 导出销售日目标 -->
    <select id="exportData" resultType="com.center.medical.sellcrm.bean.vo.DayTargetVo">
        select * from (
        select
        u.user_no userid,
        u.user_name,
        null bz,
        IFNULL(sum(pcm.moneyamountpaid),0) complete,
        b.fzx,
        TimeStampDiff( year, u.entry_date ,now() ) AS workingAge
        from sys_user u
        inner join sys_user_dep qud on qud.user_id=u.user_no
        and qud.dep_id='402881b757417af40157417f62eb0009'
        left join md_peispatient p on p.id_opendoctor=u.user_no
        and p.hospitalcode = u.cid
        <if test="param.startTime!=null">
            and p.dateregister >= #{param.startTime}
        </if>
        <if test="param.endTime!=null">
            and p.dateregister <![CDATA[<=]]> #{param.endTime}
        </if>
        <if test="param.branchIds!=null and param.branchIds.size > 0">
            AND u.cid IN
            <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                #{brandId}
            </foreach>
        </if>
        left join md_peispatientcharge pcm on pcm.patientcode=p.patientcode
        and (pcm.is_add is null or pcm.is_add=0)
        left join sys_branch b on b.branch_id = u.cid
        <where>
            u.del_flag = 0
            <if test="param.userNo!=null and param.userNo!=''">
                AND u.user_no = #{param.userNo}
            </if>
        </where>
        group by
        u.user_no,
        u.user_name,
        u.cid

        union all

        select
        u.user_no userid,
        u.user_name,
        '服务单' bz,
        IFNULL(sum(pcm.moneyamountpaid),0) complete ,
        b.fzx,
        TimeStampDiff( year, u.entry_date ,now() ) AS workingAge
        from sys_user u
        inner join sys_user_dep qud on qud.user_id=u.user_no
        and qud.dep_id='402881b757417af40157417f62eb0009'
        inner join md_peispatient p on p.id_opendoctor=u.user_no
        <if test="param.startTime!=null">
            and p.dateregister >= #{param.startTime}
        </if>
        <if test="param.endTime!=null">
            and p.dateregister <![CDATA[<=]]> #{param.endTime}
        </if>
        <if test="param.branchIds!=null and param.branchIds.size > 0">
            AND u.cid IN
            <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                #{brandId}
            </foreach>
        </if>
        inner join md_peispatientcharge pcm on pcm.patientcode=p.patientcode
        and (pcm.is_add is null or pcm.is_add = 0 )
        inner join sys_user_branch qub on qub.user_id = u.user_no
        and qub.branch_id = p.hospitalcode
        left join sys_branch b on b.branch_id = p.hospitalcode
        <where>
            u.cid!=p.hospitalcode
            and u.del_flag = 0
            <if test="param.userNo!=null and param.userNo!=''">
                AND u.user_no = #{param.userNo}
            </if>
        </where>
        group by
        u.user_no ,
        u.user_name,
        p.hospitalcode
        ) as aaaa
        order by user_name
    </select>
</mapper>

