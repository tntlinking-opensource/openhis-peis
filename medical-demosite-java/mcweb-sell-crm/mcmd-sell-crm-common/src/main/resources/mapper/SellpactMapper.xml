<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.sellcrm.dao.SellpactMapper">

    <resultMap type="com.center.medical.sellcrm.bean.model.Sellpact" id="SellpactMap">
        <id property="id" column="id"/>
        <result property="htmc" column="htmc"/>
        <result property="htbh" column="htbh"/>
        <result property="xsjl" column="xsjl"/>
        <result property="htqdrq" column="htqdrq"/>
        <result property="tjksrq" column="tjksrq"/>
        <result property="tjjsrq" column="tjjsrq"/>
        <result property="khdwmcid" column="khdwmcid"/>
        <result property="khdwmc" column="khdwmc"/>
        <result property="lxdh" column="lxdh"/>
        <result property="tjrs" column="tjrs"/>
        <result property="ys" column="ys"/>
        <result property="isDelete" column="is_delete"/>
        <result property="xsjlid" column="xsjlid"/>
        <result property="fzxid" column="fzxid"/>
        <result property="createdate" column="createdate"/>
        <result property="modifydate" column="modifydate"/>
    </resultMap>

    <!-- 数据表字段属性 -->
    <sql id="selectSellpactVo">
        select id,
               htmc,
               htbh,
               xsjl,
               htqdrq,
               tjksrq,
               tjjsrq,
               khdwmcid,
               khdwmc,
               lxdh,
               tjrs,
               ys,
               is_delete,
               xsjlid,
               fzxid,
               createdate,
               modifydate
        from crm_sellpact
    </sql>

    <!-- 查询列表数据 -->
    <select id="getPage" resultType="com.center.medical.sellcrm.bean.model.Sellpact">
        select ms.id,
        ms.htmc,
        ms.htbh,
        ms.xsjl,
        ms.htqdrq,
        ms.tjksrq,
        ms.tjjsrq,
        ms.khdwmcid,
        ms.khdwmc,
        ms.lxdh,
        ms.tjrs,
        ms.ys,
        ms.is_delete,
        ms.xsjlid,
        ms.fzxid,
        ms.createdate,
        ms.modifydate,
        count(msp.id) wjgs
        from crm_sellpact ms
        LEFT JOIN md_savefilepath msp ON ms.id = msp.ggid
        <where>
            ms.is_delete = 0
            <if test="param.branchIds!=null">
                AND ms.fzxid IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
            <if test="param.xsjlid!=null and param.xsjlid!=''">
                AND ms.xsjlid = #{param.xsjlid}
            </if>
            <if test="param.htmc!=null and param.htmc!=''">
                AND ms.htmc LIKE concat('%',#{param.htmc},'%')
            </if>
            <if test="param.htbh!=null and param.htbh!=''">
                AND ms.htbh LIKE concat('%',#{param.htbh},'%')
            </if>
            <if test="param.khdwmc!=null and param.khdwmc!=''">
                AND ms.khdwmc LIKE concat('%',#{param.khdwmc},'%')
            </if>
            <if test="param.htqdrq!=null">
                AND ms.htqdrq = #{param.htqdrq}
            </if>
        </where>
        GROUP BY ms.htbh
    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultMap="SellpactMap">
        <include refid="selectSellpactVo"/>
        <where>
            is_delete = 0
            AND id = #{id}
        </where>
    </select>


    <!-- 分页查询流失客户 -->
    <select id="getList" resultType="com.center.medical.sellcrm.bean.vo.SellpactVo">
        SELECT
        msr.khdwmc,
        msr.khdwsrm,
        msr.khdwlxr,
        msr.khdh,
        msr.khdwzcdz,
        p.dateregister,
        msr.id,
        msr.createdate,
        msr.khzt
        FROM
        crm_sellcustomer msr
        LEFT JOIN ( SELECT id_org, min( dateregister ) AS dateregister FROM md_peispatient p GROUP BY id_org ) p ON p.id_org = msr.id
        <where>
            1 = 1
            AND msr.is_delete = 0
            AND p.dateregister is not null
            <if test="param.khdwmcid!=null and param.khdwmcid!=''">
                AND msr.id = #{param.khdwmcid}
            </if>
            <if test="param.fzxId!=null and param.fzxId!=''">
                AND msr.fzxid = #{param.fzxId}
            </if>
            <if test="param.xsjlid!=null and param.xsjlid!=''">
                AND msr.xsjlid = #{param.xsjlid}
            </if>
            <if test="param.sxDate!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.sxDate}
            </if>
            <if test="param.year!=null and param.year!=''">
                AND STR_TO_DATE(msr.createdate,'%Y') =  STR_TO_DATE(#{param.year},'%Y')
            </if>
        </where>
        order by p.dateregister DESC
    </select>


    <!-- 根据主键id获取流失客户 -->
    <select id="getloseCustInfoById" resultType="com.center.medical.sellcrm.bean.vo.SellpactVo">
        SELECT
        msr.khdwmc,
        msr.khdwsrm,
        msr.khdwlxr,
        msr.khdh,
        msr.khdwzcdz,
        p.dateregister,
        msr.id,
        msr.createdate,
        msr.khzt
        FROM
        crm_sellcustomer msr
        LEFT JOIN ( SELECT id_org, min( dateregister ) AS dateregister FROM md_peispatient p GROUP BY id_org ) p ON p.id_org = msr.id
        <where>
            msr.id = #{id}
        </where>
    </select>

</mapper>

