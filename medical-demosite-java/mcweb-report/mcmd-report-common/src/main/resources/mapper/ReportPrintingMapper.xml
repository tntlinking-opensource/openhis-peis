<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.report.dao.ReportPrintingMapper">

    <resultMap type="com.center.medical.bean.model.Peispatient" id="PeispatientMap">
        <id property="id" column="id"/>
        <result property="idOrgpatient" column="id_orgpatient"/>
        <result property="idCis" column="id_cis"/>
        <result property="patientarchiveno" column="patientarchiveno"/>
        <result property="patientcode" column="patientcode"/>
        <result property="patientbizno" column="patientbizno"/>
        <result property="idcardno" column="idcardno"/>
        <result property="numorgresv" column="numorgresv"/>
        <result property="patientname" column="patientname"/>
        <result property="inputCode" column="input_code"/>
        <result property="idOrgreservationgroup" column="id_orgreservationgroup"/>
        <result property="idOrgreservation" column="id_orgreservation"/>
        <result property="idOrg" column="id_org"/>
        <result property="orgName" column="org_name"/>
        <result property="orgDepart" column="org_depart"/>
        <result property="havePrivate" column="have_private"/>
        <result property="idPayway" column="id_payway"/>
        <result property="payway" column="payway"/>
        <result property="personpricelimit" column="personpricelimit"/>
        <result property="idSex" column="id_sex"/>
        <result property="birthdate" column="birthdate"/>
        <result property="age" column="age"/>
        <result property="idMarriage" column="id_marriage"/>
        <result property="marriage" column="marriage"/>
        <result property="idNation" column="id_nation"/>
        <result property="nation" column="nation"/>
        <result property="address" column="address"/>
        <result property="idInformway" column="id_informway"/>
        <result property="idOpendoctor" column="id_opendoctor"/>
        <result property="email" column="email"/>
        <result property="phone" column="phone"/>
        <result property="idPatientclass" column="id_patientclass"/>
        <result property="idResarea" column="id_resarea"/>
        <result property="resarea" column="resarea"/>
        <result property="fIsforprepare" column="f_isforprepare"/>
        <result property="fIsforreserve" column="f_isforreserve"/>
        <result property="fRegistered" column="f_registered"/>
        <result property="dateregister" column="dateregister"/>
        <result property="guidancenote" column="guidancenote"/>
        <result property="idDoctorreg" column="id_doctorreg"/>
        <result property="doctorreg" column="doctorreg"/>
        <result property="idExamtype" column="id_examtype"/>
        <result property="idExamsuite" column="id_examsuite"/>
        <result property="examsuiteName" column="examsuite_name"/>
        <result property="examsuiteAlias" column="examsuite_alias"/>
        <result property="idDoctorapply" column="id_doctorapply"/>
        <result property="doctorapply" column="doctorapply"/>
        <result property="fGuidanceprinted" column="f_guidanceprinted"/>
        <result property="fExamstarted" column="f_examstarted"/>
        <result property="fReadytofinal" column="f_readytofinal"/>
        <result property="fPaused" column="f_paused"/>
        <result property="fFinallocked" column="f_finallocked"/>
        <result property="fFinalexamed" column="f_finalexamed"/>
        <result property="idDoctorfinal" column="id_doctorfinal"/>
        <result property="doctorfinalNameR" column="doctorfinal_name_r"/>
        <result property="datefinalexamed" column="datefinalexamed"/>
        <result property="fClosed" column="f_closed"/>
        <result property="dateclosed" column="dateclosed"/>
        <result property="note" column="note"/>
        <result property="knowledge" column="knowledge"/>
        <result property="timingstartedat" column="timingstartedat"/>
        <result property="hospitalcode" column="hospitalcode"/>
        <result property="idExamplace" column="id_examplace"/>
        <result property="parsedassignedsuiteandfi" column="parsedassignedsuiteandfi"/>
        <result property="parsedassignedgroupandfi" column="parsedassignedgroupandfi"/>
        <result property="parsedsuiteandfi" column="parsedsuiteandfi"/>
        <result property="parsedsuiteandfilab" column="parsedsuiteandfilab"/>
        <result property="idGuidenurse" column="id_guidenurse"/>
        <result property="patientnameencoded" column="patientnameencoded"/>
        <result property="patientcodehiden" column="patientcodehiden"/>
        <result property="fWordprinted" column="f_wordprinted"/>
        <result property="guidancenote2" column="guidancenote2"/>
        <result property="fUsecodehiden" column="f_usecodehiden"/>
        <result property="idPatientclass3" column="id_patientclass3"/>
        <result property="dateregisternotime" column="dateregisternotime"/>
        <result property="counterreportprinted" column="counterreportprinted"/>
        <result property="fIsrecheck" column="f_isrecheck"/>
        <result property="fSettlenone" column="f_settlenone"/>
        <result property="dateguidancereturned" column="dateguidancereturned"/>
        <result property="fOutpatient" column="f_outpatient"/>
        <result property="patientnamereceipt" column="patientnamereceipt"/>
        <result property="patientnamepinyin" column="patientnamepinyin"/>
        <result property="statusofhm" column="statusofhm"/>
        <result property="instancetag" column="instancetag"/>
        <result property="inpatientno" column="inpatientno"/>
        <result property="insuranceno" column="insuranceno"/>
        <result property="countreportxml" column="countreportxml"/>
        <result property="countreportcompare" column="countreportcompare"/>
        <result property="countreportoccupation" column="countreportoccupation"/>
        <result property="countreportoccupationpdf" column="countreportoccupationpdf"/>
        <result property="countreportoccupationxml" column="countreportoccupationxml"/>
        <result property="scbs" column="scbs"/>
        <result property="idTjtc" column="id_tjtc"/>
        <result property="jzdw" column="jzdw"/>
        <result property="jzdwr" column="jzdwr"/>
        <result property="spr" column="spr"/>
        <result property="tjr" column="tjr"/>
        <result property="lqfs" column="lqfs"/>
        <result property="yzbm" column="yzbm"/>
        <result property="yjaddress" column="yjaddress"/>
        <result property="qtxz" column="qtxz"/>
        <result property="isHmdb" column="is_hmdb"/>
        <result property="isHmd" column="is_hmd"/>
        <result property="isjj" column="isjj"/>
        <result property="zgl" column="zgl"/>
        <result property="jhgl" column="jhgl"/>
        <result property="jhys" column="jhys"/>
        <result property="jktjzt" column="jktjzt"/>
        <result property="zytjzt" column="zytjzt"/>
        <result property="tmyd" column="tmyd"/>
        <result property="medicaldate" column="medicaldate"/>
        <result property="trades" column="trades"/>
        <result property="cjjgsfyhf" column="cjjgsfyhf"/>
        <result property="bhgybsfyhf" column="bhgybsfyhf"/>
        <result property="yxjgsfyhf" column="yxjgsfyhf"/>
        <result property="medicaltype" column="medicaltype"/>
        <result property="prepayment" column="prepayment"/>
        <result property="tcprice" column="tcprice"/>
        <result property="createdate" column="createdate"/>
        <result property="modifydate" column="modifydate"/>
        <result property="cultural" column="cultural"/>
        <result property="workno" column="workno"/>
        <result property="workDate" column="work_date"/>
        <result property="harmDate" column="harm_date"/>
        <result property="diseasePrintNum" column="disease_print_num"/>
        <result property="healthPrintNum" column="health_print_num"/>
        <result property="readytofinalDate" column="readytofinal_date"/>
        <result property="guideSignleCount" column="guide_signle_count"/>
        <result property="shortCode" column="short_code"/>
        <result property="isNoticed" column="is_noticed"/>
        <result property="reviewPdf" column="review_pdf"/>
        <result property="contraindicatedPdf" column="contraindicated_pdf"/>
        <result property="diseasePdf" column="disease_pdf"/>
        <result property="tsLimit" column="ts_limit"/>
        <result property="checkoutDate" column="checkout_date"/>
        <result property="checkoutStatus" column="checkout_status"/>
        <result property="worktypeId" column="worktype_id"/>
        <result property="idExamclass" column="id_examclass"/>
        <result property="originalTrade" column="original_trade"/>
        <result property="status" column="status"/>
    </resultMap>

    <!-- 数据表字段属性 -->
    <sql id="selectPeispatientVo">
        select id,
               id_orgpatient,
               id_cis,
               patientarchiveno,
               patientcode,
               patientbizno,
               idcardno,
               numorgresv,
               patientname,
               input_code,
               id_orgreservationgroup,
               id_orgreservation,
               id_org,
               org_name,
               org_depart,
               have_private,
               id_payway,
               payway,
               personpricelimit,
               id_sex,
               birthdate,
               age,
               id_marriage,
               marriage,
               id_nation,
               nation,
               address,
               id_informway,
               id_opendoctor,
               email,
               phone,
               id_patientclass,
               id_resarea,
               resarea,
               f_isforprepare,
               f_isforreserve,
               f_registered,
               dateregister,
               guidancenote,
               moneyamount,
               moneyamountpaid,
               id_doctorreg,
               doctorreg,
               id_examtype,
               id_examsuite,
               examsuite_name,
               examsuite_alias,
               id_doctorapply,
               doctorapply,
               f_guidanceprinted,
               f_examstarted,
               f_readytofinal,
               f_paused,
               f_finallocked,
               f_finalexamed,
               id_doctorfinal,
               doctorfinal_name_r,
               datefinalexamed,
               f_closed,
               dateclosed,
               note,
               knowledge,
               timingstartedat,
               hospitalcode,
               id_examplace,
               parsedassignedsuiteandfi,
               parsedassignedgroupandfi,
               parsedsuiteandfi,
               parsedsuiteandfilab,
               id_guidenurse,
               patientnameencoded,
               patientcodehiden,
               f_wordprinted,
               guidancenote2,
               f_usecodehiden,
               id_patientclass3,
               dateregisternotime,
               counterreportprinted,
               f_isrecheck,
               f_settlenone,
               dateguidancereturned,
               f_outpatient,
               patientnamereceipt,
               patientnamepinyin,
               statusofhm,
               instancetag,
               inpatientno,
               insuranceno,
               countreportxml,
               countreportcompare,
               countreportoccupation,
               countreportoccupationpdf,
               countreportoccupationxml,
               scbs,
               id_tjtc,
               jzdw,
               jzdwr,
               spr,
               tjr,
               lqfs,
               yzbm,
               yjaddress,
               qtxz,
               is_hmdb,
               is_hmd,
               isjj,
               zgl,
               jhgl,
               jhys,
               jktjzt,
               zytjzt,
               tmyd,
               medicaldate,
               trades,
               cjjgsfyhf,
               bhgybsfyhf,
               yxjgsfyhf,
               medicaltype,
               prepayment,
               tcprice,
               createdate,
               modifydate,
               cultural,
               work_date,
               harm_date,
               disease_print_num,
               health_print_num,
               readytofinal_date,
               guide_signle_count,
               short_code,
               is_noticed,
               review_pdf,
               contraindicated_pdf,
               disease_pdf,
               ts_limit,
               checkout_date,
               checkout_status,
               worktype_id,
               id_examclass,
               original_trade,
               `status`
        from md_peispatient
    </sql>

    <!-- 查询健康报告列表数据 -->
    <select id="getHealthReportData" resultType="com.center.medical.report.bean.vo.PeispatientVo">
        SELECT
        p.patientcode,
        p.patientname,
        p.id_sex,
        p.age,
        r.create_num AS createReportNum,
        p.org_name,
        p.health_print_num,
        r.generate_name,
        r.generate_date,
        r.generate_hint,
        '' f_reportprinted,
        r.is_total,
        p.doctorapply AS kdys,
        p.jktjzt AS bgzt,
        p.dateregister,
        p.numorgresv,
        r.id,
        r.print_num,
        m.method_name AS informway,
        ys.create_status AS orgDepartsubb,
        CASE
        WHEN EXISTS (
        SELECT
        1
        FROM
        md_peispatientfeeitem pi
        INNER JOIN md_items i ON i.id = pi.id_examfeeitem
        WHERE
        pi.id_patient = p.patientcode
        AND i.bgdybs = '1'
        AND ( pi.change_item IS NULL OR pi.change_item = 0 )
        AND ( pi.f_giveup IS NULL OR pi.f_giveup = 0 )
        AND ( pi.sfjj IS NULL OR pi.sfjj = 0 )
        AND pi.f_feecharged = 1
        AND pi.f_examinated = 1
        ) THEN
        '是' ELSE '否'
        END AS containsPrivate,
        p.id_examtype,
        p.zytjzt,
        (CASE WHEN ls.id is not null THEN 1 ELSE 0 END) as lsbg,
        p.id as pId,
        r.url_pdf as urlPdf,
        ls.pdf_url as lsPdf,
        ys.pdf_url as ysPdf,
        p.idcardno
        FROM
        md_peispatient p
        LEFT JOIN md_other_report ys ON ys.patientcode = p.patientcode
        AND ys.report_type = 2
        LEFT JOIN md_report r ON p.patientcode = r.patientcode
        AND r.disease_health = 0
        LEFT JOIN md_notificationmethod m ON m.id = r.grant_id
        LEFT JOIN md_other_report ls ON ls.patientcode = p.patientcode
        AND ls.report_type = 3
        left join md_createorder co ON p.numorgresv = co.ddh
        <where>
            p.id_examtype in ('0','2')
            AND f_registered = 1
            <if test="param.showNotToatal!=null">
                <choose>
                    <when test="param.showNotToatal == 0">
                        AND p.jktjzt >= 1
                    </when>
                    <otherwise>
                        AND (p.jktjzt >= 1 or p.f_readytofinal = 1)
                    </otherwise>
                </choose>
            </if>
            <if test="param.containsPrivate!=null and param.containsPrivate == 1">
                AND EXISTS (
                SELECT
                1
                FROM
                md_peispatientfeeitem pi
                INNER JOIN md_items i ON i.id = pi.id_examfeeitem
                WHERE
                pi.id_patient = p.patientcode
                AND i.bgdybs = '1'
                AND ( pi.change_item IS NULL OR pi.change_item = 0 )
                AND ( pi.f_giveup IS NULL OR pi.f_giveup = 0 )
                AND ( pi.sfjj IS NULL OR pi.sfjj = 0 )
                AND pi.f_feecharged = 1
                AND pi.f_examinated = 1
                )
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND p.patientcode = #{param.patientcode}
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND (
                p.patientname LIKE concat('%',#{param.patientname},'%')
                OR p.input_code LIKE concat('%',#{param.patientname},'%')
                )
            </if>
            <if test="param.idOpendoctor!=null and param.idOpendoctor!=''">
                AND p.doctorapply LIKE concat('%',#{param.idOpendoctor},'%')
            </if>
            <if test="param.khdwmcid!=null ">
                AND p.id_org = #{param.khdwmcid}
            </if>
            <if test="param.numorgresv!=null ">
                AND p.numorgresv = #{param.numorgresv}
            </if>
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ < ]]> #{param.endTime}
            </if>
            <if test="param.isPrint!=null and param.isPrint == 1">
                AND r.is_total = 1
            </if>
            <if test="param.isNotPrint!=null and param.isNotPrint == 1">
                AND (r.is_total IS NULL OR r.is_total=0)
            </if>
            <if test="param.xsjlid!=null and param.xsjlid!=''">
                AND (p.id_opendoctor = #{param.xsjlid}
                or co.kdzl_name like concat('%', #{param.userName},'%'))
            </if>
            <if test="param.branchIds!=null">
                AND p.hospitalcode IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
            <if test="param.lowerLevelIds!=null">
                AND p.id_opendoctor IN
                <foreach collection="param.lowerLevelIds" item="lowerLevelId" open="(" close=")" separator=",">
                    #{lowerLevelId}
                </foreach>
            </if>
        </where>
        ORDER BY
        ( CASE WHEN r.create_num IS NULL THEN 0 WHEN r.create_num = 0 THEN 1 ELSE 2 END ) ASC,
        r.generate_date DESC,
        r.id
    </select>

    <select id="getDiseaseReportData" resultType="com.center.medical.report.bean.vo.PeispatientVo">
        SELECT
        p.patientcode,
        p.patientname,
        ( CASE WHEN p.id_sex = '0' THEN '男' ELSE '女' END ) id_sex,
        p.age,
        r.create_num AS createReportNum,
        p.org_name,
        p.disease_print_num,
        r.generate_name,
        r.generate_date,
        r.is_total,
        r.generate_hint,
        p.doctorapply as kdys,
        p.zytjzt as bgzt,
        p.dateregister,
        p.numorgresv,
        linshi.create_status,
        p.id_examtype,
        p.jktjzt,
        r.print_num,
        r.url_pdf,
        ( CASE WHEN ma.id is not null THEN 1 ELSE 0 END ) as reportCoding,
        p.idcardno
        FROM
        md_peispatient p
        LEFT JOIN md_other_report linshi ON linshi.patientcode = p.patientcode
        AND linshi.report_type = 3
        LEFT JOIN md_report r ON p.patientcode = r.patientcode
        AND r.disease_health = 1
        LEFT JOIN md_attachment ma ON ma.patientcode = p.patientcode
        AND ma.file_type = '赋码'
        LEFT JOIN md_createorder co ON p.numorgresv = co.ddh
        <where>
            ( p.id_examtype = '1' OR p.id_examtype = '2' OR p.id_examtype = '3' )
            AND p.zytjzt >= 1
            <if test="param.patientcode!=null ">
                AND p.patientcode = #{param.patientcode}
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND (
                p.patientname LIKE concat('%',#{param.patientname},'%')
                OR p.input_code LIKE concat('%',#{param.patientname},'%')
                )
            </if>
            <if test="param.idOpendoctor!=null and param.idOpendoctor!=''">
                AND p.doctorapply LIKE concat('%',#{param.idOpendoctor},'%')
            </if>
            <if test="param.khdwmcid!=null ">
                AND p.id_org = #{param.khdwmcid}
            </if>
            <if test="param.numorgresv!=null ">
                AND p.numorgresv = #{param.numorgresv}
            </if>
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ < ]]> #{param.endTime}
            </if>
            <if test="param.isPrint!=null and param.isNotPrint==null">
                AND r.is_total = 1
            </if>
            <if test="param.isPrint==null and param.isNotPrint!=null">
                AND (r.is_total IS NULL OR r.is_total=0)
            </if>
            <if test="param.xsjlid!=null and param.xsjlid!=''">
                AND (p.id_opendoctor = #{param.xsjlid}
                or co.kdzl_name like concat('%', #{param.userName},'%'))
            </if>
            <if test="param.branchIds!=null">
                AND p.hospitalcode IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
            <if test="param.lowerLevelIds!=null">
                AND p.id_opendoctor IN
                <foreach collection="param.lowerLevelIds" item="lowerLevelId" open="(" close=")" separator=",">
                    #{lowerLevelId}
                </foreach>
            </if>
        </where>

        ORDER BY
        ( CASE WHEN r.create_num IS NULL THEN 0 WHEN r.create_num = 0 THEN 1 ELSE 2 END ) ASC,
        r.generate_date DESC,
        r.id

    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultMap="PeispatientMap">
        <include refid="selectPeispatientVo"/>
        <where>
            id = #{id}
        </where>
    </select>

    <select id="getBypatientCode" resultMap="PeispatientMap">
        <include refid="selectPeispatientVo"/>
        <where>
            patientcode = #{patientcode}
        </where>
    </select>

    <select id="getList" resultMap="PeispatientMap">
        <include refid="selectPeispatientVo"/>
        <where>
            <if test="param.orgDepart != null and param.orgDepart != ''">
                AND org_depart = #{param.orgDepart}
            </if>
            <if test="param.idExamtype!=null and param.idExamtype!=''">
                <choose>
                    <when test="param.idExamtype == 0">
                        AND id_examtype IN ('0','2')
                    </when>
                    <otherwise>
                        AND id_examtype IN ('1','2','3')
                    </otherwise>
                </choose>
            </if>
            <if test="param.numorgresv != null and param.numorgresv != ''">
                AND numorgresv = #{param.numorgresv}
            </if>
            <if test="param.idOrg != null and param.idOrg != ''">
                AND id_org = #{param.idOrg}
            </if>
            <if test="param.fRegistered != null">
                AND f_registered = #{param.fRegistered}
            </if>
            <if test="param.beginTime!=null">
                AND dateregister <![CDATA[ >= ]]> #{param.beginTime}
            </if>
            <if test="param.endTime!=null">
                AND dateregister <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.patientcode != null  and param.patientcode != ''">
                AND patientcode LIKE concat('%',#{param.patientcode},'%')
            </if>
            <if test="param.inputCode != null and param.inputCode != ''">
                AND input_code LIKE concat('%',#{param.inputCode},'%')
            </if>
            <if test="param.idSex != null">
                AND id_sex = #{param.idSex}
            </if>
            <if test="param.dateregister != null">
                AND dateregister  <![CDATA[ < ]]> #{param.dateregister}
            </if>
            <if test="param.branchIds!=null">
                AND hospitalcode IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
        </where>
    </select>

    <select id="getListByinPatientno" resultMap="PeispatientMap">
        <include refid="selectPeispatientVo"/>
        <where>
            inpatientno = #{patientCode}
            order by createDate
        </where>
    </select>


    <!--查询有无隐私项目-->
    <select id="containsPrivate" resultType="java.lang.Integer">
        SELECT count(*)
        FROM md_peispatient p
        WHERE EXISTS(SELECT 1
                     FROM md_peispatientfeeitem pi
                              INNER JOIN md_items i ON i.id = pi.id_examfeeitem
                     WHERE pi.id_patient = p.patientcode
                       AND i.bgdybs = '1'
                       AND i.dyddybs = 1
                       AND (pi.change_item IS NULL OR pi.change_item = 0)
                       AND (pi.f_giveup IS NULL OR pi.f_giveup = 0)
                       AND (pi.sfjj IS NULL OR pi.sfjj = 0)
                       AND pi.f_feecharged = 1
                       AND pi.f_examinated = 1
                       AND EXISTS(SELECT 1
                                  FROM md_peispatientexamitem pei
                                  WHERE pei.patientcode = pi.id_patient
                                    AND pei.id_examfeeitem = i.id))
          AND p.patientcode = #{patientcode}
    </select>




    <!-- 查询健康报告列表数据 -->
    <select id="getHealthReportDataNew" resultType="com.center.medical.report.bean.vo.PeispatientVo">
        SELECT
        p.patientcode,
        p.patientname,
        p.id_sex,
        p.age,
        r.create_num AS createReportNum,
        p.org_name,
        p.health_print_num,
        r.generate_name,
        r.generate_date,
        r.generate_hint,
        '' f_reportprinted,
        r.is_total,
        p.doctorapply AS kdys,
        p.jktjzt AS bgzt,
        p.dateregister,
        p.numorgresv,
        r.id,
        r.print_num,
        m.method_name AS informway,
        ys.create_status AS orgDepartsubb,
        CASE
        WHEN EXISTS (
        SELECT
        1
        FROM
        md_peispatientfeeitem pi
        INNER JOIN md_items i ON i.id = pi.id_examfeeitem
        WHERE
        pi.id_patient = p.patientcode
        AND i.bgdybs = '1'
        AND ( pi.change_item IS NULL OR pi.change_item = 0 )
        AND ( pi.f_giveup IS NULL OR pi.f_giveup = 0 )
        AND ( pi.sfjj IS NULL OR pi.sfjj = 0 )
        AND pi.f_feecharged = 1
        AND pi.f_examinated = 1
        ) THEN
        '是' ELSE '否'
        END AS containsPrivate,
        p.id_examtype,
        p.zytjzt,
        (CASE WHEN ls.id is not null THEN 1 ELSE 0 END) as lsbg,
        p.id as pId,
        r.url_pdf as urlPdf,
        ls.pdf_url as lsPdf,
        p.idcardno
        FROM
        md_peispatient p
        LEFT JOIN md_other_report ys ON ys.patientcode = p.patientcode
        AND ys.report_type = 2
        LEFT JOIN md_report r ON p.patientcode = r.patientcode
        AND r.disease_health = 0
        LEFT JOIN md_notificationmethod m ON m.id = r.grant_id
        LEFT JOIN md_other_report ls ON ls.patientcode = p.patientcode
        AND ls.report_type = 3
        left join md_createorder co ON p.numorgresv = co.ddh
        <where>
            p.id_examtype in ('0','2')
            AND f_registered = 1
            <if test="param.showNotToatal!=null">
                <choose>
                    <when test="param.showNotToatal == 0">
                        AND p.jktjzt >= 1
                    </when>
                    <otherwise>
                        AND (p.jktjzt >= 1 or p.f_readytofinal = 1)
                    </otherwise>
                </choose>
            </if>
            <if test="param.containsPrivate!=null and param.containsPrivate == 1">
                AND EXISTS (
                SELECT
                1
                FROM
                md_peispatientfeeitem pi
                INNER JOIN md_items i ON i.id = pi.id_examfeeitem
                WHERE
                pi.id_patient = p.patientcode
                AND i.bgdybs = '1'
                AND ( pi.change_item IS NULL OR pi.change_item = 0 )
                AND ( pi.f_giveup IS NULL OR pi.f_giveup = 0 )
                AND ( pi.sfjj IS NULL OR pi.sfjj = 0 )
                AND pi.f_feecharged = 1
                AND pi.f_examinated = 1
                )
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND p.patientcode = #{param.patientcode}
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND (
                p.patientname LIKE concat('%',#{param.patientname},'%')
                OR p.input_code LIKE concat('%',#{param.patientname},'%')
                )
            </if>
            <if test="param.idOpendoctor!=null and param.idOpendoctor!=''">
                AND p.doctorapply LIKE concat('%',#{param.idOpendoctor},'%')
            </if>
            <if test="param.khdwmcid!=null ">
                AND p.id_org = #{param.khdwmcid}
            </if>
            <if test="param.numorgresv!=null ">
                AND p.numorgresv = #{param.numorgresv}
            </if>
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ < ]]> #{param.endTime}
            </if>
            <if test="param.isPrint!=null and param.isPrint == 1">
                AND r.is_total = 1
            </if>
            <if test="param.isNotPrint!=null and param.isNotPrint == 1">
                AND (r.is_total IS NULL OR r.is_total=0)
            </if>
            <if test="param.xsjlid!=null and param.xsjlid!=''">
                AND (p.id_opendoctor = #{param.xsjlid}
                or co.kdzl_name like concat('%', #{param.userName},'%'))
            </if>
            <if test="param.branchIds!=null">
                AND p.hospitalcode IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
            <if test="param.lowerLevelIds!=null">
                AND co.xsjlid IN
                <foreach collection="param.lowerLevelIds" item="lowerLevelId" open="(" close=")" separator=",">
                    #{lowerLevelId}
                </foreach>
            </if>
        </where>
        ORDER BY
        ( CASE WHEN r.create_num IS NULL THEN 0 WHEN r.create_num = 0 THEN 1 ELSE 2 END ) ASC,
        r.generate_date DESC,
        r.id
    </select>


    <!-- 获取老系统报告数据 -->
    <select id="getHealthReportDataOld" resultType="com.center.medical.report.bean.vo.PeispatientVo">
        SELECT
        p.patientcode,
        p.patientname,
        p.id_sex,
        p.age,
        r.create_num AS createReportNum,
        p.org_name,
        p.health_print_num,
        r.generate_name,
        r.generate_date,
        r.generate_hint,
        '' f_reportprinted,
        r.is_total,
        p.doctorapply AS kdys,
        p.jktjzt AS bgzt,
        p.dateregister,
        p.numorgresv,
        r.id,
        r.print_num,
        m.method_name AS informway,
        ys.create_status AS orgDepartsubb,
        CASE
        WHEN EXISTS (
        SELECT
        1
        FROM
        peispatientfeeitem pi
        INNER JOIN items i ON i.id = pi.id_examfeeitem
        WHERE
        pi.id_patient = p.patientcode
        AND i.bgdybs = '1'
        AND ( pi.change_item IS NULL OR pi.change_item = 0 )
        AND ( pi.f_giveup IS NULL OR pi.f_giveup = 0 )
        AND ( pi.sfjj IS NULL OR pi.sfjj = 0 )
        AND pi.f_feecharged = 1
        AND pi.f_examinated = 1
        ) THEN
        '是' ELSE '否'
        END AS containsPrivate,
        p.id_examtype,
        p.zytjzt,
        (CASE WHEN ls.id is not null THEN 1 ELSE 0 END) as lsbg,
        p.id as pId,
        r.url_pdf as urlPdf,
        ls.pdf_url as lsPdf,
        p.idcardno
        FROM
        peispatient p
        LEFT JOIN other_report ys ON ys.patientcode = p.patientcode
        AND ys.report_type = 2
        LEFT JOIN report r ON p.patientcode = r.patientcode
        AND r.disease_health = 0
        LEFT JOIN notificationmethod m ON m.id = r.grant_id
        LEFT JOIN other_report ls ON ls.patientcode = p.patientcode
        AND ls.report_type = 3
        left join createorder co ON p.numorgresv = co.ddh
        <where>
            p.id_examtype in ('0','2')
            AND f_registered = 1
            <if test="param.showNotToatal!=null">
                <choose>
                    <when test="param.showNotToatal == 0">
                        AND p.jktjzt >= 1
                    </when>
                    <otherwise>
                        AND (p.jktjzt >= 1 or p.f_readytofinal = 1)
                    </otherwise>
                </choose>
            </if>
            <if test="param.containsPrivate!=null and param.containsPrivate == 1">
                AND EXISTS (
                SELECT
                1
                FROM
                peispatientfeeitem pi
                INNER JOIN items i ON i.id = pi.id_examfeeitem
                WHERE
                pi.id_patient = p.patientcode
                AND i.bgdybs = '1'
                AND ( pi.change_item IS NULL OR pi.change_item = 0 )
                AND ( pi.f_giveup IS NULL OR pi.f_giveup = 0 )
                AND ( pi.sfjj IS NULL OR pi.sfjj = 0 )
                AND pi.f_feecharged = 1
                AND pi.f_examinated = 1
                )
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND p.patientcode = #{param.patientcode}
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND p.patientname = #{param.patientname}
            </if>
            <if test="param.idOpendoctor!=null and param.idOpendoctor!=''">
                AND p.doctorapply = #{param.idOpendoctor}
            </if>
            <if test="param.khdwmcid!=null ">
                AND p.id_org = #{param.khdwmcid}
            </if>
            <if test="param.numorgresv!=null ">
                AND p.numorgresv = #{param.numorgresv}
            </if>
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ < ]]> #{param.endTime}
            </if>
            <if test="param.isPrint!=null and param.isPrint == 1">
                AND r.is_total = 1
            </if>
            <if test="param.isNotPrint!=null and param.isNotPrint == 1">
                AND (r.is_total IS NULL OR r.is_total=0)
            </if>
            <if test="param.xsjlid!=null and param.xsjlid!=''">
                AND (p.id_opendoctor = #{param.xsjlid}
                or co.kdzl_name like concat('%', #{param.userName},'%'))
            </if>
            <if test="param.branchIds!=null">
                AND p.hospitalcode IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
            <if test="param.lowerLevelIds!=null">
                AND co.xsjlid IN
                <foreach collection="param.lowerLevelIds" item="lowerLevelId" open="(" close=")" separator=",">
                    #{lowerLevelId}
                </foreach>
            </if>
        </where>
        ORDER BY
        ( CASE WHEN r.create_num IS NULL THEN 0 WHEN r.create_num = 0 THEN 1 ELSE 2 END ) ASC,
        r.generate_date DESC,
        r.id
    </select>



    <!-- 获取新系统职业报告数据 -->
    <select id="getDiseaseReportDataNew" resultType="com.center.medical.report.bean.vo.PeispatientVo">
        SELECT
        p.patientcode,
        p.patientname,
        ( CASE WHEN p.id_sex = '0' THEN '男' ELSE '女' END ) id_sex,
        p.age,
        r.create_num AS createReportNum,
        p.org_name,
        p.disease_print_num,
        r.generate_name,
        r.generate_date,
        r.is_total,
        r.generate_hint,
        p.doctorapply as kdys,
        p.zytjzt as bgzt,
        p.dateregister,
        p.numorgresv,
        linshi.create_status,
        p.id_examtype,
        p.jktjzt,
        r.print_num,
        r.url_pdf,
        ( CASE WHEN ma.id is not null THEN 1 ELSE 0 END ) as reportCoding,
        p.idcardno
        FROM
        md_peispatient p
        LEFT JOIN md_other_report linshi ON linshi.patientcode = p.patientcode
        AND linshi.report_type = 3
        LEFT JOIN md_report r ON p.patientcode = r.patientcode
        AND r.disease_health = 1
        LEFT JOIN md_attachment ma ON ma.patientcode = p.patientcode
        AND ma.file_type = '赋码'
        LEFT JOIN md_createorder co ON p.numorgresv = co.ddh
        <where>
            ( p.id_examtype = '1' OR p.id_examtype = '2' OR p.id_examtype = '3' )
            AND p.zytjzt >= 1
            <if test="param.patientcode!=null ">
                AND p.patientcode = #{param.patientcode}
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND (
                p.patientname LIKE concat('%',#{param.patientname},'%')
                OR p.input_code LIKE concat('%',#{param.patientname},'%')
                )
            </if>
            <if test="param.idOpendoctor!=null and param.idOpendoctor!=''">
                AND p.doctorapply LIKE concat('%',#{param.idOpendoctor},'%')
            </if>
            <if test="param.khdwmcid!=null ">
                AND p.id_org = #{param.khdwmcid}
            </if>
            <if test="param.numorgresv!=null ">
                AND p.numorgresv = #{param.numorgresv}
            </if>
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ < ]]> #{param.endTime}
            </if>
            <if test="param.isPrint!=null and param.isNotPrint==null">
                AND r.is_total = 1
            </if>
            <if test="param.isPrint==null and param.isNotPrint!=null">
                AND (r.is_total IS NULL OR r.is_total=0)
            </if>
            <if test="param.xsjlid!=null and param.xsjlid!=''">
                AND (p.id_opendoctor = #{param.xsjlid}
                or co.kdzl_name like concat('%', #{param.userName},'%'))
            </if>
            <if test="param.branchIds!=null">
                AND p.hospitalcode IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
            <if test="param.lowerLevelIds!=null">
                AND co.xsjlid IN
                <foreach collection="param.lowerLevelIds" item="lowerLevelId" open="(" close=")" separator=",">
                    #{lowerLevelId}
                </foreach>
            </if>
        </where>

        ORDER BY
        ( CASE WHEN r.create_num IS NULL THEN 0 WHEN r.create_num = 0 THEN 1 ELSE 2 END ) ASC,
        r.generate_date DESC,
        r.id

    </select>




    <!-- 获取老系统职业报告数据 -->
    <select id="getDiseaseReportDataOld" resultType="com.center.medical.report.bean.vo.PeispatientVo">
        SELECT
        p.patientcode,
        p.patientname,
        ( CASE WHEN p.id_sex = '0' THEN '男' ELSE '女' END ) id_sex,
        p.age,
        r.create_num AS createReportNum,
        p.org_name,
        p.disease_print_num,
        r.generate_name,
        r.generate_date,
        r.is_total,
        r.generate_hint,
        p.doctorapply as kdys,
        p.zytjzt as bgzt,
        p.dateregister,
        p.numorgresv,
        linshi.create_status,
        p.id_examtype,
        p.jktjzt,
        r.print_num,
        r.url_pdf,
        ( CASE WHEN ma.id is not null THEN 1 ELSE 0 END ) as reportCoding,
        p.idcardno
        FROM
        peispatient p
        LEFT JOIN other_report linshi ON linshi.patientcode = p.patientcode
        AND linshi.report_type = 3
        LEFT JOIN report r ON p.patientcode = r.patientcode
        AND r.disease_health = 1
        LEFT JOIN attachment ma ON ma.patientcode = p.patientcode
        AND ma.file_type = '赋码'
        LEFT JOIN createorder co ON p.numorgresv = co.ddh
        <where>
            ( p.id_examtype = '1' OR p.id_examtype = '2' OR p.id_examtype = '3' )
            AND p.zytjzt >= 1
            <if test="param.patientcode!=null ">
                AND p.patientcode = #{param.patientcode}
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND p.patientname = #{param.patientname}
            </if>
            <if test="param.idOpendoctor!=null and param.idOpendoctor!=''">
                AND p.doctorapply = #{param.idOpendoctor}
            </if>
            <if test="param.khdwmcid!=null ">
                AND p.id_org = #{param.khdwmcid}
            </if>
            <if test="param.numorgresv!=null ">
                AND p.numorgresv = #{param.numorgresv}
            </if>
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ < ]]> #{param.endTime}
            </if>
            <if test="param.isPrint!=null and param.isNotPrint==null">
                AND r.is_total = 1
            </if>
            <if test="param.isPrint==null and param.isNotPrint!=null">
                AND (r.is_total IS NULL OR r.is_total=0)
            </if>
            <if test="param.xsjlid!=null and param.xsjlid!=''">
                AND (p.id_opendoctor = #{param.xsjlid}
                or co.kdzl_name like concat('%', #{param.userName},'%'))
            </if>
            <if test="param.branchIds!=null">
                AND p.hospitalcode IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
            <if test="param.lowerLevelIds!=null">
                AND co.xsjlid IN
                <foreach collection="param.lowerLevelIds" item="lowerLevelId" open="(" close=")" separator=",">
                    #{lowerLevelId}
                </foreach>
            </if>
        </where>

        ORDER BY
        ( CASE WHEN r.create_num IS NULL THEN 0 WHEN r.create_num = 0 THEN 1 ELSE 2 END ) ASC,
        r.generate_date DESC,
        r.id

    </select>




    <!--查询是否报告隐私项目（导引单不展示的也查）-->
    <select id="containsAllPrivate" resultType="java.lang.Integer">
        SELECT count(*)
        FROM md_peispatient p
        WHERE EXISTS(SELECT 1
                     FROM md_peispatientfeeitem pi
                              INNER JOIN md_items i ON i.id = pi.id_examfeeitem
                     WHERE pi.id_patient = p.patientcode
                       AND i.bgdybs = '1'
--                        AND i.dyddybs = 1
                       AND (pi.change_item IS NULL OR pi.change_item = 0)
                       AND (pi.f_giveup IS NULL OR pi.f_giveup = 0)
                       AND (pi.sfjj IS NULL OR pi.sfjj = 0)
                       AND pi.f_feecharged = 1
                       AND pi.f_examinated = 1
                       AND EXISTS(SELECT 1
                                  FROM md_peispatientexamitem pei
                                  WHERE pei.patientcode = pi.id_patient
                                    AND pei.id_examfeeitem = i.id))
          AND p.patientcode = #{patientcode}
    </select>
</mapper>

