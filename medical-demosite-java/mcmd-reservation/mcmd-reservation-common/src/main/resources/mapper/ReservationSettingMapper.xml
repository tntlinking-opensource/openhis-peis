<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.reservation.dao.ReservationSettingMapper">

    <resultMap type="com.center.medical.reservation.bean.model.ReservationSetting" id="ReservationSettingMap">
        <id property="id" column="id"/>
        <result property="reservationDate" column="reservation_date"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="maxNum" column="max_num"/>
        <result property="ableNum" column="able_num"/>
        <result property="doneNum" column="done_num"/>
        <result property="levelId" column="level_id"/>
        <result property="remark" column="remark"/>
        <result property="branchId" column="branch_id"/>
        <result property="amOrPm" column="am_or_pm"/>
        <result property="status" column="status"/>
        <result property="createdate" column="createdate"/>
        <result property="creator" column="creator"/>
        <result property="modifydate" column="modifydate"/>
        <result property="modifier" column="modifier"/>
        <result property="branchName" column="branch_name"/>
        <result property="levelName" column="level_name"/>
    </resultMap>

    <!-- 数据表字段属性 -->
    <sql id="selectReservationSettingVo">
        SELECT rs.id,
               rs.reservation_date,
               rs.start_time,
               rs.end_time,
               rs.max_num,
               rs.able_num,
               rs.done_num,
               rs.level_id,
               rs.remark,
               rs.branch_id,
               rs.am_or_pm,
               rs.`status`,
               rs.createdate,
               rs.creator,
               rs.modifydate,
               rs.modifier,
               b.fzx AS branch_name,
               ul.level_name
        FROM md_reservation_setting rs
                 LEFT JOIN md_user_level ul ON rs.level_id = ul.level_id
                 LEFT JOIN sys_branch b ON rs.branch_id = b.branch_id
    </sql>

    <!--更新可预约人数-->
    <update id="updateAbleNum">
        UPDATE md_reservation_setting
        SET able_num = able_num + #{count},
        done_num = done_num - #{count},
        modifydate = NOW()
        <where>
            id = #{id}
            AND (able_num + #{count}) >= 0
        </where>
    </update>

    <!--原子性更新可预约人数，避免锁竞争-->
    <update id="updateAbleNumAtomic">
        UPDATE md_reservation_setting
        SET able_num = able_num + #{count},
        done_num = done_num - #{count},
        modifydate = NOW()
        <where>
            id = #{id}
            <if test="count &lt; 0">
                AND able_num >= #{absCount}
            </if>
        </where>
    </update>

    <!-- 查询列表数据 -->
    <select id="getPage" resultMap="ReservationSettingMap">
        <include refid="selectReservationSettingVo"/>
        <where>
            <if test="param.startTime!=null">
                AND rs.reservation_date <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND rs.reservation_date <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.status!=null">
                AND rs.status = #{param.status}
            </if>
            <if test="param.branchId!=null and param.branchId!=''">
                AND rs.branch_id = #{param.branchId}
            </if>
            <if test="param.levelId!=null">
                AND rs.level_id <![CDATA[ = ]]> #{param.levelId}
            </if>
            <if test="param.startTime!=null">
                AND rs.reservation_date <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND rs.reservation_date <![CDATA[ <= ]]> #{param.endTime}
            </if>
        </where>
        order by reservation_date DESC
    </select>

    <!--获取预约时段列表-->
    <select id="getList" resultType="com.center.medical.reservation.bean.model.ReservationSetting">
        <include refid="selectReservationSettingVo"/>
        <where>
            rs.`status` = 1
            <if test="param.reservationDate!=null">
                AND rs.reservation_date = #{param.reservationDate}
            </if>
            <if test="param.branchId!=null and param.branchId!=''">
                AND rs.branch_id = #{param.branchId}
            </if>
            <if test="param.reservationTime!=null and param.reservationTime!=''">
                AND rs.end_time <![CDATA[ >= ]]> #{param.reservationTime}
            </if>
            <if test="param.levelId!=null">
                AND rs.level_id <![CDATA[ <= ]]> #{param.levelId}
            </if>
        </where>
        order by rs.reservation_date DESC, rs.start_time asc
    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultMap="ReservationSettingMap">
        <include refid="selectReservationSettingVo"/>
        <where>
            rs.id = #{id}
        </where>
    </select>

    <!--获取团体可预约列表-->
    <select id="groupList" resultType="com.center.medical.reservation.bean.dto.ReservationSettingGroupDto">
        SELECT
        rs.reservation_date,
        rs.level_id,
        ul.level_name,
        sb.fzx,
        SUM( CASE WHEN rs.am_or_pm = 0 THEN rs.max_num ELSE 0 END ) AS max_num_am,
        SUM( CASE WHEN rs.am_or_pm = 0 THEN rs.able_num ELSE 0 END ) AS able_num_am,
        SUM( CASE WHEN rs.am_or_pm = 0 THEN rs.done_num ELSE 0 END ) AS done_num_am,
        SUM( CASE WHEN rs.am_or_pm = 1 THEN rs.max_num ELSE 0 END ) AS max_num_pm,
        SUM( CASE WHEN rs.am_or_pm = 1 THEN rs.able_num ELSE 0 END ) AS able_num_pm,
        SUM( CASE WHEN rs.am_or_pm = 1 THEN rs.done_num ELSE 0 END ) AS done_num_pm,
        CASE
        WHEN SUM(rs.able_num) > 0 THEN '可预约'
        ELSE '已约满'
        END AS `status`
        FROM md_reservation_setting rs
        LEFT JOIN md_user_level ul ON rs.level_id = ul.level_id
        LEFT JOIN sys_branch sb ON rs.branch_id = sb.branch_id
        WHERE
        <if test="param.statusList!=null">
            rs.`status` IN
            <foreach collection="param.statusList" item="st" open="(" close=")" separator=",">
                #{st}
            </foreach>
        </if>
        <if test="param.statusList==null">
            rs.`status` IN (1, 2)
        </if>
        <if test="param.branchId!=null and param.branchId!=''">
            AND rs.branch_id = #{param.branchId}
        </if>
        <if test="param.startDate!=null and param.endDate!=null">
            AND rs.reservation_date BETWEEN #{param.startDate} AND #{param.endDate}
        </if>
        <if test="param.levelId!=null and param.levelId!=''">
            AND rs.level_id <![CDATA[ <= ]]> #{param.levelId}
        </if>
        GROUP BY rs.reservation_date,rs.level_id
    </select>

    <!--分页查询预约详情列表-->
    <select id="groupPage" resultType="com.center.medical.reservation.bean.dto.ReservationTotalDto">
        SELECT
        rs.reservation_date,
        CASE
        WHEN WEEKDAY( rs.reservation_date ) = 0 THEN
        '星期一'
        WHEN WEEKDAY( rs.reservation_date ) = 1 THEN
        '星期二'
        WHEN WEEKDAY( rs.reservation_date ) = 2 THEN
        '星期三'
        WHEN WEEKDAY( rs.reservation_date ) = 3 THEN
        '星期四'
        WHEN WEEKDAY( rs.reservation_date ) = 4 THEN
        '星期五'
        WHEN WEEKDAY( rs.reservation_date ) = 5 THEN
        '星期六'
        WHEN WEEKDAY( rs.reservation_date ) = 6 THEN
        '星期日' ELSE '未知'
        END AS week_name,
        ul.level_name,
        sb.fzx,
        SUM( CASE WHEN rs.level_id = 1 AND rs.am_or_pm = 0 THEN rs.max_num ELSE 0 END ) AS count1_max_am,
        SUM( CASE WHEN rs.level_id = 1 AND rs.am_or_pm = 0 THEN rs.done_num ELSE 0 END ) AS count1_am,
        SUM( CASE WHEN rs.level_id = 1 AND rs.am_or_pm = 1 THEN rs.max_num ELSE 0 END ) AS count1_max_pm,
        SUM( CASE WHEN rs.level_id = 1 AND rs.am_or_pm = 1 THEN rs.done_num ELSE 0 END ) AS count1_pm,
        SUM( CASE WHEN rs.level_id = 2 THEN rs.max_num ELSE 0 END ) AS count2_max,
        SUM( CASE WHEN rs.level_id = 2 THEN rs.done_num ELSE 0 END ) AS count2,
        SUM( CASE WHEN rs.level_id = 3 THEN rs.max_num ELSE 0 END ) AS count3_max,
        SUM( CASE WHEN rs.level_id = 3 THEN rs.done_num ELSE 0 END ) AS count3,
        SUM( CASE WHEN rs.level_id NOT IN ( 1, 2, 3 ) THEN rs.max_num ELSE 0 END ) AS count4_max,
        SUM( CASE WHEN rs.level_id NOT IN ( 1, 2, 3 ) THEN rs.done_num ELSE 0 END ) AS count4
        FROM
        md_reservation_setting rs
        LEFT JOIN md_user_level ul ON rs.level_id = ul.level_id
        LEFT JOIN sys_branch sb ON rs.branch_id = sb.branch_id
        WHERE
        <if test="param.statusList!=null">
            rs.`status` IN
            <foreach collection="param.statusList" item="st" open="(" close=")" separator=",">
                #{st}
            </foreach>
        </if>
        <if test="param.statusList==null">
            rs.`status` IN (1, 2)
        </if>
        <if test="param.branchId!=null and param.branchId!=''">
            AND rs.branch_id = #{param.branchId}
        </if>
        <if test="param.startDate!=null">
            AND rs.reservation_date  <![CDATA[ >= ]]> #{param.startDate}
        </if>
        <if test="param.startDate!=null and param.endDate!=null">
            AND rs.reservation_date<![CDATA[ <= ]]> #{param.endDate}
        </if>
        GROUP BY
        rs.branch_id,
        rs.reservation_date
        ORDER BY rs.reservation_date DESC
    </select>

    <!--获取日期预约信息导出数据-->
    <select id="getExportDetailData" resultType="com.center.medical.reservation.bean.dto.ReservationTotalDto">
        SELECT
        rs.reservation_date,
        CASE
        WHEN WEEKDAY( rs.reservation_date ) = 0 THEN
        '星期一'
        WHEN WEEKDAY( rs.reservation_date ) = 1 THEN
        '星期二'
        WHEN WEEKDAY( rs.reservation_date ) = 2 THEN
        '星期三'
        WHEN WEEKDAY( rs.reservation_date ) = 3 THEN
        '星期四'
        WHEN WEEKDAY( rs.reservation_date ) = 4 THEN
        '星期五'
        WHEN WEEKDAY( rs.reservation_date ) = 5 THEN
        '星期六'
        WHEN WEEKDAY( rs.reservation_date ) = 6 THEN
        '星期日' ELSE '未知'
        END AS week_name,
        ul.level_name,
        sb.fzx,
        SUM( CASE WHEN rs.level_id = 1 AND rs.am_or_pm = 0 THEN rs.max_num ELSE 0 END ) AS count1_max_am,
        SUM( CASE WHEN rs.level_id = 1 AND rs.am_or_pm = 0 THEN rs.done_num ELSE 0 END ) AS count1_am,
        SUM( CASE WHEN rs.level_id = 1 AND rs.am_or_pm = 1 THEN rs.max_num ELSE 0 END ) AS count1_max_pm,
        SUM( CASE WHEN rs.level_id = 1 AND rs.am_or_pm = 1 THEN rs.done_num ELSE 0 END ) AS count1_pm,
        SUM( CASE WHEN rs.level_id = 2 THEN rs.max_num ELSE 0 END ) AS count2_max,
        SUM( CASE WHEN rs.level_id = 2 THEN rs.done_num ELSE 0 END ) AS count2,
        SUM( CASE WHEN rs.level_id = 3 THEN rs.max_num ELSE 0 END ) AS count3_max,
        SUM( CASE WHEN rs.level_id = 3 THEN rs.done_num ELSE 0 END ) AS count3,
        SUM( CASE WHEN rs.level_id NOT IN ( 1, 2, 3 ) THEN rs.max_num ELSE 0 END ) AS count4_max,
        SUM( CASE WHEN rs.level_id NOT IN ( 1, 2, 3 ) THEN rs.done_num ELSE 0 END ) AS count4
        FROM
        md_reservation_setting rs
        LEFT JOIN md_user_level ul ON rs.level_id = ul.level_id
        LEFT JOIN sys_branch sb ON rs.branch_id = sb.branch_id
        WHERE
        <if test="param.statusList!=null">
            rs.`status` IN
            <foreach collection="param.statusList" item="st" open="(" close=")" separator=",">
                #{st}
            </foreach>
        </if>
        <if test="param.statusList==null">
            rs.`status` IN (1, 2)
        </if>
        <if test="param.startDate!=null">
            AND rs.reservation_date  <![CDATA[ >= ]]> #{param.startDate}
        </if>
        <if test="param.startDate!=null and param.endDate!=null">
            AND rs.reservation_date<![CDATA[ <= ]]> #{param.endDate}
        </if>
        GROUP BY
        rs.branch_id,
        rs.reservation_date
    </select>



    <!--分页查询预约日期-->
    <select id="queryReservationDate" resultType="com.center.medical.reservation.bean.vo.QueryReservationVo">
        SELECT
               rs.reservation_date,
               b.fzx AS branch_name,
               ul.level_name
        FROM md_reservation_setting rs
                 LEFT JOIN md_user_level ul ON rs.level_id = ul.level_id
                 LEFT JOIN sys_branch b ON rs.branch_id = b.branch_id
        <where>
            <if test="param.startTime!=null">
                AND rs.reservation_date <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND rs.reservation_date <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.status!=null">
                AND rs.status = #{param.status}
            </if>
            <if test="param.branchIds!=null">
                AND rs.branch_id IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
            <if test="param.levelId!=null">
                AND rs.level_id <![CDATA[ = ]]> #{param.levelId}
            </if>
        </where>
        group by rs.reservation_date
        order by reservation_date DESC
    </select>



    <!--分页查询预约日期-->
    <select id="queryReservationTime" resultType="com.center.medical.reservation.bean.vo.QueryReservationTimeVo">
        SELECT
            rs.id,
            rs.reservation_date,
            rs.start_time,
            rs.end_time,
            rs.max_num,
            rs.done_num,
            rs.able_num,
            rs.status,
            rs.remark,
            b.fzx AS branch_name,
            ul.level_name
        FROM md_reservation_setting rs
        LEFT JOIN md_user_level ul ON rs.level_id = ul.level_id
        LEFT JOIN sys_branch b ON rs.branch_id = b.branch_id
        <where>
            <if test="param.startTime!=null">
                AND rs.reservation_date <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND rs.reservation_date <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.status!=null">
                AND rs.status = #{param.status}
            </if>
            <if test="param.branchIds!=null">
                AND rs.branch_id IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
            <if test="param.levelId!=null">
                AND rs.level_id <![CDATA[ = ]]> #{param.levelId}
            </if>
            <if test="param.reservationDate!=null">
                AND STR_TO_DATE(rs.reservation_date,'%Y-%m-%d') = STR_TO_DATE(#{param.reservationDate},'%Y-%m-%d')
            </if>
        </where>
        order by reservation_date desc, start_time asc
    </select>


    <!--获取预约时段列表-->
    <select id="getNewList" resultType="com.center.medical.reservation.bean.model.ReservationSetting">
        <include refid="selectReservationSettingVo"/>
        <where>
            rs.`status` = 1
            <if test="param.reservationDate!=null">
                AND rs.reservation_date = #{param.reservationDate}
            </if>
            <if test="param.branchId!=null and param.branchId!=''">
                AND rs.branch_id = #{param.branchId}
            </if>
            <if test="param.reservationTime!=null and param.reservationTime!=''">
                AND rs.end_time <![CDATA[ >= ]]> #{param.reservationTime}
            </if>
            <if test="param.levelId!=null">
                AND rs.level_id = #{param.levelId}
            </if>
        </where>
        order by rs.reservation_date DESC, rs.start_time asc
    </select>

    <!--获取预约日期列表-->
    <select id="getReservationDateList" resultType="com.center.medical.reservation.bean.vo.ReservationDateVo">
        SELECT
            rs.reservation_date,
            rs.level_id,
            ul.level_name,
            CASE
                WHEN SUM( rs.able_num ) > 0 THEN 1
                ELSE 0 END AS `status`
        FROM
            md_reservation_setting rs
                LEFT JOIN md_user_level ul ON rs.level_id = ul.level_id
        <where>
            <if test="param.statusList!=null">
                rs.`status` IN
                <foreach collection="param.statusList" item="st" open="(" close=")" separator=",">
                    #{st}
                </foreach>
            </if>
            <if test="param.statusList==null">
                rs.`status` IN (1, 2)
            </if>
            <if test="param.branchId!=null and param.branchId!=''">
                AND rs.branch_id = #{param.branchId}
            </if>
            <if test="param.startDate != null">
                AND rs.reservation_date <![CDATA[ >= ]]> #{param.startDate}
            </if>
            <if test="param.endDate != null">
                AND rs.reservation_date <![CDATA[ <= ]]> #{param.endDate}
            </if>
            <if test="param.levelId!=null and param.levelId!=''">
                AND rs.level_id <![CDATA[ <= ]]> #{param.levelId}
            </if>
        </where>
        GROUP BY
            rs.reservation_date,
            rs.level_id
    </select>

    <!--获取预约时间段列表-->
    <select id="getReservationTimeList"
            resultType="com.center.medical.reservation.bean.dto.ReservationTimeDto">
        SELECT
            id,
            reservation_date,
            CONCAT( start_time, '-', end_time ) AS timeStr,
            able_num,
            branch_id
        FROM
            `md_reservation_setting`
        <where>
            `status` = 1
            <if test="param.branchId!=null and param.branchId!=''">
                AND branch_id = #{param.branchId}
            </if>
            <if test="param.reservationDate!=null">
                AND STR_TO_DATE(reservation_date,'%Y-%m-%d') = STR_TO_DATE(#{param.reservationDate},'%Y-%m-%d')
            </if>
        </where>
    </select>
</mapper>

