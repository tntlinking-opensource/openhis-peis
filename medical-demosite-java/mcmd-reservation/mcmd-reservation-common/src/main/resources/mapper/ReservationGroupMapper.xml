<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.reservation.dao.ReservationGroupMapper">

    <resultMap type="com.center.medical.reservation.bean.model.ReservationGroup" id="ReservationGroupMap">
        <id property="id" column="id"/>
        <result property="branchId" column="branch_id"/>
        <result property="levelId" column="level_id"/>
        <result property="levelName" column="level_name"/>
        <result property="reservationDate" column="reservation_date"/>
        <result property="orderNum" column="order_num"/>
        <result property="orderName" column="order_name"/>
        <result property="comboId" column="combo_id"/>
        <result property="tjtcmc" column="tjtcmc"/>
        <result property="xsjlId" column="xsjl_id"/>
        <result property="xsjlName" column="xsjl_name"/>
        <result property="fUsecodehiden" column="f_usecodehiden"/>
        <result property="countAm" column="count_am"/>
        <result property="countPm" column="count_pm"/>
        <result property="finishedAm" column="finished_am"/>
        <result property="finishedPm" column="finished_pm"/>
        <result property="remark" column="remark"/>
        <result property="status" column="status"/>
        <result property="isDelete" column="is_delete"/>
        <result property="creatorId" column="creator_id"/>
        <result property="creator" column="creator"/>
        <result property="createdate" column="createdate"/>
        <result property="modifydate" column="modifydate"/>
        <result property="modifier" column="modifier"/>
    </resultMap>

    <!-- 数据表字段属性 -->
    <sql id="selectReservationGroupVo">
        select id,
               branch_id,
               level_id,
               level_name,
               reservation_date,
               order_num,
               order_name,
               combo_id,
               tjtcmc,
               xsjl_id,
               xsjl_name,
               f_usecodehiden,
               count_am,
               count_pm,
               finished_am,
               finished_pm,
               remark,
               status,
               is_delete,
               creator_id,
               creator,
               createdate,
               modifydate,
               modifier
        from md_reservation_group
    </sql>

    <!-- 查询列表数据 -->
    <select id="getPage" resultType="com.center.medical.reservation.bean.model.ReservationGroup">
        SELECT rg.*,
        cs.khdwmc
        FROM md_reservation_group rg
        LEFT JOIN crm_sellcustomer cs on rg.id_org = cs.id
        <where>
            rg.is_delete = 0
            <if test="param.ddmc!=null and param.ddmc!=''">
                AND rg.order_name LIKE concat('%',#{param.ddmc},'%')
            </if>
            <if test="param.branchId!=null and param.branchId!=''">
                AND rg.branch_id = #{param.branchId}
            </if>
            <if test="param.levelId!=null">
                AND rg.level_id = #{param.levelId}
            </if>
            <if test="param.startDate!=null">
                AND rg.reservation_date <![CDATA[ >= ]]> #{param.startDate}
            </if>
            <if test="param.endDate!=null">
                AND rg.reservation_date <![CDATA[ <= ]]> #{param.endDate}
            </if>
        </where>
    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultMap="ReservationGroupMap">
        <include refid="selectReservationGroupVo"/>
        <where>
            id = #{id}
            AND is_delete=0
        </where>
    </select>

    <!--获取团队预约信息导出数据-->
    <select id="getExportData" resultType="com.center.medical.reservation.bean.dto.ReservationGroupData">
        SELECT rg.level_name,
        rg.order_num,
        rg.order_name,
        rg.xsjl_name,
        rg.creator,
        rg.count_am,
        rg.finished_am,
        rg.count_pm,
        rg.finished_pm,
        rg.reservation_date,
        rg.remark,
        sb.fzx
        FROM md_reservation_group rg
        LEFT JOIN sys_branch sb on rg.branch_id = sb.branch_id
        <where>
            rg.is_delete = 0
            <if test="param.ddmc!=null and param.ddmc!=''">
                AND rg.order_name LIKE concat('%',#{param.ddmc},'%')
            </if>
            <if test="param.branchId!=null and param.branchId!=''">
                AND rg.branch_id = #{param.branchId}
            </if>
            <if test="param.levelId!=null">
                AND rg.level_id = #{param.levelId}
            </if>
            <if test="param.startDate!=null">
                AND rg.reservation_date <![CDATA[ >= ]]> #{param.startDate}
            </if>
            <if test="param.endDate!=null">
                AND rg.reservation_date <![CDATA[ <= ]]> #{param.endDate}
            </if>
        </where>
    </select>



    <!--获取团队预约信息导出数据-->
    <select id="getReservationNum" resultType="java.lang.Integer">
        SELECT
            IFNULL(SUM( count_am + count_pm ),0)
        FROM
            md_reservation_group
        where level_id > 1
          and is_delete = 0
          and STR_TO_DATE(reservation_date,'%Y-%m-%d') = STR_TO_DATE(#{reservationDate},'%Y-%m-%d')
          and id_org = #{idOrg}
          <if test="id!=null and id!=''">
             and id != #{id}
          </if>
    </select>
</mapper>

