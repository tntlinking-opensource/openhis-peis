<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.query.dao.ChargeCollectionMapper">


    <!-- 查询列表数据 -->
    <select id="getList" resultType="com.center.medical.query.bean.vo.CCPageVo">
        SELECT w.payway_name AS payway,
        u.user_name AS feecharger,
        IFNULL(sum(c.moneyamountpaid), 0) AS moneyamountpaid,
        w.seq
        FROM md_peispatientcharge c
        LEFT JOIN sys_user u ON u.user_no = c.id_feecharger
        LEFT JOIN md_dictpayway w ON w.id = c.id_payway
        <where>
            c.f_feecharged = 1
            <if test="param.startTime!=null">
                AND c.feechargetime <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND c.feechargetime <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.idPayway!=null and param.idPayway!=''">
                AND c.id_payway = #{param.idPayway}
            </if>
            <if test="param.idFeecharger!=null and param.idFeecharger!=''">
                AND c.id_feecharger = #{param.idFeecharger}
            </if>
        </where>
        GROUP BY w.payway_name,w.seq,u.user_name
        ORDER BY u.user_name, w.seq
    </select>


    <!-- 导出自费收费汇总 -->
    <select id="getExportData" resultType="com.center.medical.query.bean.vo.CCPageVo">
        SELECT w.payway_name AS payway,
        u.user_name AS feecharger,
        IFNULL(sum(c.moneyamountpaid), 0) AS moneyamountpaid,
        w.seq
        FROM md_peispatientcharge c
        LEFT JOIN sys_user u ON u.user_no = c.id_feecharger
        LEFT JOIN md_dictpayway w ON w.id = c.id_payway
        <where>
            c.f_feecharged = 1
            <if test="param.startTime!=null">
                AND c.feechargetime <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND c.feechargetime <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.idPayway!=null and param.idPayway!=''">
                AND c.id_payway = #{param.idPayway}
            </if>
            <if test="param.idFeecharger!=null and param.idFeecharger!=''">
                AND c.id_feecharger = #{param.idFeecharger}
            </if>
        </where>
        GROUP BY w.payway_name,w.seq,u.user_name
        ORDER BY u.user_name, w.seq
    </select>


    <!-- 查询导出数据-总计 -->
    <select id="getTotalCollectionSql" resultType="map">
        SELECT u.user_name as '收费员',
        <if test="list!=null and list.size > 0">
            <foreach collection="list" item="paywayname" >
                ifnull( sum( CASE WHEN w.payway_name = #{paywayname} THEN c.moneyamountpaid ELSE 0 END ), 0 ) as ${paywayname},
            </foreach>
        </if>
        ifnull ( sum( c.moneyamountpaid ), 0 ) as '总计'
        from
        md_peispatientcharge c
        left join sys_user u on u.user_no = c.id_feecharger
        left join md_dictpayway w on w.id = c.id_payway
        <where>
            c.f_feecharged = 1
            <if test="param.startTime!=null">
                AND c.feechargetime <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND c.feechargetime <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.idPayway!=null and param.idPayway!=''">
                AND c.id_payway = #{param.idPayway}
            </if>
            <if test="param.idFeecharger!=null and param.idFeecharger!=''">
                AND c.id_feecharger = #{param.idFeecharger}
            </if>
        </where>
        GROUP BY u.user_name
        ORDER BY u.user_name
    </select>
</mapper>

