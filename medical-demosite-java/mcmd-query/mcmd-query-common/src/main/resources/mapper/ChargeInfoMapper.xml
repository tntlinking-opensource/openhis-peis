<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.query.dao.ChargeInfoMapper">


    <!-- 查询列表数据 -->
    <select id="getList" resultType="com.center.medical.query.bean.vo.ChargeInfoPageVo">
        SELECT * FROM (
        SELECT * FROM (
        SELECT min(t.patientcode) patientcode,
        min(t.patientname) patientname,
        STR_TO_DATE(min(y.feechargetime), '%Y-%m-%d %T') feechargetime,
        min(d.payway_name) idPayway,
        min(u.user_name) idFeecharger,
        min(y.moneyamountpaid) moneyamountpaid,
        min(p.orgreservationgroupname) idOrgreservationgroup,
        min(t.org_name) orgName,
        (y.cardno) tjk,
        min(IFNULL(c.tjtcmc, cm.tjtcmc)) examsuiteName,
        min(y.note) note,
        min(t.id_examtype) idExamtype,
        min(t.doctorapply) doctorapply,
        min(t.phone) phone,
        min(csu.int_id) intId,
        min(t.timingstartedat) timingstartedat,
        (y.cardno) cardno,
        t.personpricelimit
        FROM md_peispatient t
        INNER JOIN md_peispatientcharge y ON t.patientcode = y.patientcode
        LEFT JOIN md_createcombo c ON t.id_tjtc = c.id
        LEFT JOIN md_createmeal cm ON t.id_tjtc = cm.id
        LEFT JOIN md_dictpayway d ON y.id_payway = d.id
        LEFT JOIN md_peisorgreservationgroup p ON t.id_orgreservationgroup = p.id
        LEFT JOIN crm_sellcustomer csu ON csu.id = t.id_org
        LEFT JOIN sys_user u ON u.user_no = y.id_feecharger
        <where>
            1 = 1
            AND y.id IS NOT NULL
            AND (
            y.is_delete = 0
            <if test="param.idFeecharger!=null and param.idFeecharger!=''">
                AND u.input_code = #{param.idFeecharger}
            </if>
            <if test="param.idPayway!=null and param.idPayway!=''">
                AND y.id_payway = #{param.idPayway}
            </if>
            <choose>
                <when test="param.containTongShou!=null">
                    <choose>
                        <when test="param.containTongShou == 1">
                            OR d.payway_name = '统收')
                        </when>
                        <otherwise>
                            AND d.payway_name <![CDATA[ <> ]]> '统收')
                        </otherwise>
                    </choose>
                </when>
                <otherwise>
                    AND D.PAYWAY_NAME <![CDATA[ <> ]]> '统收')
                </otherwise>
            </choose>
            <if test="param.idExamtype!=null and param.idExamtype!=''">
                AND t.id_examtype = #{param.idExamtype}
            </if>
            <if test="param.orgName!=null and param.orgName!=''">
                AND csu.khdwsrm like concat('%',#{param.orgName},'%')
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND t.patientname like concat('%',#{param.patientname},'%')
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND t.patientcode like concat('%',#{param.patientcode},'%')
            </if>
            <if test="param.idOrgreservationgroup!=null and param.idOrgreservationgroup!=''">
                AND t.id_orgreservationgroup = #{param.idOrgreservationgroup}
            </if>
            <if test="param.startTime!=null">
                AND y.feechargetime <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND y.feechargetime <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.branchIds!=null">
                AND t.hospitalcode IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
            <if test="param.ddh!=null and param.ddh!=''">
                AND t.numorgresv = #{param.ddh}
            </if>
            <if test="param.doctorapply!=null and param.doctorapply!=''">
                AND t.doctorapply = #{param.doctorapply}
            </if>
        </where>
        GROUP BY y.id, y.createdate ,y.cardno
        ORDER BY y.createdate DESC
        ) as aaaa
        ) as bbbb
        ORDER BY idPayway,patientcode,feechargetime
    </select>


    <!-- 导出收费信息查询 -->
    <select id="getExportData" resultType="com.center.medical.query.bean.vo.ChargeInfoPageVo">
        SELECT * FROM (
        SELECT * FROM (
        SELECT min(t.patientcode) patientcode,
        min(t.patientname) patientname,
        STR_TO_DATE(min(y.feechargetime), '%Y-%m-%d %T') feechargetime,
        min(d.payway_name) idPayway,
        min(u.user_name) idFeecharger,
        min(y.moneyamountpaid) moneyamountpaid,
        min(p.orgreservationgroupname) idOrgreservationgroup,
        min(t.org_name) orgName,
        (y.cardno) tjk,
        min(IFNULL(c.tjtcmc, cm.tjtcmc)) examsuiteName,
        min(y.note) note,
        min(t.id_examtype) idExamtype,
        min(t.doctorapply) doctorapply,
        min(t.phone) phone,
        min(csu.int_id) intId,
        min(t.timingstartedat) timingstartedat,
        (y.cardno) cardno,
        t.personpricelimit
        FROM md_peispatient t
        INNER JOIN md_peispatientcharge y ON t.patientcode = y.patientcode
        LEFT JOIN md_createcombo c ON t.id_tjtc = c.id
        LEFT JOIN md_createmeal cm ON t.id_tjtc = cm.id
        LEFT JOIN md_dictpayway d ON y.id_payway = d.id
        LEFT JOIN md_peisorgreservationgroup p ON t.id_orgreservationgroup = p.id
        LEFT JOIN crm_sellcustomer csu ON csu.id = t.id_org
        LEFT JOIN sys_user u ON u.user_no = y.id_feecharger
        <where>
            1 = 1
            AND y.id IS NOT NULL
            AND (
            y.is_delete = 0
            <if test="param.idFeecharger!=null and param.idFeecharger!=''">
                AND u.input_code LIKE concat('%',#{param.idFeecharger},'%')
            </if>
            <if test="param.idPayway!=null and param.idPayway!=''">
                AND y.id_payway = #{param.idPayway}
            </if>
            <choose>
                <when test="param.containTongShou!=null">
                    <choose>
                        <when test="param.containTongShou == 1">
                            OR d.payway_name = '统收')
                        </when>
                        <otherwise>
                            AND d.payway_name <![CDATA[ <> ]]> '统收')
                        </otherwise>
                    </choose>
                </when>
                <otherwise>
                    AND D.PAYWAY_NAME <![CDATA[ <> ]]> '统收')
                </otherwise>
            </choose>
            <if test="param.idExamtype!=null and param.idExamtype!=''">
                AND t.id_examtype = #{param.idExamtype}
            </if>
            <if test="param.orgName!=null and param.orgName!=''">
                AND csu.khdwsrm LIKE concat('%',#{param.orgName},'%')
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND t.input_code LIKE concat('%',#{param.patientname},'%')
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND t.patientcode LIKE concat('%',#{param.patientcode},'%')
            </if>
            <if test="param.idOrgreservationgroup!=null and param.idOrgreservationgroup!=''">
                AND t.id_orgreservationgroup = #{param.idOrgreservationgroup}
            </if>
            <if test="param.startTime!=null">
                AND y.feechargetime <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND y.feechargetime <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.branchIds!=null">
                AND t.hospitalcode IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
            <if test="param.ddh!=null and param.ddh!=''">
                AND t.numorgresv = #{param.ddh}
            </if>
            <if test="param.doctorapply!=null and param.doctorapply!=''">
                AND t.doctorapply = #{param.doctorapply}
            </if>
        </where>
        GROUP BY y.id, y.createdate ,y.cardno
        ORDER BY y.createdate DESC
        ) as aaaa
        ) as bbbb
        ORDER BY idPayway,patientcode,feechargetime
    </select>




    <!-- 查询列表数据 -->
    <select id="financeCountAmount" resultType="com.center.medical.query.bean.vo.FinanceAmountVo">
        SELECT
        sum(CASE WHEN (t.id_org is not null and t.id_org != '') THEN y.moneyamountpaid ELSE 0  END) AS tthj,
        sum(CASE WHEN (t.id_org is not null and t.id_org != '') THEN 0 ELSE y.moneyamountpaid END) AS gjhj,
        sum(y.moneyamountpaid) as total
        FROM md_peispatient t
        INNER JOIN md_peispatientcharge y ON t.patientcode = y.patientcode
        LEFT JOIN md_createcombo c ON t.id_tjtc = c.id
        LEFT JOIN md_createmeal cm ON t.id_tjtc = cm.id
        LEFT JOIN md_dictpayway d ON y.id_payway = d.id
        LEFT JOIN md_peisorgreservationgroup p ON t.id_orgreservationgroup = p.id
        LEFT JOIN crm_sellcustomer csu ON csu.id = t.id_org
        LEFT JOIN sys_user u ON u.user_no = y.id_feecharger
        <where>
            1 = 1
            AND y.id IS NOT NULL
            AND (
            y.is_delete = 0
            <if test="param.idFeecharger!=null and param.idFeecharger!=''">
                AND u.input_code = #{param.idFeecharger}
            </if>
            <if test="param.idPayway!=null and param.idPayway!=''">
                AND y.id_payway = #{param.idPayway}
            </if>
            <choose>
                <when test="param.containTongShou!=null">
                    <choose>
                        <when test="param.containTongShou == 1">
                            OR d.payway_name = '统收')
                        </when>
                        <otherwise>
                            AND d.payway_name <![CDATA[ <> ]]> '统收')
                        </otherwise>
                    </choose>
                </when>
                <otherwise>
                    AND D.PAYWAY_NAME <![CDATA[ <> ]]> '统收')
                </otherwise>
            </choose>
            <if test="param.idExamtype!=null and param.idExamtype!=''">
                AND t.id_examtype = #{param.idExamtype}
            </if>
            <if test="param.orgName!=null and param.orgName!=''">
                AND csu.khdwsrm like concat('%',#{param.orgName},'%')
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND t.patientname like concat('%',#{param.patientname},'%')
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND t.patientcode like concat('%',#{param.patientcode},'%')
            </if>
            <if test="param.idOrgreservationgroup!=null and param.idOrgreservationgroup!=''">
                AND t.id_orgreservationgroup = #{param.idOrgreservationgroup}
            </if>
            <if test="param.startTime!=null">
                AND y.feechargetime <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND y.feechargetime <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.branchIds!=null">
                AND t.hospitalcode IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
            <if test="param.ddh!=null and param.ddh!=''">
                AND t.numorgresv = #{param.ddh}
            </if>
        </where>
    </select>
</mapper>

