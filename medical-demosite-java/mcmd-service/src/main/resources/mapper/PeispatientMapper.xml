<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.dao.PeispatientMapper">

    <resultMap type="com.center.medical.bean.model.Peispatient" id="PeispatientMap">
        <id property="id" column="id"/>
        <result property="idOrgpatient" column="id_orgpatient"/>
        <result property="idCis" column="id_cis"/>
        <result property="patientarchiveno" column="patientarchiveno"/>
        <result property="patientcode" column="patientcode"/>
        <result property="patientbizno" column="patientbizno"/>
        <result property="idcardno" column="idcardno"/>
        <result property="numorgresv" column="numorgresv"/>
        <result property="patientname" column="patientname"/>
        <result property="inputCode" column="input_code"/>
        <result property="idOrgreservationgroup" column="id_orgreservationgroup"/>
        <result property="idOrgreservation" column="id_orgreservation"/>
        <result property="idOrg" column="id_org"/>
        <result property="orgName" column="org_name"/>
        <result property="orgDepart" column="org_depart"/>
        <result property="havePrivate" column="have_private"/>
        <result property="idPayway" column="id_payway"/>
        <result property="payway" column="payway"/>
        <result property="personpricelimit" column="personpricelimit"/>
        <result property="idSex" column="id_sex"/>
        <result property="birthdate" column="birthdate"/>
        <result property="age" column="age"/>
        <result property="idMarriage" column="id_marriage"/>
        <result property="marriage" column="marriage"/>
        <result property="idNation" column="id_nation"/>
        <result property="nation" column="nation"/>
        <result property="address" column="address"/>
        <result property="idInformway" column="id_informway"/>
        <result property="idOpendoctor" column="id_opendoctor"/>
        <result property="email" column="email"/>
        <result property="phone" column="phone"/>
        <result property="idPatientclass" column="id_patientclass"/>
        <result property="idResarea" column="id_resarea"/>
        <result property="resarea" column="resarea"/>
        <result property="fIsforprepare" column="f_isforprepare"/>
        <result property="fIsforreserve" column="f_isforreserve"/>
        <result property="fRegistered" column="f_registered"/>
        <result property="dateregister" column="dateregister"/>
        <result property="moneyamount" column="moneyamount"/>
        <result property="moneyamountpaid" column="moneyamountpaid"/>
        <result property="doctorreg" column="doctorreg"/>
        <result property="idDoctorreg" column="id_doctorreg"/>
        <result property="doctorreg" column="doctorreg"/>
        <result property="idExamtype" column="id_examtype"/>
        <result property="idExamsuite" column="id_examsuite"/>
        <result property="examsuiteName" column="examsuite_name"/>
        <result property="examsuiteAlias" column="examsuite_alias"/>
        <result property="idDoctorapply" column="id_doctorapply"/>
        <result property="doctorapply" column="doctorapply"/>
        <result property="fGuidanceprinted" column="f_guidanceprinted"/>
        <result property="fExamstarted" column="f_examstarted"/>
        <result property="fReadytofinal" column="f_readytofinal"/>
        <result property="fPaused" column="f_paused"/>
        <result property="fFinallocked" column="f_finallocked"/>
        <result property="fFinalexamed" column="f_finalexamed"/>
        <result property="idDoctorfinal" column="id_doctorfinal"/>
        <result property="doctorfinalNameR" column="doctorfinal_name_r"/>
        <result property="datefinalexamed" column="datefinalexamed"/>
        <result property="fClosed" column="f_closed"/>
        <result property="dateclosed" column="dateclosed"/>
        <result property="note" column="note"/>
        <result property="knowledge" column="knowledge"/>
        <result property="timingstartedat" column="timingstartedat"/>
        <result property="hospitalcode" column="hospitalcode"/>
        <result property="idExamplace" column="id_examplace"/>
        <result property="parsedassignedsuiteandfi" column="parsedassignedsuiteandfi"/>
        <result property="parsedassignedgroupandfi" column="parsedassignedgroupandfi"/>
        <result property="parsedsuiteandfi" column="parsedsuiteandfi"/>
        <result property="parsedsuiteandfilab" column="parsedsuiteandfilab"/>
        <result property="idGuidenurse" column="id_guidenurse"/>
        <result property="patientnameencoded" column="patientnameencoded"/>
        <result property="patientcodehiden" column="patientcodehiden"/>
        <result property="fWordprinted" column="f_wordprinted"/>
        <result property="guidancenote2" column="guidancenote2"/>
        <result property="fUsecodehiden" column="f_usecodehiden"/>
        <result property="idPatientclass3" column="id_patientclass3"/>
        <result property="dateregisternotime" column="dateregisternotime"/>
        <result property="counterreportprinted" column="counterreportprinted"/>
        <result property="fIsrecheck" column="f_isrecheck"/>
        <result property="fSettlenone" column="f_settlenone"/>
        <result property="dateguidancereturned" column="dateguidancereturned"/>
        <result property="fOutpatient" column="f_outpatient"/>
        <result property="patientnamereceipt" column="patientnamereceipt"/>
        <result property="patientnamepinyin" column="patientnamepinyin"/>
        <result property="statusofhm" column="statusofhm"/>
        <result property="instancetag" column="instancetag"/>
        <result property="inpatientno" column="inpatientno"/>
        <result property="insuranceno" column="insuranceno"/>
        <result property="countreportxml" column="countreportxml"/>
        <result property="countreportcompare" column="countreportcompare"/>
        <result property="countreportoccupation" column="countreportoccupation"/>
        <result property="countreportoccupationpdf" column="countreportoccupationpdf"/>
        <result property="countreportoccupationxml" column="countreportoccupationxml"/>
        <result property="scbs" column="scbs"/>
        <result property="idTjtc" column="id_tjtc"/>
        <result property="jzdw" column="jzdw"/>
        <result property="jzdwr" column="jzdwr"/>
        <result property="spr" column="spr"/>
        <result property="tjr" column="tjr"/>
        <result property="lqfs" column="lqfs"/>
        <result property="yzbm" column="yzbm"/>
        <result property="yjaddress" column="yjaddress"/>
        <result property="qtxz" column="qtxz"/>
        <result property="isHmdb" column="is_hmdb"/>
        <result property="isHmd" column="is_hmd"/>
        <result property="isjj" column="isjj"/>
        <result property="zgl" column="zgl"/>
        <result property="jhgl" column="jhgl"/>
        <result property="jhys" column="jhys"/>
        <result property="jktjzt" column="jktjzt"/>
        <result property="zytjzt" column="zytjzt"/>
        <result property="tmyd" column="tmyd"/>
        <result property="medicaldate" column="medicaldate"/>
        <result property="trades" column="trades"/>
        <result property="cjjgsfyhf" column="cjjgsfyhf"/>
        <result property="bhgybsfyhf" column="bhgybsfyhf"/>
        <result property="yxjgsfyhf" column="yxjgsfyhf"/>
        <result property="medicaltype" column="medicaltype"/>
        <result property="prepayment" column="prepayment"/>
        <result property="tcprice" column="tcprice"/>
        <result property="createdate" column="createdate"/>
        <result property="modifydate" column="modifydate"/>
        <result property="cultural" column="cultural"/>
        <result property="workno" column="workno"/>
        <result property="workDate" column="work_date"/>
        <result property="harmDate" column="harm_date"/>
        <result property="diseasePrintNum" column="disease_print_num"/>
        <result property="healthPrintNum" column="health_print_num"/>
        <result property="readytofinalDate" column="readytofinal_date"/>
        <result property="guideSignleCount" column="guide_signle_count"/>
        <result property="shortCode" column="short_code"/>
        <result property="isNoticed" column="is_noticed"/>
        <result property="reviewPdf" column="review_pdf"/>
        <result property="contraindicatedPdf" column="contraindicated_pdf"/>
        <result property="diseasePdf" column="disease_pdf"/>
        <result property="tsLimit" column="ts_limit"/>
        <result property="checkoutDate" column="checkout_date"/>
        <result property="checkoutStatus" column="checkout_status"/>
        <result property="worktypeId" column="worktype_id"/>
        <result property="idExamclass" column="id_examclass"/>
        <result property="status" column="status"/>
        <result property="originalTrade" column="original_trade"/>
        <result property="thirdCode" column="third_code"/>
        <result property="sabc" column="sabc"/>
    </resultMap>

    <!-- 数据表字段属性 -->
    <sql id="selectPeispatientVo">
        select id,
               id_orgpatient,
               id_cis,
               patientarchiveno,
               patientcode,
               patientbizno,
               idcardno,
               numorgresv,
               patientname,
               input_code,
               id_orgreservationgroup,
               id_orgreservation,
               id_org,
               org_name,
               org_depart,
               have_private,
               id_payway,
               payway,
               personpricelimit,
               id_sex,
               birthdate,
               age,
               id_marriage,
               marriage,
               id_nation,
               nation,
               address,
               id_informway,
               id_opendoctor,
               email,
               phone,
               id_patientclass,
               id_resarea,
               resarea,
               f_isforprepare,
               f_isforreserve,
               f_registered,
               dateregister,
               guidancenote,
               id_doctorreg,
               doctorreg,
               id_examtype,
               id_examsuite,
               examsuite_name,
               examsuite_alias,
               id_doctorapply,
               doctorapply,
               f_guidanceprinted,
               f_examstarted,
               f_readytofinal,
               f_paused,
               f_finallocked,
               f_finalexamed,
               id_doctorfinal,
               doctorfinal_name_r,
               datefinalexamed,
               f_closed,
               dateclosed,
               note,
               knowledge,
               timingstartedat,
               hospitalcode,
               id_examplace,
               parsedassignedsuiteandfi,
               parsedassignedgroupandfi,
               parsedsuiteandfi,
               parsedsuiteandfilab,
               id_guidenurse,
               patientnameencoded,
               patientcodehiden,
               f_wordprinted,
               guidancenote2,
               f_usecodehiden,
               id_patientclass3,
               dateregisternotime,
               counterreportprinted,
               f_isrecheck,
               f_settlenone,
               dateguidancereturned,
               f_outpatient,
               patientnamereceipt,
               patientnamepinyin,
               statusofhm,
               instancetag,
               inpatientno,
               insuranceno,
               countreportxml,
               countreportcompare,
               countreportoccupation,
               countreportoccupationpdf,
               countreportoccupationxml,
               scbs,
               id_tjtc,
               jzdw,
               jzdwr,
               spr,
               tjr,
               lqfs,
               yzbm,
               yjaddress,
               qtxz,
               is_hmdb,
               is_hmd,
               isjj,
               zgl,
               jhgl,
               jhys,
               jktjzt,
               zytjzt,
               tmyd,
               medicaldate,
               trades,
               cjjgsfyhf,
               bhgybsfyhf,
               yxjgsfyhf,
               medicaltype,
               prepayment,
               tcprice,
               createdate,
               modifydate,
               cultural,
               workno,
               work_date,
               harm_date,
               disease_print_num,
               health_print_num,
               readytofinal_date,
               guide_signle_count,
               short_code,
               is_noticed,
               review_pdf,
               contraindicated_pdf,
               disease_pdf,
               ts_limit,
               checkout_date,
               checkout_status,
               worktype_id,
               id_examclass,
               original_trade,
               `status`,
               moneyamount,
               moneyamountpaid,
               third_code,
               sabc
        from md_peispatient
    </sql>
    <update id="updateDeduplication">
        UPDATE md_peispatient
        SET patientcode      = #{patientcode},
            hospitalcode     = NULL,
            patientarchiveno = NULL
        WHERE id = #{id}
    </update>

    <select id="getPage" resultMap="PeispatientMap">
        <include refid="selectPeispatientVo"/>
    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultMap="PeispatientMap">
        <include refid="selectPeispatientVo"/>
        <where>
            id = #{id}
        </where>
    </select>

    <!-- 通过体检号获取记录 -->
    <select id="getByPatientCode" resultMap="PeispatientMap">
        <include refid="selectPeispatientVo"/>
        <where>
            patientcode = #{patientCode}
        </where>
    </select>


    <!-- 旧案召回 从体检者历史表 插入到体检者表 -->
    <insert id="reSaveHistory">
        INSERT INTO md_peispatient
        SELECT *
        FROM md_peispatienthistory
        WHERE id IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </insert>


    <!-- 旧案召回 从体检者历史表 插入到体检者表 -->
    <select id="searchCode" resultType="com.center.medical.bean.vo.SearchCodeVo">
        select r.id,
        p.patientcode,
        p.patientname,
        p.doctorapply,
        p.org_name,
        p.numorgresv,
        p.dateregister,
        r.status,
        p.phone,
        n.method_name,
        r.grant_id
        from md_peispatient p
        inner join md_report r on p.patientcode = r.patientcode
        inner JOIN md_notificationmethod n ON n.id = r.grant_id
        <where>
            1 = 1
            <if test="param.tjlx!=null ">
                AND r.disease_health = #{param.tjlx}
            </if>
            <if test="param.patientCode!=null and param.patientCode!=''">
                AND p.patientcode = #{param.patientCode}
            </if>
            <if test="param.patientName!=null and param.patientName!=''">
                AND p.patientname = #{param.patientName}
            </if>
            <if test="param.phone!=null and param.phone!=''">
                AND p.phone = #{param.phone}
            </if>
            <if test="param.tjlx!=null and param.tjlx == 0">
                AND p.jktjzt >= 9 AND jktjzt <![CDATA[ <> ]]> 11
            </if>
            <if test="param.tjlx!=null and param.tjlx == 1">
                AND p.zytjzt >= 9 AND zytjzt <![CDATA[ <> ]]> 11
            </if>
        </where>
    </select>
    <!-- 查询体检者-->
    <select id="getPatientByTime" resultType="com.center.medical.bean.dto.PatientDto">
        SELECT
        id,
        patientcode,
        numorgresv,
        patientname,
        idcardno,
        phone
        FROM
        md_peispatient
        <where>
            <if test="param.fRegistered!=null ">
                AND r.disease_health = #{param.fRegistered}
            </if>
            <if test="param.fUsecodehiden!=null ">
                AND f_usecodehiden = #{param.fUsecodehiden}
            </if>

            AND f_registered = 1
            AND dateregister <![CDATA[ >= ]]> '2024-04-01 00:00:00'
            AND dateregister <![CDATA[ <= ]]> '2024-04-23 00:00:00'
        </where>
    </select>

    <select id="geDuplicate" resultType="com.center.medical.bean.dto.PatientDuplicate">
        SELECT patientname,
               idcardno,
               phone,
               numorgresv,
               id_orgreservationgroup
        FROM md_peispatient
        WHERE numorgresv = #{ddh}
          AND f_usecodehiden = 1
          AND (f_paused = 0 OR f_paused IS NULL)
          AND doctorapply != '补检'
        GROUP BY patientname, idcardno, phone, numorgresv, id_orgreservationgroup
        HAVING COUNT(*) <![CDATA[ > ]]> 1
    </select>
    <select id="geDuplicatePatients" resultType="com.center.medical.bean.model.Peispatient">
        SELECT id,
               f_paused,
               numorgresv,
               patientcode,
               patientname,
               idcardno,
               phone,
               hospitalcode,
               f_registered,
               createdate,
               modifydate,
               patientarchiveno,
               id_orgreservation,
               id_orgreservationgroup,
               moneyamountpaid
        FROM md_peispatient
        WHERE patientname = #{param.patientname}
          AND f_usecodehiden = 1
          AND (f_paused = 0 OR f_paused IS NULL)
          AND doctorapply != '补检'
          AND idcardno = #{param.idcardno}
          AND phone = #{param.phone}
          AND numorgresv = #{param.numorgresv}
          AND id_orgreservationgroup = #{param.idOrgreservationgroup}
    </select>

    <!--根据订单号获取体检者列表-->
    <select id="getByDdh" resultType="com.center.medical.bean.vo.OrderUserVo">
        SELECT
        p.patientcode,
        p.idcardno,
        co.id AS orderNum,
        p.patientname,
        p.id_sex AS sex,
        p.id_sex AS sex,
        p.birthdate,
        p.age,
        p.phone,
        p.f_isforprepare AS hadReservation,
        p.f_registered AS registered,
        p.dateregister,
        p.id_examtype AS examType,
        p.examsuite_alias AS fmPhone,
        p.f_readytofinal AS checked,
        p.hospitalcode,
        p.countreportxml AS replaced,
        p.lqfs AS takeType,
        0 AS healthReport,
        0 AS workReport,
        p.trades,
        p.medicaltype,
        p.original_trade,
        p.doctorapply AS sale,
        sb.fzx AS branchName
        FROM
        md_peispatient p
        LEFT JOIN md_createorder co ON p.numorgresv = co.ddh
        LEFT JOIN sys_branch sb ON p.hospitalcode = sb.branch_id
        <where>
            p.f_paused = 0
            <if test="params.orderId != null and params.orderId != ''">
                AND co.id = #{params.orderId}
            </if>
            <if test="params.registered != null">
                AND p.f_registered = #{params.registered}
            </if>
            <if test="params.phone != null and params.phone != ''">
                AND p.phone = #{params.phone}
            </if>
        </where>
    </select>

    <!--查询推送给第三方的体检者数据-->
    <select id="getPushData" resultType="com.center.medical.bean.dto.UserExamDataDto">
        SELECT
        p.patientname,
        p.patientcode,
        p.idcardno AS idCard,
        p.phone,
        p.address,
        p.id_sex AS sex,
        sb.fzx AS branchName,
        co.id AS orderId,
        p.id_org AS customerId,
        p.org_name AS customerName,
        p.org_depart AS orgDepart,
        p.id_examtype AS examType,
        p.dateregister,
        CONCAT('https://XXX.XXX.XXX.XXXm',ppp.picture) AS avator,
        CASE
        WHEN p.f_registered = 0 THEN
        0
        WHEN p.f_readytofinal = 0 THEN
        1 ELSE 2
        END AS `status`
        FROM
        md_peispatient p
        LEFT JOIN sys_branch sb ON p.hospitalcode = sb.branch_id
        LEFT JOIN md_createorder co ON p.numorgresv = co.ddh
        LEFT JOIN md_peispatient_photo ppp ON p.patientcode = ppp.patientcode
        <where>
            p.f_registered = 1
            <if test="params.orderId != null and params.orderId != ''">
                AND co.id = #{params.orderId}
            </if>
        </where>
    </select>

    <!--获取总检数据-->
    <select id="getSectionTotal" resultType="com.center.medical.bean.dto.SectionTotalDto">
        SELECT
            disease_health AS examType,
            summarize,
            CASE
                WHEN disease_health = 0 THEN
                    offer ELSE jkoffer
                END AS proposal,
            verdict,
            posistive,
            total_time AS examTime
        FROM
            md_section_total
        WHERE
            is_delete = 0
            AND patientcode = #{patientcode}
    </select>

    <!--获取每个科室的检查结果和小结-->
    <select id="getSectionResult" resultType="com.center.medical.bean.dto.ExamItemDataDto">
        SELECT
            p.id,
            p.examfeeitem_name AS itemName,
            p.id_ks AS departmentId,
            sd.dept_name AS department,
            p.id_examfeeitem,
            CASE
                WHEN p.id_ks IN ( '163', '143', '173', '24', '171', '402848e3625a920201625ff99a3404a5' ) THEN
                    NULL ELSE
                    CASE
                        WHEN ( SELECT SUM( posistive ) FROM md_section_result_two WHERE patientcode = #{patientcode} AND charges_id = p.id_examfeeitem ) > 0 THEN
                            1 ELSE 0
                        END
                END AS positive,
            CASE
                WHEN p.id_ks IN ( '143', '173', '24', '171', '402848e3625a920201625ff99a3404a5' ) THEN
                    GROUP_CONCAT( pr.examresultdesc SEPARATOR ' | ' )
                WHEN p.id_ks IN ( '19' ) THEN
                    GROUP_CONCAT( IFNULL( d.inspect_describe, d.sign_list ) SEPARATOR ' | ' )
                ELSE GROUP_CONCAT( CONCAT( d.item_name, ':', IFNULL( d.inspect_describe, d.sign_list ) ) SEPARATOR ' | ' )
                END AS result,
            CASE
                WHEN p.id_ks IN ( '143', '173', '24', '171', '402848e3625a920201625ff99a3404a5' ) THEN
                    GROUP_CONCAT( pr.examresultsummary SEPARATOR ',' )
                WHEN p.id_ks IN ( '19' ) THEN
                    GROUP_CONCAT( d.inspect_describe SEPARATOR ',' ) ELSE srm.conclusions
                END AS conclusion,
            srm.audit_time AS examDate
        FROM
            md_peispatientfeeitem p
                LEFT JOIN md_pacs_result pr ON p.id_patient = pr.patientcode
                AND p.id_examfeeitem = pr.item_id
                LEFT JOIN md_describe d ON p.id_patient = d.patientcode
                AND p.id_examfeeitem = d.fee_id
                LEFT JOIN md_section_result_main srm ON p.id_patient = srm.patientcode
                AND p.id_ks = srm.dep_id
                LEFT JOIN sys_dept sd ON p.id_ks = sd.dept_no
        WHERE
            p.id_patient = #{patientcode}
          AND p.f_mark_feereturn = 0
        GROUP BY
            p.id_examfeeitem
    </select>




    <!--获取自助登记机团检客户-->
    <select id="getRegistrationMachineList" resultType="com.center.medical.bean.model.Peispatient">
        SELECT
            p.*
        FROM
            md_peispatient p
            left join md_peisorgreservation pv on p.id_orgreservation = pv.id
        <where>
            p.idcardno = #{idcardno}
            AND p.f_usecodehiden = 1
            AND p.f_registered = 0
            AND (p.f_paused = 0 or p.f_paused is null)
            AND pv.f_finished = 0
        </where>
    </select>

    <!--检查体检号和手机号是否相符合-->
    <select id="checkPatientcode" resultType="java.lang.Long">
        SELECT
            count(*)
        FROM
            md_peispatient p
                LEFT JOIN md_peispatientarchive pa ON pa.patientarchiveno = p.patientarchiveno
        <where>
            short_code = #{shortCode}
          AND (p.phone = #{phone} OR pa.phone = #{phone})
        </where>
    </select>
</mapper>

