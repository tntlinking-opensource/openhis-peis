<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.statistics.dao.GroupStatusMapper">

    <!-- 查询列表数据 -->
    <select id="getList" resultType="com.center.medical.statistics.bean.vo.GroupStatusVo">
        SELECT
            p.patientcode,
            p.patientname,
            p.id_sex AS sex,
            p.age,
            p.id_marriage AS marry,
            p.org_name,
            p.org_depart,
            p.jktjzt,
            p.zytjzt,
            group_concat( pi.examfeeitem_name ) AS unchecked,
            STR_TO_DATE ( p.dateregister, '%Y-%m-%d %T' ) AS dateregister,
            p.f_registered,
            p.f_readytofinal,
            p.createdate AS createDate,
            p.examsuite_name,
            p.doctorapply AS idOpendoctor,
            ( CASE WHEN p.numorgresv =- 1 THEN NULL ELSE p.numorgresv END ) AS ddh
        FROM
            md_peispatient p
                LEFT JOIN md_peispatientfeeitem pi ON pi.id_patient = p.patientcode
                AND ( pi.f_examinated IS NULL OR pi.f_examinated = 0 )
        <where>
            1 = 1
            <if test="param.startTime!=null">
                AND p.createdate <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.createdate <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.startRegTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startRegTime}
            </if>
            <if test="param.endRegTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endRegTime}
            </if>
            <if test="param.isOrg!=null">
                <choose>
                    <when test="param.isOrg == 1">
                        <if test="param.orgName!=null and param.orgName!=''">
                            AND p.org_name LIKE concat('%',#{param.orgName},'%')
                        </if>
                    </when>
                    <otherwise>
                        AND (p.org_name IS NULL OR p.org_name = '')
                    </otherwise>
                </choose>
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND p.patientcode LIKE concat('%',#{param.patientcode},'%')
            </if>
            <if test="param.name!=null and param.name!=''">
                AND p.patientname LIKE concat('%',#{param.name},'%')
            </if>
            <if test="param.containUnchecked!=null and param.containUnchecked!=1">
                AND p.f_registered = 1
            </if>
            <if test="param.idOpendoctor!=null and param.idOpendoctor!=''">
                AND p.id_opendoctor = #{param.idOpendoctor}
            </if>
            <if test="param.ddh!=null and param.ddh!=''">
                AND p.numorgresv = #{param.ddh}
            </if>
        </where>
        GROUP BY
            p.patientcode,
            p.patientname,
            p.id_sex,
            p.age,
            p.id_marriage,
            p.org_name,
            p.org_depart,
            p.jktjzt,
            p.zytjzt,
            p.dateregister,
            p.f_registered,
            p.f_readytofinal,
            p.createdate,
            p.examsuite_name,
            p.doctorapply,
            p.numorgresv
        ORDER BY p.dateregister DESC
    </select>



    <!-- 导出体检者团体状态统计 -->
    <select id="exportData" resultType="com.center.medical.statistics.bean.vo.GroupStatusVo">
        SELECT
        p.patientcode,
        p.patientname,
        p.id_sex AS sex,
        p.age,
        p.id_marriage AS marry,
        p.org_name,
        p.org_depart,
        p.jktjzt,
        p.zytjzt,
        group_concat( pi.examfeeitem_name ) AS unchecked,
        p.dateregister,
        p.f_registered,
        p.f_readytofinal,
        p.createdate AS createDate,
        p.examsuite_name,
        p.doctorapply AS idOpendoctor,
        ( CASE WHEN p.numorgresv =- 1 THEN NULL ELSE p.numorgresv END ) AS ddh
        FROM
        md_peispatient p
        LEFT JOIN md_peispatientfeeitem pi ON pi.id_patient = p.patientcode
        AND ( pi.f_examinated IS NULL OR pi.f_examinated = 0 )
        <where>
            1 = 1
            <if test="param.startTime!=null">
                AND p.createdate <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.createdate <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.startRegTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startRegTime}
            </if>
            <if test="param.endRegTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endRegTime}
            </if>
            <if test="param.isOrg!=null">
                <choose>
                    <when test="param.isOrg == 1">
                        <if test="param.orgName!=null and param.orgName!=''">
                            AND p.org_name LIKE concat('%',#{param.orgName},'%')
                        </if>
                    </when>
                    <otherwise>
                        AND (p.org_name IS NULL OR p.org_name = '')
                    </otherwise>
                </choose>
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND p.patientcode LIKE concat('%',#{param.patientcode},'%')
            </if>
            <if test="param.name!=null and param.name!=''">
                AND p.patientname LIKE concat('%',#{param.name},'%')
            </if>
            <if test="param.containUnchecked!=null and param.containUnchecked!=1">
                AND p.f_registered = 1
            </if>
            <if test="param.idOpendoctor!=null and param.idOpendoctor!=''">
                AND p.id_opendoctor = #{param.idOpendoctor}
            </if>
            <if test="param.ddh!=null and param.ddh!=''">
                AND p.numorgresv = #{param.ddh}
            </if>
        </where>
        GROUP BY
        p.patientcode,
        p.patientname,
        p.id_sex,
        p.age,
        p.id_marriage,
        p.org_name,
        p.org_depart,
        p.jktjzt,
        p.zytjzt,
        p.dateregister,
        p.f_registered,
        p.f_readytofinal,
        p.createdate,
        p.examsuite_name,
        p.doctorapply,
        p.numorgresv
        ORDER BY p.dateregister DESC
    </select>
</mapper>

