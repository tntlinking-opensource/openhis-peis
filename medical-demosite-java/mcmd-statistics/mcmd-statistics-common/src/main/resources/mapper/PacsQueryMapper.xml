<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.statistics.dao.PacsQueryMapper">


    <!-- 查询列表数据 -->
    <select id="getPage" resultType="com.center.medical.statistics.bean.vo.PacsQueryVo">
        SELECT d.dept_name,
               r.patientcode,
               r.patientname,
               ( CASE WHEN p.id_sex = '0' THEN '男' ELSE '女' END ) as idSex,
               p.age,
               STR_TO_DATE ( p.dateregister, '%Y-%m-%d' ) as dateregister,
               STR_TO_DATE ( p.medicaldate, '%Y-%m-%d' ) as medicaldate,
               pi.examfeeitem_name,
               r.audit_doctor as examdoctor,
               r.examdoctor as username,
               STR_TO_DATE ( r.examdatetime, '%Y-%m-%d' ) as examdatetime,
               r.examresultdesc,
               r.examresultsummary
        FROM
            md_pacs_result r
                INNER JOIN md_peispatient p ON p.patientcode = r.patientcode
                INNER JOIN md_peispatientfeeitem pi ON pi.id_patient = r.patientcode
                AND pi.id_examfeeitem = r.item_id
                AND pi.change_item = 0
                AND pi.f_transferedhl7 IS NULL
                AND pi.f_giveup = 0
                AND pi.sfjj = 0
                INNER JOIN sys_dept d ON d.dept_no = r.dep_id
        <where>
            1 = 1
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.ks!=null and param.ks!=''">
                AND r.dep_id = #{param.ks}
            </if>
            <if test="param.name!=null and param.name!=''">
                AND r.examdoctor like concat('%',#{param.name},'%')
            </if>
            <if test="param.writename!=null and param.writename!=''">
                AND r.username like concat('%',#{param.writename},'%')
            </if>
            <if test="param.isPacs!=null and param.isPacs == 1">
                AND p.id_examplace = 1
            </if>
            <if test="param.auditName!=null and param.auditName!=''">
                AND r.audit_doctor like concat('%',#{param.auditName},'%')
            </if>
        </where>
        ORDER BY d.dept_name
    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultType="com.center.medical.pacslis.bean.model.PacsPeispatient">

    </select>


    <!-- 查询列表数据 -->
    <select id="getTableData" resultType="com.center.medical.statistics.bean.dto.PQTableDataDto">
        SELECT
            r.audit_doctor as name,
            count(*) as value
        FROM
            md_pacs_result r
                INNER JOIN md_peispatient p ON p.patientcode = r.patientcode
                INNER JOIN md_peispatientfeeitem pi ON pi.id_patient = r.patientcode
                AND pi.id_examfeeitem = r.item_id
                AND pi.change_item = 0
                AND pi.f_transferedhl7 IS NULL
                AND pi.f_giveup = 0
                AND pi.sfjj = 0
                INNER JOIN sys_dept d ON d.dept_no = r.dep_id
        <where>
            1 = 1
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.ks!=null and param.ks!=''">
                AND r.dep_id = #{param.ks}
            </if>
            <if test="param.name!=null and param.name!=''">
                AND r.examdoctor like concat('%',#{param.name},'%')
            </if>
            <if test="param.writename!=null and param.writename!=''">
                AND r.username like concat('%',#{param.writename},'%')
            </if>
            <if test="param.isPacs!=null and param.isPacs == 1">
                AND p.id_examplace = 1
            </if>
            <if test="param.auditName!=null and param.auditName!=''">
                AND r.audit_doctor like concat('%',#{param.auditName},'%')
            </if>
        </where>
        GROUP BY r.examdoctor
        ORDER BY value DESC
    </select>


    <!-- 导出科室工作量统计 -->
    <select id="getExportData" resultType="com.center.medical.statistics.bean.vo.PacsQueryVo">
        SELECT d.dept_name,
        r.patientcode,
        r.patientname,
        ( CASE WHEN p.id_sex = '0' THEN '男' ELSE '女' END ) as idSex,
        p.age,
        STR_TO_DATE ( p.dateregister, '%Y-%m-%d' ) as dateregister,
        STR_TO_DATE ( p.medicaldate, '%Y-%m-%d' ) as medicaldate,
        pi.examfeeitem_name,
        r.audit_doctor as examdoctor,
        r.examdoctor as username,
        STR_TO_DATE ( r.examdatetime, '%Y-%m-%d' ) as examdatetime,
        r.examresultdesc,
        r.examresultsummary
        FROM
        md_pacs_result r
        INNER JOIN md_peispatient p ON p.patientcode = r.patientcode
        INNER JOIN md_peispatientfeeitem pi ON pi.id_patient = r.patientcode
        AND pi.id_examfeeitem = r.item_id
        AND pi.change_item = 0
        AND pi.f_transferedhl7 IS NULL
        AND pi.f_giveup = 0
        AND ( pi.sfjj IS NULL OR pi.sfjj = 0 )
        INNER JOIN sys_dept d ON d.dept_no = r.dep_id
        <where>
            1 = 1
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.ks!=null and param.ks!=''">
                AND r.dep_id = #{param.ks}
            </if>
            <if test="param.name!=null and param.name!=''">
                AND r.examdoctor like concat('%',#{param.name},'%')
            </if>
            <if test="param.writename!=null and param.writename!=''">
                AND r.username like concat('%',#{param.writename},'%')
            </if>
            <if test="param.isPacs!=null and param.isPacs == 1">
                AND p.id_examplace = 1
            </if>
            <if test="param.auditName!=null and param.auditName!=''">
                AND r.audit_doctor like concat('%',#{param.auditName},'%')
            </if>
        </where>
        ORDER BY d.dept_name
    </select>


    <!-- 获取图表数据 -->
    <select id="getPacsDoctorTableData" resultType="com.center.medical.statistics.bean.dto.PQTableDataDto">
        SELECT
            u.user_name AS name,
            count( a.examfeeitem_code ) as value
        FROM
            md_pacs_result a
            INNER JOIN sys_user u ON u.user_name = a.audit_doctor
            AND u.del_flag = 0
            INNER JOIN md_items i ON i.id = a.item_id
            AND i.is_delete = 0
        <where>
            1 = 1
            <if test="param.startTime!=null">
                AND a.examdatetime <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND a.examdatetime <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.name!=null and param.name!=''">
                AND u.user_no = #{param.name}
            </if>
            <if test="param.itemId!=null and param.itemId!=''">
                AND i.id = #{param.itemId}
            </if>
            <if test="param.branchIds!=null and param.branchIds.size > 0">
                AND u.cid IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
        </where>
        GROUP BY u.user_name
        ORDER BY u.user_name
    </select>



    <!-- pacs科室医生工作量统计 -->
    <select id="exportWorkData" resultType="com.center.medical.statistics.bean.vo.AnalysePacsVo">
        SELECT
        STR_TO_DATE ( a.examdatetime, '%Y-%m-%d' ) AS rummagerTime,
        u.user_name AS userName,
        i.examfeeitem_name AS examName,
        IFNULL(count( a.examfeeitem_code ),0) AS gzlTotal,
        IFNULL(count( CASE WHEN p.numorgresv =- 1 THEN a.examfeeitem_code ELSE NULL END ),0) AS gzlGr,
        IFNULL ( sum( i.unitprice ), 0 ) AS oriTotal,
        IFNULL ( sum( CASE WHEN p.numorgresv =- 1 THEN i.unitprice ELSE 0 END ), 0 ) AS oriGr,
        d.dept_name AS depName
        FROM
        md_pacs_result a
        INNER JOIN sys_user u ON u.user_name = a.audit_doctor
        AND u.del_flag = 0
        INNER JOIN md_items i ON i.id = a.item_id
        AND i.is_delete = 0
        LEFT JOIN sys_dept d ON d.dept_no = i.id_depart
        INNER JOIN md_peispatient p ON p.patientcode = a.patientcode
        <where>
            1 = 1
            <if test="param.startTime!=null">
                AND a.examdatetime <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND a.examdatetime <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.name!=null and param.name!=''">
                AND u.user_no = #{param.name}
            </if>
            <if test="param.itemId!=null and param.itemId!=''">
                AND i.id = #{param.itemId}
            </if>
            <if test="param.branchIds!=null and param.branchIds.size > 0">
                AND u.cid IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
        </where>
        GROUP BY
        STR_TO_DATE ( a.examdatetime, '%Y-%m-%d' ),
        u.user_name,
        i.examfeeitem_name,
        d.dept_name
        ORDER BY
        STR_TO_DATE ( a.examdatetime, '%Y-%m-%d' ),
        d.dept_name,
        i.examfeeitem_name,
        u.user_name
    </select>



    <!-- pacs科室医生工作量统计总计 -->
    <select id="exportTotal" resultType="com.center.medical.statistics.bean.vo.ExportTotalVo">
        SELECT
        u.user_name AS userName,
        i.examfeeitem_name AS examName,
        IFNULL(count( a.examfeeitem_code ),0) AS gzlTotal,
        IFNULL(count( CASE WHEN p.numorgresv =- 1 THEN a.examfeeitem_code ELSE NULL END ),0) AS gzlGr,
        sum( i.unitprice ) AS oriTotal,
        sum( CASE WHEN p.numorgresv =- 1 THEN i.unitprice ELSE 0 END ) AS oriGr,
        d.dept_name AS depName
        FROM
        md_pacs_result a
        INNER JOIN sys_user u ON u.user_name = a.audit_doctor
        AND u.del_flag = 0
        INNER JOIN md_items i ON i.id = a.item_id
        AND i.is_delete = 0
        LEFT JOIN sys_dept d ON d.dept_no = i.id_depart
        INNER JOIN md_peispatient p ON p.patientcode = a.patientcode
        <where>
            1 = 1
            <if test="param.startTime!=null">
                AND a.examdatetime <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND a.examdatetime <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.name!=null and param.name!=''">
                AND u.user_no = #{param.name}
            </if>
            <if test="param.itemId!=null and param.itemId!=''">
                AND i.id = #{param.itemId}
            </if>
            <if test="param.branchIds!=null and param.branchIds.size > 0">
                AND u.cid IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
        </where>
        GROUP BY
        u.user_name,
        i.examfeeitem_name,
        d.dept_name
        ORDER BY
        d.dept_name,
        i.examfeeitem_name,
        u.user_name
    </select>
</mapper>

