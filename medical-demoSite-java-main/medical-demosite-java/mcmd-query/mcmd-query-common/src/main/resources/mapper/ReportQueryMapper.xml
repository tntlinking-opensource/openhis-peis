<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.query.dao.ReportQueryMapper">


    <!-- 查询列表数据 -->
    <select id="getList" resultType="com.center.medical.query.bean.vo.ReportQueryVo">
        SELECT p.patientcode,
        p.patientname,
        p.org_name,
        STR_TO_DATE(p.dateregister, '%Y-%m-%d %T') AS dateregister,
        (CASE WHEN p.id_sex = '0' THEN '男' ELSE '女' END) AS sex,
        p.age,
        m.method_name AS sendMethod,
        r.express_num,
        r.express_id,
        p.id_examtype AS tjlx,
        p.f_examstarted AS fExamStart,
        p.f_readytofinal,
        p.f_finallocked AS fFinalLocked,
        <choose>
            <when test="param.tjlx == 1">
                p.zytjzt AS tjzt,
            </when>
            <otherwise>
                p.jktjzt AS tjzt,
            </otherwise>
        </choose>
        <choose>
            <when test="param.tjlx == 0">
                p.doctorfinal_name_r AS doctorFinalName,
            </when>
            <otherwise>
                p.patientnameencoded AS doctorFinalName,
            </otherwise>
        </choose>
        <choose>
            <when test="param.tjlx == 0">
                STR_TO_DATE(p.datefinalexamed, '%Y-%m-%d %T') AS dateFinalExamed,
            </when>
            <otherwise>
                STR_TO_DATE(p.dateregisternotime, '%Y-%m-%d %T') AS dateFinalExamed,
            </otherwise>
        </choose>
        r.print_man AS printName,
        STR_TO_DATE ( r.print_time, '%Y-%m-%d %T' ) AS printTime,
        <choose>
            <when test="param.tjlx == 1">
                p.zytjzt AS bgzt,
            </when>
            <otherwise>
                p.jktjzt AS bgzt,
            </otherwise>
        </choose>
        r.join_person_man,
        STR_TO_DATE ( r.rev_time, '%Y-%m-%d %T' ) AS revTime,
        r.rev_person_man,
        <choose>
            <when test="param.tjlx == 1">
                p.zytjzt AS yfzt,
            </when>
            <otherwise>
                p.jktjzt AS yfzt,
            </otherwise>
        </choose>
        STR_TO_DATE ( r.notify_date, '%Y-%m-%d %T' ) AS notifyDate,
        r.getter_name,
        STR_TO_DATE ( r.get_time, '%Y-%m-%d %T' ) AS getTime,
        r.getter_phone,
        r.is_total,
        r.status,
        r.id,
        p.numorgresv,
        r.chest_num
        FROM
        md_peispatient p
        LEFT JOIN md_report r ON r.patientcode = p.patientcode
        AND r.disease_health = #{param.tjlx}
        LEFT JOIN md_notificationmethod m ON r.grant_id = m.id
        <where>
            p.f_registered = 1
            <choose>
                <when test="param.tjlx == 1">
                    AND p.id_examtype != '0'
                </when>
                <otherwise>
                    AND p.id_examtype IN ('0','2')
                </otherwise>
            </choose>
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.numorgresv!=null and param.numorgresv!=''">
                AND p.numorgresv = #{param.numorgresv}
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND p.patientname LIKE concat('%',#{param.patientname},'%')
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND p.patientcode LIKE concat('%',#{param.patientcode},'%')
            </if>
            <if test="param.idOrg!=null and param.idOrg!=''">
                AND p.id_org = #{param.idOrg}
            </if>
            <if test="param.inputCode!=null and param.inputCode!=''">
                AND p.input_code LIKE concat('%',#{param.inputCode},'%')
            </if>
            <if test="param.examstate!=null">
                <choose>
                    <when test="param.examstate == -1">
                        AND
                        <choose>
                            <when test="param.tjlx == 1">
                                p.zytjzt
                            </when>
                            <otherwise>
                                p.jktjzt
                            </otherwise>
                        </choose>
                        IS NULL
                    </when>
                    <otherwise>
                        AND
                        <choose>
                            <when test="param.tjlx == 1">
                                p.zytjzt
                            </when>
                            <otherwise>
                                p.jktjzt
                            </otherwise>
                        </choose>
                        = #{param.examstate}
                    </otherwise>
                </choose>
            </if>
            <if test="param.yjlx!=null">
                <choose>
                    <when test="param.yjlx == 0">
                        <choose>
                            <when test="param.tjlx == 1">
                                AND p.f_registered = 1 AND p.zytjzt <![CDATA[ < ]]> 9
                                AND p.dateregister <![CDATA[ < ]]> #{param.before7}
                            </when>
                            <otherwise>
                                AND p.f_registered = 1 AND p.jktjzt <![CDATA[ < ]]> 9
                                AND p.dateregister <![CDATA[ < ]]> #{param.before7}
                            </otherwise>
                        </choose>
                    </when>
                    <otherwise>
                        <choose>
                            <when test="param.tjlx == 1">
                                AND p.zytjzt <![CDATA[ < ]]> 11 AND p.zytjzt >= 9
                                AND r.rev_time <![CDATA[ < ]]> #{param.before7}
                            </when>
                            <otherwise>
                                AND p.jktjzt <![CDATA[ < ]]> 11 AND p.jktjzt >= 9
                                AND r.rev_time <![CDATA[ < ]]> #{param.before7}
                            </otherwise>
                        </choose>
                    </otherwise>
                </choose>
            </if>
            <if test="param.branchIds!=null">
                AND p.hospitalcode IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
        </where>
        ORDER BY p.dateregister DESC,p.patientcode DESC
    </select>


    <!-- 导出报告信息 -->
    <select id="getExportData" resultType="com.center.medical.query.bean.vo.ReportQueryVo">
        SELECT p.patientcode,
        p.patientname,
        p.org_name,
        STR_TO_DATE(p.dateregister, '%Y-%m-%d %T') AS dateregister,
        (CASE WHEN p.id_sex = '0' THEN '男' ELSE '女' END) AS sex,
        p.age,
        m.method_name AS sendMethod,
        r.express_num,
        r.express_id,
        p.id_examtype AS tjlx,
        p.f_examstarted AS fExamStart,
        p.f_readytofinal,
        p.f_finallocked AS fFinalLocked,
        <choose>
            <when test="param.tjlx == 1">
                p.zytjzt AS tjzt,
            </when>
            <otherwise>
                p.jktjzt AS tjzt,
            </otherwise>
        </choose>
        <choose>
            <when test="param.tjlx == 0">
                p.doctorfinal_name_r AS doctorFinalName,
            </when>
            <otherwise>
                p.patientnameencoded AS doctorFinalName,
            </otherwise>
        </choose>
        <choose>
            <when test="param.tjlx == 0">
                STR_TO_DATE(p.datefinalexamed, '%Y-%m-%d %T') AS dateFinalExamed,
            </when>
            <otherwise>
                STR_TO_DATE(p.dateregisternotime, '%Y-%m-%d %T') AS dateFinalExamed,
            </otherwise>
        </choose>
        r.print_man AS printName,
        STR_TO_DATE ( r.print_time, '%Y-%m-%d %T' ) AS printTime,
        <choose>
            <when test="param.tjlx == 1">
                p.zytjzt AS bgzt,
            </when>
            <otherwise>
                p.jktjzt AS bgzt,
            </otherwise>
        </choose>
        r.join_person_man,
        STR_TO_DATE ( r.rev_time, '%Y-%m-%d %T' ) AS revTime,
        r.rev_person_man,
        <choose>
            <when test="param.tjlx == 1">
                p.zytjzt AS yfzt,
            </when>
            <otherwise>
                p.jktjzt AS yfzt,
            </otherwise>
        </choose>
        STR_TO_DATE ( r.notify_date, '%Y-%m-%d %T' ) AS notifyDate,
        r.getter_name,
        STR_TO_DATE ( r.get_time, '%Y-%m-%d %T' ) AS getTime,
        r.getter_phone,
        r.is_total,
        r.status,
        r.id,
        p.numorgresv,
        r.chest_num
        FROM
        md_peispatient p
        LEFT JOIN md_report r ON r.patientcode = p.patientcode
        AND r.disease_health = #{param.tjlx}
        LEFT JOIN md_notificationmethod m ON r.grant_id = m.id
        <where>
            p.f_registered = 1
            <choose>
                <when test="param.tjlx == 1">
                    AND p.id_examtype != '0'
                </when>
                <otherwise>
                    AND p.id_examtype IN ('0','2')
                </otherwise>
            </choose>
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.numorgresv!=null and param.numorgresv!=''">
                AND p.numorgresv = #{param.numorgresv}
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND p.patientname LIKE concat('%',#{param.patientname},'%')
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND p.patientcode LIKE concat('%',#{param.patientcode},'%')
            </if>
            <if test="param.idOrg!=null and param.idOrg!=''">
                AND p.id_org = #{param.idOrg}
            </if>
            <if test="param.inputCode!=null and param.inputCode!=''">
                AND p.input_code LIKE concat('%',#{param.inputCode},'%')
            </if>
            <if test="param.examstate!=null">
                <choose>
                    <when test="param.examstate == -1">
                        AND
                        <choose>
                            <when test="param.tjlx == 1">
                                p.zytjzt
                            </when>
                            <otherwise>
                                p.jktjzt
                            </otherwise>
                        </choose>
                        IS NULL
                    </when>
                    <otherwise>
                        AND
                        <choose>
                            <when test="param.tjlx == 1">
                                p.zytjzt
                            </when>
                            <otherwise>
                                p.jktjzt
                            </otherwise>
                        </choose>
                        = #{param.examstate}
                    </otherwise>
                </choose>
            </if>
            <if test="param.yjlx!=null">
                <choose>
                    <when test="param.yjlx == 0">
                        <choose>
                            <when test="param.tjlx == 1">
                                AND p.f_registered = 1 AND p.zytjzt <![CDATA[ < ]]> 9
                                AND p.dateregister <![CDATA[ < ]]> #{param.before7}
                            </when>
                            <otherwise>
                                AND p.f_registered = 1 AND p.jktjzt <![CDATA[ < ]]> 9
                                AND p.dateregister <![CDATA[ < ]]> #{param.before7}
                            </otherwise>
                        </choose>
                    </when>
                    <otherwise>
                        <choose>
                            <when test="param.tjlx == 1">
                                AND p.zytjzt <![CDATA[ < ]]> 11 AND p.zytjzt >= 9
                                AND r.rev_time <![CDATA[ < ]]> #{param.before7}
                            </when>
                            <otherwise>
                                AND p.jktjzt <![CDATA[ < ]]> 11 AND p.jktjzt >= 9
                                AND r.rev_time <![CDATA[ < ]]> #{param.before7}
                            </otherwise>
                        </choose>
                    </otherwise>
                </choose>
            </if>
            <if test="param.branchIds!=null">
                AND p.hospitalcode IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
        </where>
        ORDER BY p.dateregister DESC,p.patientcode DESC
    </select>

</mapper>

