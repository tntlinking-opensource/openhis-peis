<?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="com.center.medical.sellcrm.dao.ItemListOnlineMapper">


    <!-- 数据表字段属性 -->
    <sql id="selectCreateorderVo">
        select id, ddh, ddmc, dddm, khdwmcid, txfs, fsdxsjh, cjddrq, khdwdh, tjzx, jhjqc, jhjqd, sfyqdht, htbh, nxtjrs, vxtjrs, ddjg, ddzk, ddyhj, qtxz, spzt, spyj, xsjlid, xsjl, fzxid, is_delete, createdate, modifydate, urls, bgzt, xsdh, tjxs, clurls, clspzt, clspyj, id_inforway, tjlx, spr, clspr, is_online, submit_time, cant_replace, chest_num, bgmemo, review_payway, review_zk, template_jm, template_text, kdzl_name, is_market            from md_createorder
    </sql>

    <!-- 查询列表数据 -->
    <select id="getList" resultType="com.center.medical.sellcrm.bean.vo.ItemOnlineVo">
        SELECT
            c.id,
            c.ddh,
            c.ddmc,
            cs.khdwmc,
            c.xsjlid,
            c.jhjqc,
            c.jhjqd,
            c.nxtjrs,
            c.vxtjrs,
            c.khdwdh,
            c.qtxz,
            cs.khdwzcdz,
            cs.xsjl,
            p.nums,
            c.urls,
            mo.tbzt,
            v.f_finished as fFinished,
            c.bgzt,
            c.submit_time,
            mo.bdrq,
            c.bgmemo,
            c.is_online,
            c.kdzl_name,
            (c.nxtjrs + c.vxtjrs) as yjrs
        FROM
            md_createorder c
                LEFT JOIN crm_sellcustomer cs ON c.khdwmcid = cs.id
                LEFT JOIN md_orderandfzx mo ON c.id = mo.ddid
                LEFT JOIN ( SELECT numorgresv, count( 1 ) nums FROM md_peispatient GROUP BY numorgresv ) p ON p.numorgresv = c.ddh
                LEFT JOIN md_peisorgreservation v ON c.id = v.ddh
        <where>
            c.is_delete = 0
            AND cs.is_delete = 0
            AND c.spzt = 4
            <if test="param.ddh!=null and param.ddh!=''">
                AND c.ddh like concat('%',#{param.ddh},'%')
            </if>
            <if test="param.khdwmcid!=null and param.khdwmcid!=''">
                AND c.khdwmcid = #{param.khdwmcid}
            </if>
            <if test="param.xsjlid!=null and param.xsjlid!=''">
                AND cs.xsjlid = #{param.xsjlid}
            </if>
            <if test="param.kdzlName!=null and param.kdzlName!=''">
                AND c.kdzl_name like concat('%',#{param.kdzlName},'%')
            </if>
            <if test="param.khdwmc!=null and param.khdwmc!=''">
                AND cs.khdwmc like concat('%',#{param.kdzlName},'%')
            </if>
            <if test="param.isOnline!=null and param.isOnline == 1">
                AND c.xsjlid = #{param.userNo}
                AND c.fzxid = #{param.fzxId}
            </if>
        </where>
        <choose>
            <when test="param.sortByOrder!=null and param.sortByOrder == 1">
                ORDER BY cast(c.ddh as unsigned int) DESC
            </when>
            <otherwise>
                ORDER BY c.createdate DESC
            </otherwise>
        </choose>
    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultType="com.center.medical.sellcrm.bean.model.Createorder">
        <include refid="selectCreateorderVo"/>
        <where>
            id = #{id}
        </where>
    </select>



    <!-- 导出Excel数据 -->
    <select id="getExportData" resultType="com.center.medical.sellcrm.bean.vo.ItemOnlineVo">
        SELECT
        c.id,
        c.ddh,
        c.ddmc,
        cs.khdwmc,
        c.xsjlid,
        c.jhjqc,
        c.jhjqd,
        c.nxtjrs,
        c.vxtjrs,
        c.khdwdh,
        c.qtxz,
        cs.khdwzcdz,
        cs.xsjl,
        p.nums,
        c.urls,
        mo.tbzt,
        v.f_finished,
        c.bgzt,
        c.submit_time,
        mo.bdrq,
        c.bgmemo,
        c.is_online,
        c.kdzl_name,
        (c.nxtjrs+c.vxtjrs) AS yjrs
        FROM
        md_createorder c
        LEFT JOIN crm_sellcustomer cs ON c.khdwmcid = cs.id
        LEFT JOIN md_orderandfzx mo ON c.id = mo.ddid
        LEFT JOIN ( SELECT numorgresv, count( 1 ) nums FROM md_peispatient GROUP BY numorgresv ) p ON p.numorgresv = c.ddh
        LEFT JOIN md_peisorgreservation v ON c.id = v.ddh
        <where>
            c.is_delete = 0
            AND cs.is_delete = 0
            AND c.spzt = 4
            <if test="param.ddh!=null and param.ddh!=''">
                AND c.ddh like concat('%',#{param.ddh},'%')
            </if>
            <if test="param.khdwmcid!=null and param.khdwmcid!=''">
                AND c.khdwmcid = #{param.khdwmcid}
            </if>
            <if test="param.xsjlid!=null and param.xsjlid!=''">
                AND cs.xsjlid = #{param.xsjlid}
            </if>
            <if test="param.kdzlName!=null and param.kdzlName!=''">
                AND c.kdzl_name like concat('%',#{param.kdzlName},'%')
            </if>
            <if test="param.khdwmc!=null and param.khdwmc!=''">
                AND cs.khdwmc like concat('%',#{param.kdzlName},'%')
            </if>
            <if test="param.isOnline!=null and param.isOnline == 1">
                AND c.xsjlid = #{param.userNo}
                AND c.fzxid = #{param.fzxId}
            </if>
        </where>
        <if test="param.sortByOrder!=null">
            <choose>
                <when test="param.sortByOrder == 1">
                    ORDER BY cast(c.ddh as unsigned int) DESC
                </when>
                <otherwise>
                    ORDER BY (
                    CASE
                    WHEN ( mo.tbzt IS NULL OR mo.tbzt != 1 )
                    AND c.bgzt = 5 THEN
                    - 1
                    WHEN ( mo.tbzt IS NULL OR mo.tbzt != 1 )
                    AND c.bgzt = 4 THEN
                    0 ELSE 1
                    END
                    ) ASC,
                    mo.bdrq DESC
                </otherwise>
            </choose>
        </if>
    </select>



    <!-- 导出Excel数据 -->
    <select id="getAllTcForOrder" resultType="com.center.medical.sellcrm.bean.vo.AllTcOrderVo">
        SELECT
            IFNULL ( cm.id, cc.id ) id,
            IFNULL ( cm.tjtcmc, cc.tjtcmc ) tjtcmc,
            IFNULL ( cm.tjlx, cc.tjlx ) tjlx,
            IFNULL ( cm.tjtcjc, cc.tjtcjc ) tjtcjc,
            IFNULL ( cm.tjtcsrm, cc.tjtcsrm ) tjtcsrm,
            IFNULL ( cm.jhys, cc.jhys ) jhys,
            IFNULL ( cm.syxb, cc.syxb ) syxb,
            IFNULL ( cm.tcysjg, cc.tcysjg ) tcysjg,
            IFNULL ( cm.tczk, cc.tczk ) tczk,
            IFNULL ( cm.zhjg, cc.zhjg ) zhjg,
            IFNULL ( cm.khdwmcid, cc.khdwmcid ) khdwmcid,
            IFNULL ( cm.sfybd, cc.sfybd ) sfybd,
            IFNULL ( cm.sfyhtc, cc.sfyhtc ) sfyhtc,
            IFNULL ( cm.nlz, cc.nlz ) nlz,
            IFNULL ( cm.nld, cc.nld ) nld,
            IFNULL ( cm.fkfs, cc.fkfs ) fkfs,
            IFNULL ( cm.zytjlb, cc.zytjlb ) zytjlb,
            IFNULL ( cm.kxsl, cc.jxj ) jxj,
            IFNULL ( cm.combostate, cc.combostate ) combostate,
            IFNULL ( cm.xsjlid, cc.xsjlid ) xsjlid,
            cc.bz,
            IFNULL ( cm.is_delete, cc.is_delete ) isDelete,
            cm.sfzx,
            IFNULL ( cm.forbidden, 0 ) forbidden,
            oac.`show`,
            oac.tcid,
            oac.ddid,
            (SELECT GROUP_CONCAT(DISTINCT harm_name)
            FROM md_harm
            WHERE FIND_IN_SET(id, IFNULL(cm.jhys, cc.jhys))
            ) as jhysn
        FROM
            md_orderandcombo oac
                LEFT JOIN md_orderandfzx oaf ON oac.ddid = oaf.ddid
                LEFT JOIN md_createcombo cc ON cc.id = oac.tcid
                AND cc.is_delete = 0
                LEFT JOIN md_createmeal cm ON cm.id = oac.tcid
                AND cm.is_delete = 0
                AND (cm.forbidden IS NULL OR cm.forbidden = 0)
        <where>
            ( cc.id IS NOT NULL OR cm.id IS NOT NULL )
            AND oac.ddid = #{param.idExamsuite}
            AND oac.spzt = 1
            <if test="param.key!=null and param.key!=''">
                AND( cc.tjtcsrm like concat('%',#{param.key},'%')
                OR cm.tjtcsrm like concat('%',#{param.key},'%'))
            </if>
            <if test="param.branchIds!=null">
                AND oaf.fzxid IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
        </where>
        GROUP BY oac.id
        ORDER BY cc.createdate ASC
    </select>


    <!-- 获取分组下相应的人员信息 -->
    <select id="getPatientData" resultType="com.center.medical.sellcrm.bean.vo.PatientDataVo">
        SELECT
            p.id,
            p.patientcode,
            p.patientname,
            p.id_sex,
            p.age,
            p.phone,
            STR_TO_DATE( p.birthdate, '%Y-%m-%d %T') AS birthdate,
            p.idcardno,
            p.id_marriage,
            p.id_nation,
            p.cultural,
            p.org_depart,
            p.workno,
            p.trades,
            p.work_date,
            p.zgl,
            p.harm_date,
            p.jhgl,
            p.medicaltype,
            p.note,
            nsms.id_contact AS smsContact,
            p.jhys,
            '' AS xzfzx,
            p.ts_limit,
            po.wechat_code,
            po.is_wechat_noticed
        FROM
            md_peispatient p
                LEFT JOIN md_peis_ol po ON po.patientbizno = p.patientbizno
                LEFT JOIN md_notify_sms_exam nsms ON p.patientcode = nsms.patientcode
                LEFT JOIN md_peispatient_and_fzx paf ON paf.xzzt = 1
                AND paf.patient_id = p.id
                LEFT JOIN sys_branch b ON b.id = paf.fzx_id
        <where>
            1 = 1
            <if test="param !=null">
                AND p.id_orgreservationgroup = #{param.idOrgreservationgroup}

            <if test="param.inputCode!=null and param.inputCode!=''">
                AND p.input_code like concat('%',#{param.inputCode},'%')
            </if>
            <if test="param.fRegistered!=null and param.fRegistered!=''">
                AND (p.f_registered IS NULL OR p.f_registered = 0)
            </if>
                AND p.id_examtype <![CDATA[ <> ]]> '3'
            </if>
        </where>
        GROUP BY
            p.id,
            p.patientcode,
            p.patientname,
            p.id_sex,
            p.age,
            p.phone,
            STR_TO_DATE( p.birthdate, '%Y-%m-%d' ),
            p.idcardno,
            p.id_marriage,
            p.marriage,
            p.id_nation,
            p.nation,
            p.cultural,
            p.org_depart,
            p.workno,
            p.trades,
            p.work_date,
            p.zgl,
            p.harm_date,
            p.jhgl,
            p.medicaltype,
            p.note,
            nsms.id_contact,
            p.jhys,
            p.createdate,
            p.ts_limit,
            po.wechat_code,
            po.is_wechat_noticed
        ORDER BY
            p.createdate ASC
    </select>



    <!-- 获取分组下相应的人员信息 -->
    <select id="selectNeedNoticeWechatCodeList" resultType="com.center.medical.sellcrm.bean.vo.NeedNoticeVo">
        SELECT
            ol.id,
            ol.createdate,
            ol.modifydate,
            ol.patientbizno,
            ol.wechat_code,
            ol.is_wechat_noticed,
            ol.wechat_notice_type,
            ol.wechat_notice_time,
            p.phone
        FROM
            md_peis_ol ol
                INNER JOIN md_peispatient p ON p.patientbizno = ol.patientbizno
                INNER JOIN md_peisorgreservationgroup g ON g.id = p.id_orgreservationgroup
                AND g.id_patientclass3 = 1
        WHERE
            ( ol.is_wechat_noticed IS NULL OR ol.is_wechat_noticed = 0 )
          AND ol.createdate >= STR_TO_DATE ( '2022-02-13 23:59:59', '%Y-%m-%d %T' )
          AND p.phone IS NOT NULL
        ORDER BY
            ol.createdate DESC
    </select>

</mapper>

