<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.report.dao.ReviewNoticeMapper">


    <!-- 获取所有可疑职业病模板上所需要的数据 -->
    <select id="findAllDiseaseData" resultType="com.center.medical.report.bean.dto.AllDiseaseDataDto">
        SELECT
            p.org_name,
            p.patientname,
            STR_TO_DATE( p.dateregister, '%Y-%m-%d' ) AS dateregister,
            (
                SELECT
                    group_concat( o.occupation_diseast )
                FROM
                    md_occupation_diseast o
                WHERE
                        o.id IN (
                        SELECT
                            z.occupation_diseast
                        FROM
                            md_zy_vs_summary z
                                INNER JOIN md_zy_summary s ON s.id = z.occupation_summary
                        WHERE
                            s.serial_no = '1'
                          AND z.id IN ( SELECT c.progessional_id FROM md_comments_progessional c WHERE c.patientcode = #{patientno} ))) AS abnormal,
            STR_TO_DATE( p.dateregister, '%Y-%m-%d' ) AS date_to,
            p.medicaltype
        FROM
            md_peispatient p
        WHERE
            p.patientcode = #{patientno}
    </select>


    <!-- 获取所有可疑职业病模板上所需要的数据 -->
    <select id="findAllContraindicatedData" resultType="com.center.medical.report.bean.dto.AllContraindicatedDto">
        SELECT
        p.org_name,
        p.patientname,
        STR_TO_DATE ( p.dateregister, '%Y-%m-%d' ) AS dateregister,
        (
        SELECT
        group_concat( z.diagnosis SEPARATOR ';' ) AS diagnosis
        FROM
        md_zy_vs_summary z
        INNER JOIN md_zy_summary s ON s.id = z.occupation_summary
        WHERE
        s.serial_no = '2'
        AND z.zzjjzdm <![CDATA[ <> ]]> '无'
        AND z.zzjjzdm IS NOT NULL
        AND z.id IN ( SELECT c.progessional_id AS progessional_id FROM md_comments_progessional c WHERE c.patientcode =  #{patientno} )) AS diagnosis,
        (
        SELECT
        group_concat( h.harm_name SEPARATOR '、')
        FROM
        md_harm h
        WHERE
        h.id IN (
        SELECT
        z.occupation_diagnosis AS occupation_diagnosis
        FROM
        md_zy_vs_summary z
        INNER JOIN md_zy_summary s ON s.id = z.occupation_summary
        WHERE
        s.serial_no = '2'
        AND z.zzjjzdm <![CDATA[ <> ]]> '无'
        AND z.zzjjzdm IS NOT NULL
        AND z.id IN ( SELECT c.progessional_id AS progessional_id FROM md_comments_progessional c WHERE c.patientcode = #{patientno} ))) AS harm_name,
        p.medicaltype
        FROM
        md_peispatient p
        WHERE
        p.patientcode = #{patientno}
    </select>



    <!-- 获取所有复查模板上所需要的数据 -->
    <select id="findAllReviewData" resultType="com.center.medical.report.bean.dto.AllReviewDataDto">
        SELECT
            a.patientname,
            a.org_name,
            s.posistive,
            a.date_to,
            a.items_name,
            a.notice_of_proceeding_text,
            a.start_date,
            a.total_date,
            a.oo
        FROM
            (
                SELECT
                    p.patientname,
                    IFNULL( sc.license_name, p.org_name ) org_name,
                    p.patientcode,
                    STR_TO_DATE ( r.date_to, '%Y-%m-%d' ) date_to,
                    group_concat( i.examfeeitem_nameprn ) items_name,
                    r.notice_of_proceeding_text,
                    STR_TO_DATE ( p.dateregister, '%Y-%m-%d' ) start_date,
                    STR_TO_DATE( p.dateregisternotime, '%Y-%m-%d' ) total_date,
                    p.org_name oo
                FROM
                    md_peispatient p
                        LEFT JOIN crm_sellcustomer sc ON sc.id = p.id_org
                        LEFT JOIN md_review r ON r.patientcode = p.patientcode
                        AND r.is_delete = 0
                        LEFT JOIN md_review_project o ON o.review_id = r.id
                        LEFT JOIN md_items i ON i.id = o.items_id
                WHERE
                    p.patientcode = #{patientno}
                GROUP BY
                    p.patientname,
                    p.org_name,
                    p.patientcode,
                    r.date_to,
                    r.notice_of_proceeding_text,
                    p.dateregisternotime,
                    p.dateregister,
                    sc.license_name,
                    p.org_name
            ) a
                LEFT JOIN md_section_total s ON s.patientcode = a.patientcode
                AND s.disease_health = 1
    </select>
</mapper>

