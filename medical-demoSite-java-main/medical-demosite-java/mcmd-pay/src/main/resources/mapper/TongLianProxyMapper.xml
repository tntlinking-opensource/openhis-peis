<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.pay.dao.TongLianProxyMapper">

    <!-- 检查最近是否有未支付订单 -->
    <select id="checkNotPayRecentOrder" resultType="java.lang.Integer">
        SELECT f_feecharged
        FROM md_peispatientcharge
        WHERE patientcode = #{patientCode}
        ORDER BY num_index DESC,
                 createdate DESC LIMIT 1
    </select>


    <!-- 获取体检者表 -->
    <select id="getByPatientCode" resultType="com.center.medical.bean.model.Peispatient">
        SELECT f_feecharged
        FROM md_peispatientcharge
        WHERE patientcode = #{patientCode}
        ORDER BY num_index DESC,
                 createdate DESC LIMIT 1
    </select>


    <!-- 或缺订单部分详情 -->
    <select id="getOrderInfoByPatientCode" resultType="com.center.medical.pay.bean.dto.OrderInfoByPatientCodeDto">
        SELECT id             AS id,
               trade_no       AS tradeno,
               moneyamount    AS price,
               charge_main_id AS chargemainid,
               patientcode    AS patientcode
        FROM md_peispatientcharge
        WHERE patientcode = #{patientCode}
        ORDER BY num_index DESC,
                 createdate DESC LIMIT 1
    </select>


    <!-- 获取支付项目 -->
    <select id="getAllItems" resultType="com.center.medical.pay.bean.dto.AllItemsDto">
        SELECT id                                AS id,
               cast(factprice AS DECIMAL(12, 2)) AS price
        FROM md_peispatientfeeitem
        WHERE id_patient = #{patientCode}
          AND IFNULL(f_feecharged, 0) <![CDATA[ <> ]]> 1
    </select>


    <!-- 获取体检号的最大序列 -->
    <select id="getChargeMaxNumIndex" resultType="java.lang.Integer">
        SELECT max(num_index)
        FROM md_peispatientcharge
        WHERE patientcode = #{patientCode}
    </select>
</mapper>

