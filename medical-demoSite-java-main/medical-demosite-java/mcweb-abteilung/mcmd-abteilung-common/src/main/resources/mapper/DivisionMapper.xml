<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.abteilung.dao.DivisionMapper">

    <!--获取科室列表数据-->
    <select id="getListData" resultType="com.center.medical.abteilung.bean.dto.DivisionDto">
        SELECT d.dept_no as id,
        d.dept_name as name,
        c.sjbggs as sjbggs,
        d.imgpath as imgpath,
        '1' as fExaminated,
        c.jklx as jklx,
        d.english_name,
        d.ksh
        FROM sys_dept d
        INNER JOIN sys_cen_dep c ON c.cid IN
        <foreach collection="cids" item="cid" open="(" close=")" separator=",">
            #{cid}
        </foreach>
        AND c.did = d.dept_no
        INNER JOIN sys_user_dep ud ON ud.user_id = #{userNo}
        AND ud.dep_id = d.dept_no
        WHERE d.is_function = 1
        AND d.del_flag = 0
        GROUP BY d.dept_no
        ORDER BY c.xh
    </select>

    <!--获取科室列表数据有体检码-->
    <select id="getListDataByCode" resultType="com.center.medical.abteilung.bean.dto.DivisionDto">
        SELECT d.dept_no                                                                       as id,
               d.dept_name                                                                     as name,
               c.sjbggs                                                                        as sjbggs,
               d.imgpath                                                                       as imgpath,
               IFNULL(min(CASE WHEN i.f_examinated IS NULL THEN 0 ELSE i.f_examinated END), 0) as fExaminated,
               c.jklx                                                                          as jklx,
               c.xh,
               d.english_name
        FROM sys_dept d
                 INNER JOIN sys_cen_dep c ON c.cid IN (SELECT branch_id
                                                       FROM sys_user_branch
                                                       WHERE user_id = #{userNo})
            AND c.did = d.dept_no
                 INNER JOIN sys_user_dep ud ON ud.user_id = #{userNo}
            AND ud.dep_id = d.dept_no
                 INNER JOIN md_peispatientfeeitem i ON i.id_ks = d.dept_no
        WHERE i.id_patient = #{patientCode}
          AND d.is_function = 1
          AND d.del_flag = 0
          AND i.f_giveup != 1
            AND ( i.sfjj IS NULL OR i.sfjj = 0 )
            AND i.change_item != 1
            AND i.f_feecharged = 1
            AND i.f_transferedhl7 IS NULL
        GROUP BY
            d.dept_no,
            d.dept_name,
            c.sjbggs,
            d.imgpath,
            c.jklx,
            c.xh
        ORDER BY
            c.xh
    </select>


    <!--查看列队数据(职业性问诊单独用getpatientdata)-->
    <select id="getRankData" resultType="com.center.medical.abteilung.bean.vo.RankDataVo">
        SELECT
        DISTINCT p.id,
        p.patientname,
        p.patientcode,
        p.id_sex as idSex,
        p.age,
        pt.patient_name as idPatientclass,
        p.id_examtype as idExamtype,
        p.phone,
        m.is_audit as status,
        group_concat( CASE WHEN I.F_GIVEUP = 1 THEN I.EXAMFEEITEM_NAME ELSE NULL END, '、' ) AS qjxm,
        group_concat( CASE WHEN I.F_DELAYED = 1 THEN I.EXAMFEEITEM_NAME ELSE NULL END, '、' ) AS cjxm,
        group_concat( CASE WHEN I.F_TRANSFEREDHL7 IS NOT NULL THEN I.EXAMFEEITEM_NAME ELSE NULL END, '、' ) AS bjxm,
        IFNULL(m.conclusions,m.zy_conclusions) as conclusions,
        max(two.posistive) as posistive
        FROM
        md_peispatient p
        LEFT JOIN md_patienttype pt ON pt.id = p.id_patientclass
        LEFT JOIN md_section_result_main m ON m.dep_id = #{param.ksID}
        AND m.patientcode = p.patientcode
        INNER JOIN md_peispatientfeeitem i ON i.id_ks = #{param.ksID}
        AND i.id_patient = p.patientcode
        AND ( i.sfjj IS NULL OR i.sfjj = 0 )
        AND ( i.change_item IS NULL OR i.change_item = 0 )
        AND i.f_feecharged = 1
        LEFT JOIN md_section_result_two two ON m.id = two.main_id
        AND two.division_id = #{param.ksID}
        <where>
            p.f_registered = 1
            <if test="param.dependBy!=null and param.dependBy == 'true'">
                AND m.audit_name LIKE concat('%',#{param.userName},'%')
            </if>
            <if test="param.status!=null and param.status != ''">
                <choose>
                    <when test="param.status == 0">
                        AND(m.is_audit is null or m.is_audit=0)
                    </when>
                    <otherwise>
                        AND m.is_audit=1
                    </otherwise>
                </choose>
            </if>
            <if test="param.idPatientclass!=null and param.idPatientclass != ''">
                AND p.id_patientclass = #{param.idPatientclass}
            </if>
            <if test="param.idExamtype!=null and param.idExamtype != ''">
                AND p.id_examtype = #{param.idExamtype}
            </if>
            <if test="param.sex!=null and param.sex != ''">
                AND p.id_sex = #{param.sex}
            </if>
            <if test="param.patientcode!=null and param.patientcode != ''">
                AND p.patientcode LIKE concat('%',#{param.patientcode},'%')
            </if>
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.posistive!=null">
                <if test="param.posistive == 0">
                    AND ( posistive = 0 OR posistive is null )
                </if>
                <if test="param.posistive == 1">
                    AND posistive = 1
                </if>
            </if>
            <if test="param.patientname!=null and param.patientname != ''">
                AND p.patientname LIKE concat('%',#{param.patientname},'%')
            </if>
        </where>
        GROUP BY
        p.id,
        p.patientname,
        p.patientcode,
        p.id_sex,
        p.age,
        pt.patient_name,
        p.id_examtype,
        p.phone,
        m.is_audit
        ORDER BY
        IFNULL ( m.is_audit, 0 ) ASC,
        p.patientcode ASC
    </select>


    <!--c13读卡查询数据-->
    <select id="C13NkdataDto" resultType="com.center.medical.abteilung.bean.dto.GetC13dataDto">
        SELECT
        i.examfeeitem_name AS sfxmmc,
        e.examitem_name AS jcxmmc,
        i.id AS sfxmId,
        e.id AS tjxmId,
        s.id AS tzcId,
        c.id AS jlcId,
        <choose>
            <when test="tjlx!=null and tjlx== 0">
                (s.body_detail) AS jcmc,
            </when>
            <otherwise>
                (s.body_detail_zy) AS jcmc,
            </otherwise>
        </choose>
        c.name AS jlcmc,
        (
        CASE
        s.is_default
        WHEN 1 THEN
        'morenxuanzhong' ELSE 'morenbuxuanzhong'
        END
        ) AS mrxz,
        (
        CASE
        e.is_name
        WHEN 1 THEN
        'shiin' ELSE 'founotin'
        END
        ) AS jcxmjxj,
        (
        CASE
        s.is_in_summary
        WHEN 1 THEN
        'tzcfounotin' ELSE 'tzcshiin'
        END
        ) AS tzcjxj,
        (
        group_concat( hc.str, '@' )
        ) AS str,
        IFNULL ( e.is_desc, 0 ) AS isDesc,
        (
        CASE
        e.f_entryonly
        WHEN 1 THEN
        'shuru' ELSE 'gouxuan'
        END
        ) as fEntryonly,
        IFNULL ( s.intensive_level, 0 ) AS intensiveLevel,
        s.name AS sName
        FROM
        md_peispatientfeeitem p
        INNER JOIN md_items i ON i.id = p.id_examfeeitem
        INNER JOIN md_inspect_charge ch ON ch.charge_id = i.id
        INNER JOIN md_basexamltem e ON e.id = ch.inspect_id
        LEFT JOIN md_basexamltem_sign s ON s.inspect_id = e.id
        LEFT JOIN md_basconclusion c ON s.result_id = c.id
        LEFT JOIN (
        SELECT
        iss.id AS isid,
        es.id AS esid,
        ss.other_mutex,
        ss.num_mutex,
        (
        group_concat( iss.examfeeitem_name || ':' || es.examitem_name || ':' || ss.NAME, '@' ) ) AS str
        FROM
        md_items iss
        INNER JOIN md_inspect_charge chs ON chs.charge_id = iss.id
        AND chs.is_delete = 0
        INNER JOIN md_basexamltem es ON es.id = chs.inspect_id
        INNER JOIN md_basexamltem_sign ss ON ss.inspect_id = es.id
        AND ( ss.is_delete IS NULL OR ss.is_delete = 0 )
        GROUP BY
        iss.id,
        es.id,
        iss.examfeeitem_name,
        es.examitem_name,
        ss.other_mutex,
        ss.num_mutex
        ) hc ON hc.isid = i.id
        AND hc.esid = e.id
        AND (
        hc.other_mutex != s.other_mutex
        OR ( hc.num_mutex != 0 AND s.num_mutex != 0 AND hc.num_mutex = s.num_mutex )
        )
        WHERE
        p.id_patient = #{tjh}
        AND p.id_ks = #{ksId}
        AND ( s.is_delete IS NULL OR s.is_delete = 0 )
        AND e.is_delete = 0
        AND ch.is_delete = 0
        AND p.f_transferedhl7 IS NULL
        AND p.change_item = 0
        GROUP BY
        i.examfeeitem_name,
        e.examitem_name,
        i.id,
        e.id,
        s.id,
        c.id,
        i.examfeeitem_name,
        e.examitem_name,
        s.body_detail,
        c.NAME,
        s.is_default,
        e.is_name,
        s.is_in_summary,
        e.is_desc,
        s.NAME,
        ch.order_index,
        s.orderindex,
        s.body_detail_zy,
        e.f_entryonly,
        s.intensive_level
        ORDER BY
        i.id,
        ch.order_index,
        e.id,
        s.orderindex,
        s.id
    </select>

    <!--查看档案 体检者列表数据-->
    <select id="getArchiveData" resultType="com.center.medical.abteilung.bean.vo.ArchiveDataVo">
        SELECT total.patientcode,
               total.severedegree,
               total.patientname,
               STR_TO_DATE(total.medicaldate, '%Y-%m-%d') AS medicaldate,
               total.note,
               total.patientarchiveno
        FROM (
                 SELECT p.patientcode,
                        '' severedegree,
                        p.patientname,
                        p.medicaldate,
                        p.note,
                        pa.patientarchiveno,
                        p.createdate
                 FROM md_peispatient p
                          INNER JOIN md_peispatientarchive pa ON pa.patientarchiveno = p.patientarchiveno
                 UNION ALL
                 SELECT ph.patientcode,
                        '' severedegree,
                        ph.patientname,
                        ph.medicaldate,
                        ph.note,
                        pah.patientarchiveno,
                        ph.createdate
                 FROM md_peispatienthistory ph
                          INNER JOIN md_peispatientarchive pah ON pah.id = ph.id_patientarchive
             ) total
        WHERE total.patientarchiveno = #{patientarchiveno}
        ORDER BY TOTAL.CREATEDATE DESC
    </select>


    <!--查看档案右侧数据,科室医师小结等-->
    <select id="getResultData" resultType="com.center.medical.abteilung.bean.vo.ResultDataVo">
        SELECT d.dept_name AS deptName,
               u.user_name AS userName,
               m.conclusions
        FROM md_section_result_main m
                 LEFT JOIN sys_dept d ON d.dept_no = m.dep_id
                 LEFT JOIN sys_user u ON u.user_no = m.rummager_id
        WHERE m.patientcode = #{patientcode}
          AND (m.rummager_id IS NOT NULL OR m.associative_table IN ('pacs_result', 'peispatientexamitem'))
        ORDER BY m.createdate DESC
    </select>


    <!--我要提醒-获取科室 没有传体检号-->
    <select id="getRemindKs" resultType="com.center.medical.abteilung.bean.vo.RemindKsVo">
        SELECT d.dept_no   as id,
               d.dept_name as name,
               c.sjbggs,
               d.imgpath,
               '1'         as fExaminated,
               c.jklx      as jklx
        FROM sys_dept d
                 INNER JOIN sys_cen_dep c ON c.cid = #{cId}
            AND c.did = d.dept_no
                 INNER JOIN sys_user_dep ud ON ud.user_id = #{userNo}
            AND ud.dep_id = d.dept_no
        WHERE d.is_function = 1
          AND d.del_flag = 0
        ORDER BY c.xh
    </select>

    <!--我要提醒-获取科室 有传体检号-->
    <select id="getRemindKsByCode" resultType="com.center.medical.abteilung.bean.vo.RemindKsVo">
        SELECT
        d.dept_no as id,
        d.dept_name as name,
        c.sjbggs,
        d.imgpath,
        min( CASE WHEN i.f_examinated IS NULL THEN 0 ELSE i.f_examinated END ) as fExaminated,
        c.jklx,
        c.xh
        FROM
        sys_dept d
        INNER JOIN sys_cen_dep c ON c.cid = #{cId}
        AND c.did = d.dept_no
        INNER JOIN sys_user_dep ud ON ud.user_id = #{userNo}
        AND ud.dep_id = d.dept_no
        INNER JOIN md_peispatientfeeitem i ON i.id_ks = d.dept_no
        <where>
            i.id_patient = #{patientcode}
            AND d.is_function = 1
            AND d.del_flag = 0
            AND i.f_giveup != 1
            AND ( i.sfjj IS NULL OR i.sfjj = 0 )
            AND i.change_item != 1
            AND i.f_feecharged = 1
            AND i.f_transferedhl7 IS NULL
        </where>
        GROUP BY
        d.dept_no,
        d.dept_name,
        c.sjbggs,
        d.imgpath,
        c.jklx,
        c.xh
        ORDER BY
        c.xh
    </select>

    <!--获取内科页面收费项目检查项目数据-->
    <select id="getNkdata" resultType="com.center.medical.abteilung.bean.dto.GetC13dataDto">
        SELECT
        i.examfeeitem_name AS sfxmmc,
        e.examitem_name AS jcxmmc,
        i.id AS sfxmId,
        e.id AS tjxmId,
        s.id AS tzcId,
        c.id AS jlcId,
        <if test="tjlx!=null and tjlx!=''">
            <choose>
                <when test="tjlx == 0">
                    s.body_detail AS jcmc,
                </when>
                <otherwise>
                    s.body_detail_zy AS jcmc,
                </otherwise>
            </choose>
        </if>
        c.name AS jlcmc,
        (
        CASE
        s.is_default
        WHEN 1 THEN
        'morenxuanzhong' ELSE 'morenbuxuanzhong'
        END
        ) AS mrxz,
        (
        CASE
        e.is_name
        WHEN 1 THEN
        'shiin' ELSE 'founotin'
        END
        ) AS jcxmjxj,
        (
        CASE
        s.is_in_summary
        WHEN 1 THEN
        'tzcfounotin' ELSE 'tzcshiin'
        END
        ) AS tzcjxj,
        (
        group_concat( hc.str, '@' )
        ) AS hcfz,
        IFNULL ( e.is_desc, 0 ) AS isDesc,
        (
        CASE
        e.f_entryonly
        WHEN 1 THEN
        'shuru' ELSE 'gouxuan'
        END
        ) as fEntryonly,
        IFNULL ( s.intensive_level, 0 ) AS intensiveLevel,
        s.name AS sName
        FROM
        md_peispatientfeeitem p
        INNER JOIN md_items i ON i.id = p.id_examfeeitem
        INNER JOIN md_inspect_charge ch ON ch.charge_id = i.id
        INNER JOIN md_basexamltem e ON e.id = ch.inspect_id
        LEFT JOIN md_basexamltem_sign s ON s.inspect_id = e.id
        LEFT JOIN md_basconclusion c ON s.result_id = c.id
        LEFT JOIN (
        SELECT
        iss.id AS isid,
        es.id AS esid,
        ss.other_mutex,
        ss.num_mutex,
        (
        group_concat( iss.examfeeitem_name || ':' || es.examitem_name || ':' || ss.NAME, '@' ) ) AS str
        FROM
        md_items iss
        INNER JOIN md_inspect_charge chs ON chs.charge_id = iss.id
        AND chs.is_delete = 0
        INNER JOIN md_basexamltem es ON es.id = chs.inspect_id
        INNER JOIN md_basexamltem_sign ss ON ss.inspect_id = es.id
        AND ( ss.is_delete IS NULL OR ss.is_delete = 0 )
        GROUP BY
        iss.id,
        es.id,
        iss.examfeeitem_name,
        es.examitem_name,
        ss.other_mutex,
        ss.num_mutex
        ) hc ON hc.isid = i.id
        AND hc.esid = e.id
        AND (
        hc.other_mutex != s.other_mutex
        OR ( hc.num_mutex != 0 AND s.num_mutex != 0 AND hc.num_mutex = s.num_mutex )
        )
        WHERE
        p.id_patient = #{tjh}
        AND p.id_ks = #{ksId}
        AND ch.is_delete = 0
        AND s.is_delete = 0
        AND e.is_delete = 0
        AND p.change_item = 0
        AND(p.sfjj IS NULL OR p.sfjj=0)
        AND p.f_giveup=0 AND p.f_feecharged=1
        AND p.f_transferedhl7 IS NULL
        GROUP BY
        i.examfeeitem_name,
        e.examitem_name,
        i.id,
        e.id,
        s.id,
        c.id,
        i.examfeeitem_name,
        e.examitem_name,
        s.body_detail,
        c.NAME,
        s.is_default,
        e.is_name,
        s.is_in_summary,
        e.is_desc,
        s.NAME,
        ch.order_index,
        s.orderindex,
        s.body_detail_zy,
        s.intensive_level,
        i.xh
        ORDER BY
        i.xh ,
        i.id,
        ch.order_index,
        e.id,
        s.orderindex,
        s.id
    </select>


    <!--科室加项左侧数据，创建套餐获取基础数据收费项目-->
    <select id="getSfxm" resultType="com.center.medical.data.bean.vo.SfxmVo">
        SELECT
        i.id,
        i.examfeeitem_name AS sfxmmc,
        i.sfxmsrm,
        i.xb,
        i.jcyy,
        i.unitprice AS jg,
        i.bz,
        i.tjlx,
        i.depart_name AS ssks,
        i.id_depart AS idKs,
        i.jccs AS sycstj,
        i.f_discountdisabled,
        pt.print_name AS xsdyfl,
        pt.shunxu AS dysx,
        i.costprice
        FROM
        md_items i
        LEFT JOIN md_printtype pt ON pt.id = i.xsdyfl
        LEFT JOIN md_items_and_fzx iaf ON iaf.items_id = i.id
        <where>
            i.is_delete = 0
            AND (
            i.is_ban IS NULL
            OR i.is_ban =0 )
            <if test="param.examfeeitemName!=null and param.examfeeitemName!=''">
                AND i.examfeeitem_name like concat('%',#{param.examfeeitemName},'%')
            </if>
            <if test="param.sfxmsrm!=null and param.sfxmsrm!=''">
                AND i.sfxmsrm like concat('%',#{param.sfxmsrm},'%')
            </if>
            <if test="param.syxb!=null and param.syxb!=''">
                <if test="param.syxb == 0">
                    AND i.xb IN ('0','2')
                </if>
                <if test="param.syxb == 1">
                    AND i.xb IN ('1','2')
                </if>
                <if test="param.syxb == 2">
                    AND i.xb ='2'
                </if>
            </if>
            <if test="param.tjlx!=null and param.tjlx!=''">
                <if test="param.tjlx == 0">
                    AND i.tjlx IN ('0','2')
                </if>
                <if test="param.tjlx == 1">
                    AND i.tjlx = #{param.tjlx}
                </if>
                <if test="param.tjlx == 2">
                    AND i.tjlx IN ('0','1','2')
                </if>
            </if>
            <if test="param.fzxid!=null">
                AND iaf.fzx_id IN
                <foreach collection="param.fzxid" item="fzx" open="(" close=")" separator=",">
                    #{fzx}
                </foreach>
            </if>
            <if test="param.addItem != null and param.addItem == 1">
                AND i.unitprice > 0
            </if>
            <if test="param.syxbValue!=null and param.syxbValue!=''">
                <if test="param.syxbValue == 0">
                    AND i.xb IN ('0','2')
                </if>
                <if test="param.syxbValue == 1">
                    AND i.xb IN ('1','2')
                </if>
                <if test="param.syxbValue == 2">
                    AND i.xb ='2'
                </if>
            </if>
            <if test="param.tjValue!=null and param.tjValue!=''">
                <if test="param.tjValue == 0">
                    AND i.tjlx IN ('0','2')
                </if>
                <if test="param.tjValue == 1">
                    AND i.tjlx = #{param.tjValue}
                </if>
                <if test="param.tjValue == 2">
                    AND i.tjlx IN ('0','1','2')
                </if>
            </if>
        </where>
        GROUP BY
        i.id,
        i.examfeeitem_name,
        i.sfxmsrm,
        i.xb,
        i.jcyy,
        i.unitprice,
        i.bz,
        i.tjlx,
        i.depart_name,
        i.id_depart,
        i.jccs,
        i.f_discountdisabled,
        pt.print_name,
        pt.shunxu,
        i.costprice
    </select>


    <!--科室加项左侧数据，创建套餐获取基础数据收费项目-->
    <select id="getPatientData" resultType="com.center.medical.abteilung.bean.vo.PatientDataVo">
        SELECT
        DISTINCT p.id,
        p.patientcode,
        p.id_sex,
        pc.is_audit,
        p.patientname
        FROM
        md_peispatient p
        LEFT JOIN md_peispatient_consultation pc ON pc.patientcode = p.patientcode
        INNER JOIN md_peispatientfeeitem i ON i.id_ks = #{param.ksID}
        AND i.id_patient = p.patientcode
        AND ( i.f_giveup IS NULL OR i.f_giveup = 0 )
        AND ( i.sfjj IS NULL OR i.sfjj = 0 )
        AND ( i.change_item IS NULL OR i.change_item = 0 )
        AND i.f_feecharged = 1
        AND i.f_transferedhl7 IS NULL
        <where>
            p.f_registered = 1
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endTime}
            </if>
        </where>
        ORDER BY IFNULL(pc.is_audit,0) ASC,
        p.patientcode ASC
    </select>


    <!--科室加项左侧数据，创建套餐获取基础数据收费项目-->
    <select id="getRemindPatient" resultType="com.center.medical.abteilung.bean.vo.RemindPatientVo">
        SELECT
        p.patientcode,
        p.patientname,
        group_concat(DISTINCT r.dep_name ) AS depName
        FROM
        md_section_remind r
        INNER JOIN md_peispatient p ON p.patientcode = r.patientcode
        INNER JOIN md_section_and_remind sar ON sar.remind_id = r.id
        <where>
            1 = 1
            <choose>
                <when test="param.ksID != null and param.ksID !=''">
                    AND sar.dep_id = #{param.ksID}
                </when>
                <otherwise>
                    AND p.f_readytofinal = 1
                </otherwise>
            </choose>
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.patientcode != null and param.patientcode !=''">
                AND p.patientcode LIKE #{param.patientcode}
            </if>
        </where>
        GROUP BY
        p.patientcode,p.patientname
        ORDER BY
        p.patientcode DESC
    </select>


    <!--普通预览科室报告-->
    <select id="diagnosticHead" resultType="com.center.medical.abteilung.bean.dto.DiagnosticHeadDto">
        SELECT
        p.patientcode,
        p.patientname,
        p.id_sex,
        p.age,
        p.dateregister,
        p.id_marriage,
        pa.patientarchiveno,
        pp.picture,
        cs.khdwmc AS workunit,
        pa.id
        FROM md_peispatient p
        LEFT JOIN crm_sellcustomer cs ON p.id_org = cs.id
        LEFT JOIN md_peispatientarchive pa ON p.patientarchiveno = pa.patientarchiveno
        LEFT JOIN md_peispatient_photo pp ON p.patientcode = pp.patientcode
        <where>
            p.patientcode = #{param.patientcode}
        </where>
    </select>


    <!--查看档案 体检者列表数据 Mysql-->
    <select id="getArchiveDataMysql" resultType="com.center.medical.abteilung.bean.vo.ArchiveDataVo">
        SELECT total.patientcode,
               total.severedegree,
               total.patientname,
               STR_TO_DATE(total.medicaldate, '%Y-%m-%d') AS medicaldate,
               total.note,
               total.patientarchiveno
        FROM (
                 SELECT p.patientcode,
                        '' severedegree,
                        p.patientname,
                        p.medicaldate,
                        p.note,
                        pa.patientarchiveno,
                        p.createdate
                 FROM md_peispatient p
                          INNER JOIN md_peispatientarchive pa ON pa.patientarchiveno = p.patientarchiveno
                 UNION ALL
                 SELECT ph.patientcode,
                        '' severedegree,
                        ph.patientname,
                        ph.medicaldate,
                        ph.note,
                        pah.patientarchiveno,
                        ph.createdate
                 FROM md_peispatienthistory ph
                          INNER JOIN md_peispatientarchive pah ON pah.id = ph.id_patientarchive
             ) total
        WHERE total.patientarchiveno = #{patientarchiveno}
        ORDER BY TOTAL.CREATEDATE DESC
    </select>


    <!--查看档案 体检者列表数据 Oracle-->
    <select id="getArchiveDataOracle" resultType="com.center.medical.abteilung.bean.vo.ArchiveDataVo">
        SELECT
        total.patientcode,
        total.severedegree,
        total.patientname,
        to_char( total.medicaldate, 'yyyy-mm-dd' ) AS medicaldate,
        total.note,
        total.id_patientarchive as patientarchiveno
        FROM
        (
        SELECT
        p.patientcode,
        '' severedegree,
        p.patientname,
        p.medicaldate,
        p.note,
        p.id_patientarchive,
        p.createdate
        FROM
        peispatient p
        INNER JOIN peispatientarchive pa ON p.id_patientarchive = pa.ID UNION ALL
        SELECT
        ph.patientcode,
        '' severedegree,
        ph.patientname,
        ph.medicaldate,
        ph.note,
        ph.id_patientarchive,
        ph.createdate
        FROM
        PEISPATIENT_HIS ph
        INNER JOIN peispatientarchive pah ON pah.id = ph.id_patientarchive
        ) total
        WHERE
        total.id_patientarchive in
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        ORDER BY
        TOTAL.CREATEDATE DESC
    </select>


    <!--查看档案右侧数据,科室医师小结等-->
    <select id="getResultDataOracle" resultType="com.center.medical.abteilung.bean.vo.ResultDataVo">
        SELECT d.name     AS deptName,
               u.username AS userName,
               m.conclusions
        FROM section_result_main m
                 LEFT JOIN QX_DEPARTMENT d ON d.id = m.dep_id
                 LEFT JOIN QX_USERS u ON u.id = m.rummager_id
        WHERE m.patientcode = #{patientcode}
          AND (m.rummager_id IS NOT NULL OR m.associative_table IN ('PACS_RESULT', 'PEISPATIENTEXAMITEM'))
        ORDER BY m.createdate DESC
    </select>
</mapper>

