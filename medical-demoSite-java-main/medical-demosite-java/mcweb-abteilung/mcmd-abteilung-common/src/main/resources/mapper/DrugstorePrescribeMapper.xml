<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.abteilung.dao.DrugstorePrescribeMapper">

    <resultMap type="com.center.medical.abteilung.bean.model.DrugstorePrescribe" id="DrugstorePrescribeMap">
        <id property="id" column="id"/>
        <result property="createdate" column="createdate"/>
        <result property="modifydate" column="modifydate"/>
        <result property="drugId" column="drug_id"/>
        <result property="username" column="username"/>
        <result property="patientcode" column="patientcode"/>
        <result property="reason" column="reason"/>
        <result property="prescribeTime" column="prescribe_time"/>
        <result property="prescribeNum" column="prescribe_num"/>
        <result property="transactionPrice" column="transaction_price"/>
        <result property="isFinished" column="is_finished"/>
        <result property="prescribeNote" column="prescribe_note"/>
    </resultMap>

    <!-- 数据表字段属性 -->
    <sql id="selectDrugstorePrescribeVo">
        select id,
               createdate,
               modifydate,
               drug_id,
               username,
               patientcode,
               reason,
               prescribe_time,
               prescribe_num,
               transaction_price,
               is_finished,
               prescribe_note
        from md_drugstore_prescribe
    </sql>

    <!-- 查询列表数据 -->
    <select id="getList" resultType="com.center.medical.abteilung.bean.vo.DrugstorePreVo">
        SELECT
        dp.id,
        p.patientname,
        p.phone,
        dp.username,
        STR_TO_DATE ( dp.prescribe_time, '%Y-%m-%d' ) as prescribeTime,
        d.drug_name,
        dp.is_finished,
        dp.reason,
        dp.transaction_price as price,
        dp.prescribe_note as note,
        dp.prescribe_num as prescribeNum,
        d.drug_standard as drugStandard,
        d.drug_price as drugPrice
        FROM
        md_drugstore_prescribe dp
        INNER JOIN md_drugstore_drug d ON d.id = dp.drug_id
        INNER JOIN md_peispatient p ON p.patientcode = dp.patientcode
        <where>
            1 = 1
            <if test="param.patientname!=null and param.patientname!=''">
                AND p.patientname LIKE concat('%',#{param.patientname},'%')
            </if>
            <if test="param.username!=null and param.username!=''">
                AND dp.username = #{param.username}
            </if>
            <if test="param.startTime!=null">
                AND dp.prescribe_time <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND dp.prescribe_time <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.drugId!=null and param.drugId!=''">
                AND dp.drug_id = #{param.drugId}
            </if>
            <if test="param.phone!=null and param.phone!=''">
                AND p.phone LIKE concat('%',#{param.phone},'%')
            </if>
            <if test="param.isFinished!=null and param.isFinished!=''">
                AND dp.is_finished = #{param.isFinished}
            </if>
        </where>
        ORDER BY
        ( CASE WHEN dp.is_finished = 2 THEN 1 WHEN dp.is_finished = 1 THEN 2 ELSE dp.is_finished END ) ASC,
        dp.transaction_price DESC
    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultMap="DrugstorePrescribeMap">
        <include refid="selectDrugstorePrescribeVo"/>
        <where>
            id = #{id}
        </where>
    </select>

    <!-- 分页查询药房管理售药统计 -->
    <select id="getStatisticsListData" resultType="com.center.medical.abteilung.bean.vo.DrugstorePreVo">
        SELECT
        dp.username,
        p.patientname,
        p.phone,
        d.drug_name,
        STR_TO_DATE ( dp.prescribe_time, '%Y-%m-%d %T' ) AS prescribeTime,
        (d.cost_price * dp.prescribe_num) AS costPrice,
        dp.transaction_price AS price,
        dp.is_finished,
        p.patientcode
        FROM
        md_drugstore_prescribe dp
        INNER JOIN md_drugstore_drug d ON d.id = dp.drug_id
        INNER JOIN md_peispatient p ON p.patientcode = dp.patientcode
        <where>
            dp.is_finished > 0
            <if test="param.patientname!=null and param.patientname!=''">
                AND p.patientname LIKE concat('%',#{param.patientname},'%')
            </if>
            <if test="param.username!=null and param.username!=''">
                AND dp.username = #{param.username}
            </if>
            <if test="param.startTime!=null">
                AND dp.prescribe_time <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND dp.prescribe_time <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.drugId!=null and param.drugId!=''">
                AND dp.drug_id = #{param.drugId}
            </if>
            <if test="param.phone!=null and param.phone!=''">
                AND p.phone LIKE concat('%',#{param.phone},'%')
            </if>
            <if test="param.isFinished!=null and param.isFinished!=''">
                AND dp.is_finished = #{param.isFinished}
            </if>
        </where>
        ORDER BY dp.is_finished ASC,dp.transaction_price DESC
    </select>


    <!-- 获取导出数据 -->
    <select id="getExportData" resultType="com.center.medical.abteilung.bean.vo.DrugstorePreVo">
        SELECT
        dp.username,
        p.patientname,
        p.phone,
        d.drug_name as drugName,
        STR_TO_DATE( dp.prescribe_time, '%Y-%m-%d %T' ) as prescribeTime,
        d.cost_price * dp.prescribe_num as costPrice,
        dp.transaction_price as price,
        dp.is_finished as isFinished,
        p.patientcode as patientcode,
        sum( d.cost_price * dp.prescribe_num ) as SumCostPrice,
        sum( dp.transaction_price ) as SumPrice
        FROM
        md_drugstore_prescribe dp
        INNER JOIN md_drugstore_drug d ON d.id = dp.drug_id
        INNER JOIN md_peispatient p ON p.patientcode = dp.patientcode
        <where>
            dp.is_finished > 0
            <if test="param.patientname!=null and param.patientname!=''">
                AND p.patientname LIKE concat('%',#{param.patientname},'%')
            </if>
            <if test="param.username!=null and param.username!=''">
                AND dp.username = #{param.username}
            </if>
            <if test="param.startTime!=null">
                AND dp.prescribe_time <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND dp.prescribe_time <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.drugId!=null and param.drugId!=''">
                AND dp.drug_id = #{param.drugId}
            </if>
            <if test="param.phone!=null and param.phone!=''">
                AND p.phone LIKE concat('%',#{param.phone},'%')
            </if>
            <if test="param.isFinished!=null and param.isFinished!=''">
                AND dp.is_finished = #{param.isFinished}
            </if>
        </where>
        ORDER BY dp.is_finished ASC,dp.transaction_price DESC
    </select>


    <!-- 快捷开药-右侧-获得已开药记录 -->
    <select id="getAddedData" resultType="com.center.medical.abteilung.bean.vo.DrugstorePreVo">
        SELECT p.id,
               p.drug_id,
               p.username,
               p.reason,
               p.prescribe_time,
               p.prescribe_num,
               p.is_finished,
               d.drug_name
        FROM md_drugstore_prescribe p
                 INNER JOIN md_drugstore_drug d ON d.id = p.drug_id
        WHERE p.patientcode = #{patientcode}
        ORDER BY p.is_finished DESC,
                 (
                     CASE

                         WHEN p.username = #{username} THEN
                             1
                         ELSE 0
                         END
                     ) ASC,
                 p.username ASC,
                 p.prescribe_time DESC
    </select>


    <!-- 获取上次体检开的什么药 -->
    <select id="getLastDrugs" resultType="string">
        SELECT max(p.patientcode)
        FROM md_peispatient p
        WHERE p.patientcode != #{patientcode}
          AND p.patientarchiveno = #{patientarchiveno}
          AND EXISTS (
            SELECT
            1
            FROM
            md_drugstore_prescribe dp
            WHERE
            dp.patientcode = p.patientcode)
    </select>
</mapper>

