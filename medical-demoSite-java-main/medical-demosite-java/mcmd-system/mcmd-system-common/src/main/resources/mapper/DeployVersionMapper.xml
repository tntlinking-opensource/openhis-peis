<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.system.dao.DeployVersionMapper">

    <resultMap type="com.center.medical.system.bean.model.DeployVersion" id="DeployVersionMap">
        <id property="id" column="id"/>
        <result property="createdate" column="createdate"/>
        <result property="modifydate" column="modifydate"/>
        <result property="versionNumber" column="version_number"/>
        <result property="versionName" column="version_name"/>
        <result property="executeTime" column="execute_time"/>
        <result property="notes" column="notes"/>
        <result property="updateType" column="update_type"/>
        <result property="filePath" column="file_path"/>
        <result property="updateSql" column="update_sql"/>
        <result property="isDelete" column="is_delete"/>
        <result property="modifier" column="modifier"/>
        <result property="creator" column="creator"/>
        <result property="isEnable" column="is_enable"/>
    </resultMap>

    <!-- 数据表字段属性 -->
    <sql id="selectDeployVersionVo">
        select sdv.id,
               sdv.createdate,
               sdv.modifydate,
               sdv.version_number,
               sdv.version_name,
               sdv.execute_time,
               sdv.notes,
               sdv.update_type,
               sdv.file_path,
               sdv.update_sql,
               sdv.is_delete,
               sdv.modifier,
               sdv.creator,
               sdv.is_enable
        from sys_deploy_version sdv
    </sql>

    <!-- 查询列表数据 -->
    <select id="getPage" resultMap="DeployVersionMap">
        <include refid="selectDeployVersionVo"/>
        where
        sdv.is_delete=0
        <if test="param.updateType!=null">
            and sdv.update_type=#{param.updateType}
        </if>
        <if test="param.versionNumber!=null">
            and instr(sdv.version_number,#{param.versionNumber})>0
        </if>
        <if test="param.versionName!=null">
            and instr(sdv.version_name,#{param.versionName})>0
        </if>
        order by sdv.createdate desc
    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultMap="DeployVersionMap">
        <include refid="selectDeployVersionVo"/>
        <where>
            id = #{id}
        </where>
    </select>

    <!-- 根据更新类型查询最新的需要更新的版本 -->
    <select id="getVersion" resultMap="DeployVersionMap">
        <include refid="selectDeployVersionVo"/>
        where
        sdv.is_delete=0
        and sdv.is_enable=1
        and exists( select 1 from sys_deploy_version_branch sdvb where sdvb.version_id=sdv.id and sdvb.is_delete=0 and
        (sdvb.is_sql_updated=1 or sdv.update_sql is null))
        and sdv.execute_time <![CDATA[ <= ]]> sysdate()
        and sdv.update_type= #{updateType}
        and sdv.file_path is not null
        order by sdv.version_number desc
        limit 1
    </select>

</mapper>
