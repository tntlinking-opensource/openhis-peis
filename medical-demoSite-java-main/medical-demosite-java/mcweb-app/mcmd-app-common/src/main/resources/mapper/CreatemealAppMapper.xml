<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.appadmin.dao.CreatemealAppMapper">

    <resultMap type="com.center.medical.appadmin.bean.model.CreatemealApp" id="CreatemealAppMap">
        <id property="id" column="id"/>
        <result property="tcid" column="tcid"/>
        <result property="type" column="type"/>
        <result property="thumbnail" column="thumbnail"/>
        <result property="label" column="label"/>
        <result property="imgUrl" column="img_url"/>
        <result property="content" column="content"/>
        <result property="bz" column="bz"/>
        <result property="status" column="status"/>
        <result property="seq" column="seq"/>
        <result property="isDelete" column="is_delete"/>
        <result property="createdate" column="createdate"/>
        <result property="modifydate" column="modifydate"/>
        <result property="appTcmc" column="app_tcmc"/>
    </resultMap>

    <!-- 数据表字段属性 -->
    <sql id="selectCreatemealAppVo">
        select id,
               tcid,
               type,
               thumbnail,
               label,
               img_url,
               content,
               bz,
               status,
               seq,
               is_delete,
               createdate,
               modifydate,
               app_tcmc
        from md_createmeal_app
    </sql>

    <!-- 查询列表数据 -->
    <select id="getPage" resultType="com.center.medical.appadmin.bean.vo.CreatemealAppVo">
        SELECT
            ca.id,
            ca.tcid,
            ca.type,
            cat.NAME AS typeName,
            ca.thumbnail,
            ca.bz,
            ca.status,
            ca.seq,
            ca.label,
            cm.tjtcmc,
            cm.tcysjg,
            cm.zhjg,
            cm.is_ban,
            group_concat( sb.fzx ) AS fzxName,
            group_concat( maf.fzxid ) AS fzxId,
            ca.app_tcmc
        FROM
            md_createmeal_app ca
                LEFT JOIN md_createmeal_app_type cat ON cat.id = ca.type
                LEFT JOIN md_createcombo cm ON cm.id = ca.tcid
                LEFT JOIN md_comboandfzx maf ON maf.tcid = cm.id
                LEFT JOIN sys_branch sb ON sb.branch_id = maf.fzxid
        <where>
            ca.is_delete = 0
            AND cm.is_delete = 0
            <if test="param.tcmc!=null and param.tcmc!=''">
                AND cm.tjtcmc like concat('%',#{param.tcmc},'%')
            </if>
            <if test="param.type!=null">
                AND ca.type = #{param.type}
            </if>
            <if test="param.status!=null">
                AND ca.status = #{param.status}
            </if>
        </where>
        GROUP BY
            ca.id
        ORDER BY
            ca.createdate DESC
    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultType="com.center.medical.appadmin.bean.model.CreatemealApp">
        SELECT
        ca.id,
        ca.tcid,
        ca.type,
        ca.thumbnail,
        ca.label,
        ca.img_url,
        ca.content,
        ca.bz,
        ca.STATUS,
        ca.seq,
        ca.is_delete,
        ca.createdate,
        ca.modifydate,
        ca.app_tcmc,
        cat.NAME AS typeName
        FROM
        md_createmeal_app ca
        LEFT JOIN md_createmeal_app_type cat ON cat.id = ca.type
        <where>
            ca.id = #{id}
        </where>
    </select>



    <!-- 获取套餐列表 -->
    <select id="getMealList" resultType="com.center.medical.appadmin.bean.vo.GetMealListVo">
        SELECT
        ca.id,
        ca.type,
        cat.NAME AS typeName,
        ca.thumbnail,
        ca.seq,
        ca.app_tcmc as tjtcmc,
        cm.tcysjg,
        cm.zhjg,
        ca.label
        FROM
        md_createmeal_app ca
        LEFT JOIN md_createmeal_app_type cat ON cat.id = ca.type
        LEFT JOIN md_createcombo cm ON cm.id = ca.tcid
        LEFT JOIN md_comboandfzx maf ON maf.tcid = cm.id
        <where>
            ca.is_delete = 0
            AND ca.status = 1
            AND cm.is_delete = 0
            AND (cm.is_ban = 0 or cm.is_ban is null)
            <if test="param.type!=null">
                AND ca.type = #{param.type}
            </if>
            <if test="param.fzxId!=null and param.fzxId!=''">
                AND maf.fzxid = #{param.fzxId}
            </if>
        </where>
        GROUP BY ca.id
        ORDER BY ca.seq asc
    </select>



    <!-- 获取套餐列表 -->
    <select id="getMealDetails" resultType="com.center.medical.appadmin.bean.vo.GetMealDetailsVo">
        SELECT
        ca.id,
        ca.tcid,
        ca.type,
        cat.NAME AS typeName,
        ca.thumbnail,
        ca.label,
        ca.img_url,
        ca.content,
        ca.app_tcmc as tjtcmc,
        cm.tcysjg,
        cm.zhjg,
        sb.fzx AS fzxName,
        sb.address,
        sb.tel
        FROM
        md_createmeal_app ca
        LEFT JOIN md_createmeal_app_type cat ON cat.id = ca.type
        LEFT JOIN md_createcombo cm ON cm.id = ca.tcid
        LEFT JOIN md_comboandfzx maf ON maf.tcid = cm.id
        LEFT JOIN sys_branch sb ON sb.branch_id = maf.fzxid
        <where>
            ca.is_delete = 0
            AND cm.is_delete = 0
            AND (cm.is_ban = 0 or cm.is_ban is null)
            AND ca.status = 1
            <if test="param.id!=null and param.id!=''">
                AND ca.id = #{param.id}
            </if>
            <if test="param.fzxId!=null and param.fzxId!=''">
                AND maf.fzxid = #{param.fzxId}
            </if>
        </where>
        GROUP BY ca.id
    </select>



    <!-- 获取检查项目数据 -->
    <select id="getMealItems" resultType="com.center.medical.appadmin.bean.dto.MealItemsDto">
        SELECT
            i.id,
            i.examfeeitem_nameprn AS itemName,
            i.jcyy,
            i.unitprice as price,
            p.print_name,
            p.shunxu
        FROM
            md_createcombo m
            INNER JOIN md_comboanditem mai ON mai.tcid = m.id
            INNER JOIN md_items i ON i.id = mai.sfxmid
            LEFT JOIN md_printtype p ON p.id = i.xsdyfl
        WHERE
            m.id = #{id}
        ORDER BY
            p.shunxu,
            p.print_name
    </select>
</mapper>

