<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.finance.dao.IndexSituationMapper">

    <!-- 查询列表数据 -->
    <select id="getList" resultType="com.center.medical.sellcrm.bean.model.Createorder">

    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultType="com.center.medical.sellcrm.bean.model.Createorder">

    </select>

    <!-- 查询产值数据 -->
    <select id="getOutputValue" resultType="com.center.medical.finance.bean.dto.ISDataDto">
        SELECT
        b.fzx,
        ifnull(sum(pi.factprice), 0.0) value
        FROM
        md_peispatientfeeitem pi
        INNER JOIN md_peispatient p on p.patientcode = pi.id_patient
        INNER JOIN sys_branch b ON p.hospitalcode = b.branch_id
        <where>
            pi.f_feecharged = 1
            <if test="time!=null ">
                AND pi.feechargetime <![CDATA[ >= ]]> #{time}
                AND pi.feechargetime <![CDATA[ <= ]]> DATE_FORMAT(#{time}, '%Y-%m-%d 23:59:59')
            </if>
            <if test="includingVaccines == 0">
                AND pi.id_ks <![CDATA[ <> ]]> 'ff8080817bc96399017bd2c73a0c5e96'
            </if>
        </where>
        GROUP BY b.fzx
    </select>


    <!-- 获取收入 团检或个检-->
    <select id="getIncome" resultType="com.center.medical.finance.bean.dto.ISDataDto">
        SELECT
        b.fzx,
        ifnull(sum(pc.moneyamountpaid),0) as `value`
        FROM
        md_peispatientcharge pc
        INNER JOIN md_peispatient p on p.patientcode=pc.patientcode
        INNER JOIN sys_branch b ON b.id=p.hospitalcode AND b.is_show=1
        <where>
            pc.f_feecharged = 1
            <if test="time!=null ">
                AND pc.feechargetime <![CDATA[ >= ]]> #{time}
                AND pc.feechargetime <![CDATA[ <= ]]> DATE_FORMAT(#{time}, '%Y-%m-%d 23:59:59')
            </if>
            <if test="fUsecodehiden!=null">
                AND p.f_usecodehiden = #{fUsecodehiden}
            </if>
        </where>
        GROUP BY b.fzx
    </select>

    <!-- 新单金额-->
    <select id="getNewOrder" resultType="com.center.medical.finance.bean.dto.ISDataDto">
        SELECT
            sum(IFNULL(pcm.moneyamountpaid, 0)) AS `value`,
            b.fzx
        FROM crm_sellcustomer sc
                 INNER JOIN md_createorder co ON co.khdwmcid = sc.id
                 INNER JOIN md_peispatient p ON co.ddh = p.numorgresv
                 INNER JOIN md_peispatient_charge_main pcm ON pcm.patientcode = p.patientcode
                 INNER JOIN sys_branch b ON b.id=p.hospitalcode AND b.is_show = 1
        HAVING COUNT(co.id) = 0
        GROUP BY b.fzx
    </select>

    <!--获取各个分中心的人数-->
    <select id="getPersonCount" resultType="com.center.medical.finance.bean.dto.ISDataDto">
        SELECT
        b.fzx,
        count(p.id) as `value`
        FROM
        md_peispatient p
        INNER JOIN sys_branch b ON b.id=p.hospitalcode AND b.is_show=1
        <where>
            p.f_registered = 1
            <if test="time!=null ">
                AND p.dateregister <![CDATA[ >= ]]> #{time}
                AND p.dateregister <![CDATA[ <= ]]> DATE_FORMAT(#{time}, '%Y-%m-%d 23:59:59')
            </if>
        </where>
        GROUP BY b.fzx
    </select>


    <!-- 疫苗产值 开始 -->
    <select id="getVaccinumValue" resultType="com.center.medical.finance.bean.dto.ISDataDto">
        SELECT
        b.fzx,
        ifnull(sum(pi.factprice), 0.0) value
        FROM
        md_peispatientfeeitem pi
        INNER JOIN md_peispatient p on p.patientcode = pi.id_patient
        INNER JOIN sys_branch b ON p.hospitalcode = b.branch_id
        <where>
            pi.f_feecharged = 1
            <if test="time!=null ">
                AND pi.feechargetime <![CDATA[ >= ]]> #{time}
                AND pi.feechargetime <![CDATA[ <= ]]> DATE_FORMAT(#{time}, '%Y-%m-%d 23:59:59')
            </if>
            AND pi.id_ks = 'ff8080817bc96399017bd2c73a0c5e96'
        </where>
        GROUP BY b.fzx
    </select>
</mapper>

