<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.finance.dao.CardHandleMapper">

    <resultMap type="com.center.medical.finance.bean.model.Card" id="CardMap">
        <id property="id" column="id"/>
        <result property="cardNo" column="card_no"/>
        <result property="balanceLimit" column="balance_limit"/>
        <result property="createdate" column="createdate"/>
        <result property="createId" column="create_id"/>
        <result property="modifydate" column="modifydate"/>
        <result property="modifyId" column="modify_id"/>
        <result property="typeId" column="type_id"/>
        <result property="sellId" column="sell_id"/>
        <result property="sellTime" column="sell_time"/>
        <result property="validity" column="validity"/>
        <result property="cardState" column="card_state"/>
        <result property="memo" column="memo"/>
        <result property="getterId" column="getter_id"/>
        <result property="getTime" column="get_time"/>
        <result property="grantId" column="grant_id"/>
        <result property="isDelete" column="is_delete"/>
        <result property="cardPrefix" column="card_prefix"/>
        <result property="cardLogo" column="card_logo"/>
        <result property="balanceJf" column="balance_jf"/>
        <result property="payId" column="pay_id"/>
        <result property="skMoney" column="sk_money"/>
        <result property="isDeletea" column="is_deletea"/>
        <result property="password" column="password"/>
        <result property="tel" column="tel"/>
        <result property="orderId" column="order_id"/>
        <result property="tcId" column="tc_id"/>
        <result property="balanceMoney" column="balance_money"/>
        <result property="tcDateregister" column="tc_dateregister"/>
        <result property="tcPatientcode" column="tc_patientcode"/>
        <result property="tcChecked" column="tc_checked"/>
        <result property="recheckMoney" column="recheck_money"/>
        <result property="sellStatus" column="sell_status"/>
        <result property="tcPrice" column="tc_price"/>
        <result property="sellPrice" column="sell_price"/>
        <result property="purchaser" column="purchaser"/>
        <result property="phone" column="phone"/>
        <result property="zk" column="zk"/>
        <result property="processId" column="process_id"/>
    </resultMap>

    <!-- 数据表字段属性 -->
    <sql id="selectCardVo">
        select id,
               card_no,
               balance_limit,
               createdate,
               create_id,
               modifydate,
               modify_id,
               type_id,
               sell_id,
               sell_time,
               validity,
               card_state,
               memo,
               getter_id,
               get_time,
               grant_id,
               is_delete,
               card_prefix,
               card_logo,
               balance_jf,
               pay_id,
               sk_money,
               is_deletea,
               password,
               tel,
               order_id,
               tc_id,
               balance_money,
               tc_dateregister,
               tc_patientcode,
               tc_checked,
               recheck_money,
               sell_status,
               tc_price,
               sell_price,
               purchaser,
               phone,
               zk,
               process_id
        from md_card
    </sql>

    <!-- 查询列表数据 -->
    <select id="getList" resultType="com.center.medical.finance.bean.vo.CHPageVo">
        SELECT
        c.id,
        seller.user_name AS seller,
        STR_TO_DATE ( c.sell_time, '%Y-%m-%d %T' ) AS sellTime,
        c.card_no,
        c.tc_price,
        t.type_name,
        c.card_prefix,
        c.card_logo,
        STR_TO_DATE ( c.validity, '%Y-%m-%d %T' ) AS validity,
        c.card_state,
        c.sell_price,
        c.sell_status,
        c.memo,
        IFNULL ( cm.tjtcmc, co.tjtcmc ) AS tjtcmc,
        c.purchaser,
        c.phone,
        c.tc_checked,
        STR_TO_DATE ( c.tc_dateregister, '%Y-%m-%d %T' ) AS tcDateregister,
        c.tc_patientcode
        FROM
        md_card c
        LEFT JOIN sys_user seller ON seller.user_no = c.sell_id
        LEFT JOIN md_createcombo co ON co.id = c.tc_id
        LEFT JOIN md_createmeal cm ON cm.id = c.tc_id
        LEFT JOIN md_card_type t ON t.id = c.type_id
        <where>
            c.is_delete = 0
            AND t.type = 0
            AND (
            c.is_deletea IS NULL
            OR c.is_deletea = 0
            )
            <if test="param.startNo!=null and param.startNo!=''">
                AND LENGTH(c.card_no) = LENGTH(#{param.startNo}) AND c.card_no <![CDATA[ >= ]]> #{param.startNo}
            </if>
            <if test="param.endNo!=null and param.endNo!=''">
                AND LENGTH(c.card_no) = LENGTH(#{param.endNo}) AND c.card_no <![CDATA[ <= ]]> #{param.endNo}
            </if>
            <if test="param.typeId!=null and param.typeId!=''">
                AND c.type_id = #{param.typeId}
            </if>
            <if test="param.sellId!=null and param.sellId!=''">
                AND c.sell_id = #{param.sellId}
            </if>
            <if test="param.startTime!=null">
                AND c.sell_time <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND c.sell_time <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.startUseTime!=null">
                AND c.tc_dateregister <![CDATA[ >= ]]> #{param.startUseTime}
            </if>
            <if test="param.endUseTime!=null">
                AND c.tc_dateregister <![CDATA[ <= ]]> #{param.endUseTime}
            </if>
            <if test="param.sellStatus!=null">
                <if test="param.sellStatus == 0">
                    AND (c.sell_status IS NULL OR c.sell_status = 0 )
                </if>
                <if test="param.sellStatus == 1">
                    AND c.sell_status = 1
                </if>
            </if>

            <if test="param.tcName!=null and param.tcName!=''">
                AND (CO.TJTCMC LIKE #{param.tcName}
                OR CO.TJTCSRM LIKE #{param.tcName}
                OR CM.TJTCMC LIKE #{param.tcName}
                OR CM.TJTCSRM LIKE #{param.tcName})
            </if>
        </where>
        ORDER BY c.sell_time DESC,c.card_no
    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultMap="CardMap">
        <include refid="selectCardVo"/>
        <where>
            id = #{id}
        </where>
    </select>


    <!-- 导出体检卡管理 -->
    <select id="getExportData" resultType="com.center.medical.finance.bean.vo.CHPageVo">
        SELECT
        c.id,
        seller.user_name AS seller,
        STR_TO_DATE ( c.sell_time, '%Y-%m-%d %T' ) AS sellTime,
        c.card_no,
        c.tc_price,
        t.type_name,
        c.card_prefix,
        c.card_logo,
        STR_TO_DATE ( c.validity, '%Y-%m-%d %T' ) AS validity,
        c.card_state,
        c.sell_price,
        c.sell_status,
        c.memo,
        IFNULL ( cm.tjtcmc, co.tjtcmc ) AS tjtcmc,
        c.purchaser,
        c.phone,
        c.tc_checked,
        STR_TO_DATE ( c.tc_dateregister, '%Y-%m-%d %T' ) AS tcDateregister,
        c.tc_patientcode
        FROM
        md_card c
        LEFT JOIN sys_user seller ON seller.user_no = c.sell_id
        LEFT JOIN md_createcombo co ON co.id = c.tc_id
        LEFT JOIN md_createmeal cm ON cm.id = c.tc_id
        LEFT JOIN md_card_type t ON t.id = c.type_id
        <where>
            c.is_delete = 0
            AND t.type = 0
            AND (
            c.is_deletea IS NULL
            OR c.is_deletea = 0
            )
            <if test="param.startNo!=null and param.startNo!=''">
                AND LENGTH(c.card_no) = LENGTH(#{param.startNo}) AND c.card_no <![CDATA[ >= ]]> #{param.startNo}
            </if>
            <if test="param.endNo!=null and param.endNo!=''">
                AND LENGTH(c.card_no) = LENGTH(#{param.endNo}) AND c.card_no <![CDATA[ <= ]]> #{param.endNo}
            </if>
            <if test="param.typeId!=null and param.typeId!=''">
                AND c.type_id = #{param.typeId}
            </if>
            <if test="param.sellId!=null and param.sellId!=''">
                AND c.sell_id = #{param.sellId}
            </if>
            <if test="param.startTime!=null">
                AND c.sell_time <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND c.sell_time <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.startUseTime!=null">
                AND c.tc_dateregister <![CDATA[ >= ]]> #{param.startUseTime}
            </if>
            <if test="param.endUseTime!=null">
                AND c.tc_dateregister <![CDATA[ <= ]]> #{param.endUseTime}
            </if>
            <if test="param.sellStatus!=null">
                <if test="param.sellStatus == 0">
                    AND (c.sell_status IS NULL OR c.sell_status = 0 )
                </if>
                <if test="param.sellStatus == 1">
                    AND c.sell_status = 1
                </if>
            </if>

            <if test="param.tcName!=null and param.tcName!=''">
                AND (CO.TJTCMC LIKE #{param.tcName}
                OR CO.TJTCSRM LIKE #{param.tcName}
                OR CM.TJTCMC LIKE #{param.tcName}
                OR CM.TJTCSRM LIKE #{param.tcName})
            </if>
        </where>
        ORDER BY c.sell_time DESC,c.card_no
    </select>
</mapper>

