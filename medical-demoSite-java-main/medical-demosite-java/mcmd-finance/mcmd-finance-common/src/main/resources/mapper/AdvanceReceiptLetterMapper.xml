<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.finance.dao.AdvanceReceiptLetterMapper">


    <!-- 查询列表数据 -->
    <select id="getPage" resultType="com.center.medical.finance.bean.vo.ReceiptLetterVo">
        SELECT
            sc.khdwmc,
            o.ddh,
            tc.tjtcmc,
            tc.zhjg,
            count( p.id ) numberOfPeople,
            count( CASE WHEN p.f_registered = 1 THEN p.id ELSE NULL END ) numberOfPeopleRegistered,
            (CASE WHEN tc.fkfs = '0' THEN '是' ELSE '否' END) isTong
        FROM
            md_peisorgreservation v
                INNER JOIN md_peisorgreservationgroup g ON g.id_orgreservation = v.id
                AND g.is_delete = 0
                INNER JOIN md_createorder o ON o.id = v.ddh
                INNER JOIN crm_sellcustomer sc ON sc.id = o.khdwmcid
                INNER JOIN (
                SELECT
                    cm.id,
                    cm.tjtcmc,
                    cm.zhjg,
                    cm.fkfs
                FROM
                    md_createmeal cm UNION ALL
                SELECT
                    cc.id,
                    cc.tjtcmc,
                    cc.zhjg,
                    '0' fkfs
                FROM
                    md_createcombo cc
                ) tc ON tc.id = g.id_examsuite
                INNER JOIN md_peispatient p ON p.id_orgreservationgroup = g.id
                AND p.insuranceno IS NULL
        <where>
            1 = 1
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.khdwmc!=null and param.khdwmc!=''">
                AND sc.khdwmc like concat('%',#{param.khdwmc},'%')
            </if>
            <if test="param.xsjlid!=null and param.xsjlid!=''">
                AND o.xsjlid = #{param.xsjlid}
            </if>
        </where>
        group by sc.khdwmc,o.ddh,tc.tjtcmc,tc.zhjg,g.disp_order,g.id,tc.fkfs
        order by sc.khdwmc,o.ddh,g.disp_order
    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultType="com.center.medical.sellcrm.bean.model.Peisorgreservation">

    </select>



    <!-- 查询列表数据 -->
    <select id="getExportData" resultType="com.center.medical.finance.bean.vo.ReceiptLetterVo">
        SELECT
        sc.khdwmc,
        o.ddh,
        tc.tjtcmc,
        tc.zhjg,
        count( p.id ) numberOfPeople,
        count( CASE WHEN p.f_registered = 1 THEN p.id ELSE NULL END ) numberOfPeopleRegistered,
        (CASE WHEN tc.fkfs = '0' THEN '是' ELSE '否' END) isTong
        FROM
        md_peisorgreservation v
        INNER JOIN md_peisorgreservationgroup g ON g.id_orgreservation = v.id
        AND g.is_delete = 0
        INNER JOIN md_createorder o ON o.id = v.ddh
        INNER JOIN crm_sellcustomer sc ON sc.id = o.khdwmcid
        INNER JOIN (
        SELECT
        cm.id,
        cm.tjtcmc,
        cm.zhjg,
        cm.fkfs
        FROM
        md_createmeal cm UNION ALL
        SELECT
        cc.id,
        cc.tjtcmc,
        cc.zhjg,
        '0' fkfs
        FROM
        md_createcombo cc
        ) tc ON tc.id = g.id_examsuite
        INNER JOIN md_peispatient p ON p.id_orgreservationgroup = g.id
        AND p.insuranceno IS NULL
        <where>
            1 = 1
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.khdwmc!=null and param.khdwmc!=''">
                AND sc.khdwmc like concat('%',#{param.khdwmc},'%')
            </if>
            <if test="param.xsjlid!=null and param.xsjlid!=''">
                AND o.xsjlid = #{param.xsjlid}
            </if>
        </where>
        group by sc.khdwmc,o.ddh,tc.tjtcmc,tc.zhjg,g.disp_order,g.id,tc.fkfs
        order by sc.khdwmc,o.ddh,g.disp_order
    </select>
</mapper>

