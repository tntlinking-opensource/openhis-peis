<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.reception.dao.RegisterMapper">

    <resultMap type="com.center.medical.bean.model.Peispatient" id="PeispatientMap">
        <id property="id" column="id"/>
        <result property="idOrgpatient" column="id_orgpatient"/>
        <result property="idCis" column="id_cis"/>
        <result property="patientarchiveno" column="patientarchiveno"/>
        <result property="patientcode" column="patientcode"/>
        <result property="patientbizno" column="patientbizno"/>
        <result property="idcardno" column="idcardno"/>
        <result property="numorgresv" column="numorgresv"/>
        <result property="patientname" column="patientname"/>
        <result property="inputCode" column="input_code"/>
        <result property="idOrgreservationgroup" column="id_orgreservationgroup"/>
        <result property="idOrgreservation" column="id_orgreservation"/>
        <result property="idOrg" column="id_org"/>
        <result property="orgName" column="org_name"/>
        <result property="orgDepart" column="org_depart"/>
        <result property="havePrivate" column="have_private"/>
        <result property="idPayway" column="id_payway"/>
        <result property="payway" column="payway"/>
        <result property="personpricelimit" column="personpricelimit"/>
        <result property="idSex" column="id_sex"/>
        <result property="birthdate" column="birthdate"/>
        <result property="age" column="age"/>
        <result property="idMarriage" column="id_marriage"/>
        <result property="marriage" column="marriage"/>
        <result property="idNation" column="id_nation"/>
        <result property="nation" column="nation"/>
        <result property="address" column="address"/>
        <result property="idInformway" column="id_informway"/>
        <result property="idOpendoctor" column="id_opendoctor"/>
        <result property="email" column="email"/>
        <result property="phone" column="phone"/>
        <result property="idPatientclass" column="id_patientclass"/>
        <result property="idResarea" column="id_resarea"/>
        <result property="resarea" column="resarea"/>
        <result property="fIsforprepare" column="f_isforprepare"/>
        <result property="fIsforreserve" column="f_isforreserve"/>
        <result property="fRegistered" column="f_registered"/>
        <result property="dateregister" column="dateregister"/>
        <result property="guidancenote" column="guidancenote"/>
        <result property="moneyamount" column="moneyamount"/>
        <result property="moneyamountpaid" column="moneyamountpaid"/>
        <result property="idDoctorreg" column="id_doctorreg"/>
        <result property="doctorreg" column="doctorreg"/>
        <result property="idExamtype" column="id_examtype"/>
        <result property="idExamsuite" column="id_examsuite"/>
        <result property="examsuiteName" column="examsuite_name"/>
        <result property="examsuiteAlias" column="examsuite_alias"/>
        <result property="idDoctorapply" column="id_doctorapply"/>
        <result property="doctorapply" column="doctorapply"/>
        <result property="fGuidanceprinted" column="f_guidanceprinted"/>
        <result property="fExamstarted" column="f_examstarted"/>
        <result property="fReadytofinal" column="f_readytofinal"/>
        <result property="fPaused" column="f_paused"/>
        <result property="fFinallocked" column="f_finallocked"/>
        <result property="fFinalexamed" column="f_finalexamed"/>
        <result property="idDoctorfinal" column="id_doctorfinal"/>
        <result property="doctorfinalNameR" column="doctorfinal_name_r"/>
        <result property="datefinalexamed" column="datefinalexamed"/>
        <result property="fClosed" column="f_closed"/>
        <result property="dateclosed" column="dateclosed"/>
        <result property="note" column="note"/>
        <result property="knowledge" column="knowledge"/>
        <result property="timingstartedat" column="timingstartedat"/>
        <result property="hospitalcode" column="hospitalcode"/>
        <result property="idExamplace" column="id_examplace"/>
        <result property="parsedassignedsuiteandfi" column="parsedassignedsuiteandfi"/>
        <result property="parsedassignedgroupandfi" column="parsedassignedgroupandfi"/>
        <result property="parsedsuiteandfi" column="parsedsuiteandfi"/>
        <result property="parsedsuiteandfilab" column="parsedsuiteandfilab"/>
        <result property="idGuidenurse" column="id_guidenurse"/>
        <result property="patientnameencoded" column="patientnameencoded"/>
        <result property="patientcodehiden" column="patientcodehiden"/>
        <result property="fWordprinted" column="f_wordprinted"/>
        <result property="guidancenote2" column="guidancenote2"/>
        <result property="fUsecodehiden" column="f_usecodehiden"/>
        <result property="idPatientclass3" column="id_patientclass3"/>
        <result property="dateregisternotime" column="dateregisternotime"/>
        <result property="counterreportprinted" column="counterreportprinted"/>
        <result property="fIsrecheck" column="f_isrecheck"/>
        <result property="fSettlenone" column="f_settlenone"/>
        <result property="dateguidancereturned" column="dateguidancereturned"/>
        <result property="fOutpatient" column="f_outpatient"/>
        <result property="patientnamereceipt" column="patientnamereceipt"/>
        <result property="patientnamepinyin" column="patientnamepinyin"/>
        <result property="statusofhm" column="statusofhm"/>
        <result property="instancetag" column="instancetag"/>
        <result property="inpatientno" column="inpatientno"/>
        <result property="insuranceno" column="insuranceno"/>
        <result property="countreportxml" column="countreportxml"/>
        <result property="countreportcompare" column="countreportcompare"/>
        <result property="countreportoccupation" column="countreportoccupation"/>
        <result property="countreportoccupationpdf" column="countreportoccupationpdf"/>
        <result property="countreportoccupationxml" column="countreportoccupationxml"/>
        <result property="scbs" column="scbs"/>
        <result property="idTjtc" column="id_tjtc"/>
        <result property="jzdw" column="jzdw"/>
        <result property="jzdwr" column="jzdwr"/>
        <result property="spr" column="spr"/>
        <result property="tjr" column="tjr"/>
        <result property="lqfs" column="lqfs"/>
        <result property="yzbm" column="yzbm"/>
        <result property="yjaddress" column="yjaddress"/>
        <result property="qtxz" column="qtxz"/>
        <result property="isHmdb" column="is_hmdb"/>
        <result property="isHmd" column="is_hmd"/>
        <result property="isjj" column="isjj"/>
        <result property="zgl" column="zgl"/>
        <result property="jhgl" column="jhgl"/>
        <result property="jhys" column="jhys"/>
        <result property="jktjzt" column="jktjzt"/>
        <result property="zytjzt" column="zytjzt"/>
        <result property="tmyd" column="tmyd"/>
        <result property="medicaldate" column="medicaldate"/>
        <result property="trades" column="trades"/>
        <result property="cjjgsfyhf" column="cjjgsfyhf"/>
        <result property="bhgybsfyhf" column="bhgybsfyhf"/>
        <result property="yxjgsfyhf" column="yxjgsfyhf"/>
        <result property="medicaltype" column="medicaltype"/>
        <result property="prepayment" column="prepayment"/>
        <result property="tcprice" column="tcprice"/>
        <result property="createdate" column="createdate"/>
        <result property="modifydate" column="modifydate"/>
        <result property="cultural" column="cultural"/>
        <result property="workno" column="workno"/>
        <result property="workDate" column="work_date"/>
        <result property="harmDate" column="harm_date"/>
        <result property="diseasePrintNum" column="disease_print_num"/>
        <result property="healthPrintNum" column="health_print_num"/>
        <result property="readytofinalDate" column="readytofinal_date"/>
        <result property="guideSignleCount" column="guide_signle_count"/>
        <result property="shortCode" column="short_code"/>
        <result property="isNoticed" column="is_noticed"/>
        <result property="reviewPdf" column="review_pdf"/>
        <result property="contraindicatedPdf" column="contraindicated_pdf"/>
        <result property="diseasePdf" column="disease_pdf"/>
        <result property="tsLimit" column="ts_limit"/>
        <result property="checkoutDate" column="checkout_date"/>
        <result property="checkoutStatus" column="checkout_status"/>
        <result property="worktypeId" column="worktype_id"/>
        <result property="idExamclass" column="id_examclass"/>
        <result property="originalTrade" column="original_trade"/>
        <result property="status" column="status"/>
        <result property="thirdCode" column="third_code"/>
    </resultMap>

    <!-- 数据表字段属性 -->
    <sql id="selectPeispatientVo">
        select id,
               id_orgpatient,
               id_cis,
               patientarchiveno,
               patientcode,
               patientbizno,
               idcardno,
               numorgresv,
               patientname,
               input_code,
               id_orgreservationgroup,
               id_orgreservation,
               id_org,
               org_name,
               org_depart,
               have_private,
               id_payway,
               payway,
               personpricelimit,
               id_sex,
               birthdate,
               age,
               id_marriage,
               marriage,
               id_nation,
               nation,
               address,
               id_informway,
               id_opendoctor,
               email,
               phone,
               id_patientclass,
               id_resarea,
               resarea,
               f_isforprepare,
               f_isforreserve,
               f_registered,
               dateregister,
               guidancenote,
               moneyamount,
               moneyamountpaid,
               id_doctorreg,
               doctorreg,
               id_examtype,
               id_examsuite,
               examsuite_name,
               examsuite_alias,
               id_doctorapply,
               doctorapply,
               f_guidanceprinted,
               f_examstarted,
               f_readytofinal,
               f_paused,
               f_finallocked,
               f_finalexamed,
               id_doctorfinal,
               doctorfinal_name_r,
               datefinalexamed,
               f_closed,
               dateclosed,
               note,
               knowledge,
               timingstartedat,
               hospitalcode,
               id_examplace,
               parsedassignedsuiteandfi,
               parsedassignedgroupandfi,
               parsedsuiteandfi,
               parsedsuiteandfilab,
               id_guidenurse,
               patientnameencoded,
               patientcodehiden,
               f_wordprinted,
               guidancenote2,
               f_usecodehiden,
               id_patientclass3,
               dateregisternotime,
               counterreportprinted,
               f_isrecheck,
               f_settlenone,
               dateguidancereturned,
               f_outpatient,
               patientnamereceipt,
               patientnamepinyin,
               statusofhm,
               instancetag,
               inpatientno,
               insuranceno,
               countreportxml,
               countreportcompare,
               countreportoccupation,
               countreportoccupationpdf,
               countreportoccupationxml,
               scbs,
               id_tjtc,
               jzdw,
               jzdwr,
               spr,
               tjr,
               lqfs,
               yzbm,
               yjaddress,
               qtxz,
               is_hmdb,
               is_hmd,
               isjj,
               zgl,
               jhgl,
               jhys,
               jktjzt,
               zytjzt,
               tmyd,
               medicaldate,
               trades,
               cjjgsfyhf,
               bhgybsfyhf,
               yxjgsfyhf,
               medicaltype,
               prepayment,
               tcprice,
               createdate,
               modifydate,
               cultural,
               workno,
               work_date,
               harm_date,
               disease_print_num,
               health_print_num,
               readytofinal_date,
               guide_signle_count,
               short_code,
               is_noticed,
               review_pdf,
               contraindicated_pdf,
               disease_pdf,
               ts_limit,
               checkout_date,
               checkout_status,
               worktype_id,
               id_examclass,
               original_trade,
               `status`,
               third_code
        from md_peispatient
    </sql>

    <!-- 查询登记列表-->
    <select id="getPage" resultType="com.center.medical.reception.bean.vo.RegisterVo">
        SELECT
        p.id,
        p.patientcode,
        p.patientname,
        p.id_sex,
        p.age,
        p.birthdate,
        cs.khdwmc AS orgName,
        p.id_examtype AS idExamtype,
        psg.id_examsuite,
        IFNULL( cm.tjtcmc, cc.tjtcmc ) AS tjtcmc,
        p.f_paused,
        psg.orgreservationgroupname AS groupname,
        u.user_name AS registerR,
        p.numorgresv AS orderNum,
        p.org_depart,
        psg.f_groupstarted,
        psg.f_grouppaused,
        p.tmyd,
        p.guide_signle_count AS guideSignleCount,
        p.id_patientclass3,
        p.idcardno,
        p.countreportoccupation,
        p.f_outpatient AS FOutpatient,
        p.phone,
        p.dateguidancereturned as medicaldate,
        pt.patient_name AS idPatientClass,
        p.doctorapply,
        (CASE WHEN charge.note LIKE '预收' THEN 1 ELSE 0 END) AS sfys,
        (CASE WHEN charge.note LIKE '预收' THEN sum(charge.moneyamountpaid) ELSE 0 END) AS ysje,
        (CASE WHEN sms.id is not null THEN 1 ELSE 0 END) AS yjdx
        FROM
        md_peispatient p
        LEFT JOIN md_peisorgreservationgroup psg ON p.id_orgreservationgroup = psg.id
        AND psg.is_delete = 0
        <if test="param.branchIds!=null">
            AND psg.fzxid IN
            <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                #{brandId}
            </foreach>
        </if>
        LEFT JOIN md_peisorgreservation ps ON psg.id_orgreservation = ps.id
        LEFT JOIN crm_sellcustomer cs ON ps.id_org = cs.id
        LEFT JOIN md_createcombo cc ON p.id_tjtc = cc.id
        LEFT JOIN md_createmeal cm ON p.id_tjtc = cm.id
        LEFT JOIN sys_user u ON p.id_doctorreg = u.user_no
        LEFT JOIN md_patienttype pt ON pt.id = p.id_patientclass
        LEFT JOIN md_peispatientcharge charge ON p.patientcode = charge.patientcode
        and charge.is_delete != 1
        LEFT JOIN md_sms_record sms on sms.patientcode = p.patientcode
        and sms.notify_type = 0
        LEFT JOIN md_createorder co ON co.ddh = p.numorgresv
        <where>
            <if test="param.idOpendoctor!=null and param.idOpendoctor!=''">
                AND (p.id_opendoctor = #{param.idOpendoctor} or p.insuranceno like concat('%',#{param.idOpendoctor},'%'))
            </if>
            <if test="param.ptcodeFrom != null and param.ptcodeFrom != ''">
                AND p.patientcode <![CDATA[ >= ]]> #{param.ptcodeFrom}
            </if>
            <if test="param.ptcodeTo != null and param.ptcodeTo != ''">
                AND p.patientcode <![CDATA[ <= ]]> #{param.ptcodeTo}
            </if>
            <if test="param.orgDepart!=null and param.orgDepart!=''">
                AND p.org_depart LIKE concat('%',#{param.orgDepart},'%')
            </if>
            <if test="param.inputCode!=null and param.inputCode!=''">
                AND p.input_code = #{param.inputCode}
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND p.patientname LIKE concat('%',#{param.patientname},'%')
            </if>
            <if test="param.sellId!=null and param.sellId!=''">
                AND p.id_org = #{param.sellId}
            </if>
            <if test="param.idDoctorreg!=null and param.idDoctorreg!=''">
                AND p.id_doctorreg LIKE concat('%',#{param.idDoctorreg},'%')
            </if>
            <if test="param.orderFinished!=null">
                <choose>
                    <when test="param.orderFinished == 1">
                        AND ps.f_finished = 1
                    </when>
                    <otherwise>
                        AND (ps.f_finished = 0 or ps.f_finished is null)
                    </otherwise>
                </choose>
            </if>
            <if test="param.idPatientclass3!=null">
                <choose>
                    <when test="param.idPatientclass3 == 0">
                        AND p.id_patientclass3 = #{param.idPatientclass3}
                        OR p.id_patientclass3 IS NULL
                    </when>
                    <otherwise>
                        AND p.id_patientclass3 = #{param.idPatientclass3}
                    </otherwise>
                </choose>
            </if>
            <if test="param.phone!=null and param.phone!=''">
                AND p.phone LIKE concat('%',#{param.phone},'%')
            </if>
            <if test="param.idcardno!=null and param.idcardno!=''">
                AND p.idcardno LIKE concat('%',#{param.idcardno},'%')
            </if>
            <if test="param.startTime!=null">
                AND p.createdate <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.createdate <![CDATA[ < ]]> #{param.endTime}
            </if>
            <if test="param.idPatientclass!=null">
                AND p.id_patientclass = #{param.idPatientclass}
            </if>
            <if test="param.numorgresv!=null and param.numorgresv!=''">
                AND p.numorgresv = #{param.numorgresv}
            </if>
            <if test="param.dateTime!=null">
                AND p.medicaldate = #{param.dateTime}
            </if>
            <if test="param.paused!=null">
                <choose>
                    <when test="param.paused == 0">
                        AND p.f_paused = 0
                    </when>
                    <otherwise>
                        AND p.f_paused = 1
                    </otherwise>
                </choose>
            </if>

            <if test="param.printType != null">
                <choose>
                    <when test="param.printType == 1">
                        <if test="param.pCount == 0">
                            AND p.tmyd = 0
                        </if>
                        <if test="param.pCount == 1">
                            AND p.tmyd > 0
                        </if>
                    </when>
                    <when test="param.printType == 2">
                        <if test="param.pCount == 0">
                            AND p.guide_signle_count = 0
                        </if>
                        <if test="param.pCount == 1">
                            AND p.guide_signle_count > 0
                        </if>
                    </when>
                    <otherwise>
                        <if test="param.pCount == 0">
                            AND (p.tmyd = 0 AND p.guide_signle_count = 0)
                        </if>
                        <if test="param.pCount == 1">
                            AND (p.tmyd > 0 AND p.guide_signle_count > 0)
                        </if>
                    </otherwise>
                </choose>
            </if>

            <if test="param.useCodeHiden!=null">
                AND p.f_usecodehiden = #{param.useCodeHiden}
            </if>
            AND p.f_registered = 0
            <!--            <choose>-->
            <!--                <when test="param.jm!=null and param.jm!=''">-->
            <!--                    AND p.patientbizno IS NOT NULL-->
            <!--                </when>-->
            <!--                <otherwise>-->
            <!--                    AND p.patientbizno IS NULL-->
            <!--                </otherwise>-->
            <!--            </choose>-->
            <if test="param.sfys!=null">
                <choose>
                    <when test="param.sfys == 1">
                        and charge.note LIKE '预收'
                    </when>
                    <otherwise>
                        and (charge.note NOT LIKE '预收' OR charge.note IS NULL )
                    </otherwise>
                </choose>
            </if>
            <if test="param.khdwmcid!=null and param.khdwmcid!=''">
                AND p.id_org = #{param.khdwmcid}
            </if>
            <if test="param.userNo!=null and param.userNo!=''">
                AND (p.id_opendoctor = #{param.userNo}
                or p.insuranceno like concat('%',#{param.userNo},'%')
                or co.kdzl_name like concat('%', #{param.userName},'%'))
            </if>
            <if test="param.lowerLevelIds!=null">
                AND p.id_opendoctor IN
                <foreach collection="param.lowerLevelIds" item="lowerLevelId" open="(" close=")" separator=",">
                    #{lowerLevelId}
                </foreach>
            </if>
        </where>
        GROUP BY p.patientcode
        ORDER BY
        p.createdate DESC,
        ps.createdate ASC,
        p.patientcode DESC,
        p.id DESC
    </select>

    <!--    &lt;!&ndash; 根据主键id获取记录详情 &ndash;&gt;-->
    <!--    <select id="getInfoById" resultMap="PeispatientMap">-->
    <!--        <include refid="selectPeispatientVo"/>-->
    <!--        <where>-->
    <!--            id = #{id}-->
    <!--        </where>-->
    <!--    </select>-->


    <!-- 查询登记列表-->
    <select id="getReservationUser" resultType="com.center.medical.reception.bean.vo.ReservationUserVo">
        SELECT
        p.id,
        p.patientcode,
        p.patientname,
        p.id_sex,
        p.age,
        p.phone,
        p.idcardno,
        p.medicaldate,
        s.creater,
        p.dateguidancereturned,
        p.org_name,
        s.notify_result,
        STR_TO_DATE ( s.notify_time, '%Y-%m-%d %T' ) AS notifyTime,
        p.is_noticed
        FROM
        md_peispatient p
        LEFT JOIN (
        SELECT
        *
        FROM
        md_sms_record sin2
        WHERE
        NOT EXISTS (
        SELECT
        1
        FROM
        md_sms_record sin1
        WHERE
        sin1.patientcode = sin2.patientcode
        AND sin1.notify_type = sin2.notify_type
        AND sin1.createdate > sin2.createdate
        )) s ON s.patientcode = p.patientcode
        AND s.notify_type = '0'
        <where>
            p.f_isforreserve = 1
            <if test="param.type!=null">
                <if test="param.type == 0">
                    AND p.patientbizno IS NULL
                </if>
                <if test="param.type == 1">
                    AND p.patientbizno IS NOT NULL
                </if>
            </if>
            AND p.f_registered = 0
            AND ( p.f_paused IS NULL OR p.f_paused = 0 )
            <if test="param.isReg!=null and param.isReg == 1">
                AND p.doctorapply = #{param.userNo}
            </if>
            <if test="param.startTime!=null">
                AND p.dateguidancereturned <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateguidancereturned <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.notifyResult!=null">
                AND IFNULL(s.notify_result,1) = #{param.notifyResult}
            </if>
            <if test="param.useCodeHiden!=null">
                AND p.f_usecodehiden = #{param.useCodeHiden}
            </if>
        </where>
        <choose>
            <when test="param.isReg!=null and param.isReg== 1">
                ORDER BY
                (
                CASE WHEN p.dateguidancereturned <![CDATA[ >= ]]> #{param.dayStart}
                AND p.dateguidancereturned <![CDATA[ <= ]]> #{param.dayStart}
                THEN 1
                WHEN p.createdate IS NULL
                AND p.dateguidancereturned IS NULL THEN
                3 ELSE 2
                END
                ) ASC,(
                CASE
                WHEN p.dateguidancereturned IS NULL THEN
                p.createdate ELSE p.dateguidancereturned
                END
                ) DESC
            </when>
            <otherwise>
                ORDER BY IFNULL(s.notify_result,1) ASC,p.medicaldate ASC
            </otherwise>
        </choose>
    </select>


    <!-- 查询登记列表-->
    <select id="getRecordListData" resultType="com.center.medical.reception.bean.vo.RecordListVo">
        SELECT
        archives.id,
        min( archives.patientarchiveno ) AS patientarchiveno,
        min( archives.patientname ) AS patientname,
        min( archives.id_sex ) AS idsex,
        min( STR_TO_DATE ( archives.birthdate, '%Y-%m-%d' )) AS birthdate,
        min( archives.phone ) AS phone,
        min( archives.idcardno ) AS idcardno,
        min( archives.id_nation ) AS idNation,
        min( archives.address ) AS address,
        min( archives.cultural ) AS cultural,
        IFNULL ( min( archives.ishmd ), 0 ) AS ishmd,
        min( archives.hmdbz ) AS hmdbz,
        min( archives.memberlevel ) AS memberlevel,
        min( STR_TO_DATE ( archives.createdate, '%Y-%m-%d %T' )) AS createDate,
        count( ph.id ) AS examcounts,
        min( archives.id_marriage ) AS idMarriage,
        min( archives.marriage ) AS marriage,
        min( archives.countreportoccupationxml ) AS countreportoccupationxml,
        min( archives.patientcardno ) AS patientcardno,
        sum( pcm.moneyamountpaid ) AS money
        FROM
        md_peispatientarchive archives
        LEFT JOIN md_peispatient ph ON archives.id = ph.patientarchiveno
        LEFT JOIN md_peispatient_charge_main pcm ON pcm.patientcode = ph.patientcode
        <where>
            archives.is_delete = 0
            <if test="param.patientname!=null and param.patientname!=''">
                AND archives.patientname like concat('%',#{param.patientname},'%')
            </if>
            <if test="param.inputCode!=null and param.inputCode!=''">
                ( INSTR( ARCHIVES.INPUT_CODE, #{param.inputCode} )> 0
                OR INSTR( ARCHIVES.PATIENTNAME, #{param.inputCode} )> 0)
            </if>
            <if test="param.phone!=null and param.phone!=''">
                AND archives.phone like concat('%',#{param.phone},'%')
            </if>
            <if test="param.idcardno!=null and param.idcardno!=''">
                AND archives.idcardno like concat('%',#{param.idcardno},'%')
            </if>
            <if test="param.startTime!=null">
                AND archives.createdate <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND archives.createdate <![CDATA[ <= ]]> #{param.endTime}
            </if>
        </where>
        GROUP BY archives.id,archives.createdate
        ORDER BY archives.createdate DESC
    </select>


    <!-- 查询登记列表-->
    <select id="getAnswer" resultType="com.center.medical.reception.bean.dto.AnswerDto">
        SELECT i.id,
        i.examfeeitem_name AS sfxmmc,
        i.unitprice AS jg,
        i.jcyy,
        d.dept_name AS ssks,
        i.id_depart AS idKs
        FROM md_items i
        LEFT JOIN sys_dept d ON i.id_depart = d.dept_id
        WHERE EXISTS(
        SELECT 1
        FROM md_base_guide_meal m
        INNER JOIN md_base_guide_mealitem mi ON mi.meal_id = m.id
        WHERE mi.item_id = i.id)
        <if test="itemIds!=null and itemIds.size > 0">
            OR i.id IN
            <foreach collection="itemIds" item="itemId" open="(" close=")" separator=",">
                #{itemId}
            </foreach>
        </if>
        ORDER BY i.examfeeitem_name
    </select>


    <!-- 最近体检人员列表-->
    <select id="getPatientForRegister" resultType="com.center.medical.reception.bean.vo.PaForReVo">
        SELECT
        p.id,
        p.patientcode,
        p.patientname,
        p.id_sex,
        p.age,
        p.birthdate,
        p.org_name,
        p.id_examtype,
        p.id_patientclass,
        p.id_tjtc AS idExamsuite,
        IFNULL( md_createmeal.tjtcmc, md_createcombo.tjtcmc ) AS tcmc,
        p.numorgresv as ddh,
        p.id_payway,
        mpg.orgreservationgroupname AS groupname,
        p.medicaldate,
        p.createdate,
        p.id_org,
        mpg.orgreservationgroupname AS idgroup,
        STR_TO_DATE( p.dateregister, '%Y-%m-%d %T' ) AS dateregister,
        #{param.p} AS dbtype,
        IFNULL( p.f_closed, 0 ) AS close,
        p.jktjzt AS jk,
        p.zytjzt AS zy,
        p.idcardno,
        p.phone,
        p.doctorapply,
        p.countreportcompare,
        p.doctorreg,
        p.patientbizno,
        p.countreportxml,
        p.tjr,
        linshi.create_status AS FPdfcreated,
        r.url_pdf AS pdfUrl,
        p.org_depart AS orgDepart,
        p.countreportoccupation,
        p.f_outpatient,
        p.medicaltype,
        p.isjj,
        ys.create_status AS orgDepartsubb,
        ot.create_status AS jyPdfcreated,
        js.payway_name,
        CASE
        WHEN EXISTS (
        SELECT
        1
        FROM
        md_peispatientfeeitem pi
        INNER JOIN md_items i ON i.id = pi.id_examfeeitem
        WHERE
        pi.id_patient = p.patientcode
        AND i.bgdybs = '1'
        AND pi.change_item = 0
        AND pi.f_giveup = 0
        AND ( pi.sfjj IS NULL OR pi.sfjj = 0 )
        AND pi.f_feecharged = 1
        AND pi.f_examinated = 1
        ) THEN
        '是' ELSE '否'
        END AS containsPrivate,
        p.payway,
        linshi.pdf_url as lsPdf,
        ys.pdf_url as ysPdf,
        ot.pdf_url as jyPdf
        FROM
        <if test="param.p!=null">
            <choose>
                <when test="param.p == 0">
                    md_peispatient p
                </when>
                <when test="param.p == 1">
                    md_peispatienthistory p
                </when>
            </choose>
        </if>
        LEFT JOIN md_other_report linshi ON linshi.patientcode = p.patientcode
        AND linshi.report_type = 3
        LEFT JOIN md_peisorgreservationgroup mpg ON p.id_orgreservationgroup = mpg.id
        LEFT JOIN md_peisorgreservation mp ON mpg.id_orgreservation = mp.id
        LEFT JOIN md_createcombo ON p.id_tjtc = md_createcombo.id
        LEFT JOIN md_createmeal ON p.id_tjtc = md_createmeal.id
        LEFT JOIN md_createorder ON mp.ddh = md_createorder.id
        LEFT JOIN md_report r ON r.patientcode = p.patientcode
        AND r.disease_health = 0
        LEFT JOIN md_other_report ot ON ot.patientcode = p.patientcode
        AND ot.report_type = 0
        LEFT JOIN md_other_report ys ON ys.patientcode = p.patientcode
        AND ys.report_type = 2
        <if test="param.idDepart!=null and param.idDepart!=''">
            LEFT JOIN sys_user_dep qud ON qud.user_id = p.id_doctorreg
        </if>
        LEFT JOIN md_dictpayway js ON p.id_payway = js.id
        <where>
            1 = 1
            <if test="param.fRegistered!=null">
                AND p.f_registered = 1
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND p.patientcode LIKE concat('%',#{param.patientcode},'%')
            </if>
            <if test="param.inputCode!=null and param.inputCode!=''">
                AND (p.input_code LIKE concat('%',#{param.inputCode},'%')
                OR p.patientname LIKE concat('%',#{param.inputCode},'%'))
            </if>
            <if test="param.phone!=null and param.phone!=''">
                AND p.phone LIKE concat('%',#{param.phone},'%')
            </if>
            <if test="param.idcardno!=null and param.idcardno!=''">
                AND p.idcardno LIKE concat('%',#{param.idcardno},'%')
            </if>
            <if test="param.idOrg!=null and param.idOrg!=''">
                AND p.id_org = #{param.idOrg}
            </if>
            <if test="param.idExamtype!=null and param.idExamtype!=''">
                AND p.id_examtype = #{param.idExamtype}
            </if>
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.idArchive!=null and param.idArchive!=''">
                AND p.id_examtype = #{param.idExamtype}
            </if>
            <if test="param.jkreportStatus!=null and param.jkreportStatus!=''">
                AND IFNULL(p.jktjzt, -1) = #{param.jkreportStatus}
            </if>
            <if test="param.orgDepart!=null and param.orgDepart!=''">
                AND p.org_depart LIKE concat('%',#{param.orgDepart},'%')
            </if>
            <if test="param.zyreportStatus!=null and param.zyreportStatus!=''">
                AND IFNULL(p.zytjzt, -1) = #{param.zyreportStatus}
            </if>
            <if test="param.close!=null and param.close!=''">
                AND IFNULL(p.f_closed, 0) = #{param.close}
            </if>
            <if test="param.countreportcompare!=null">
                <choose>
                    <when test="param.countreportcompare == 1">
                        AND p.countreportcompare = 1
                    </when>
                    <otherwise>
                        AND p.countreportcompare = 0
                    </otherwise>
                </choose>
            </if>
            <if test="param.idDoctorreg!=null and param.idDoctorreg!=''">
                AND p.id_doctorreg = #{param.idDoctorreg}
            </if>
            <if test="param.idDepart!=null and param.idDepart!=''">
                AND qud.dep_id = #{param.idDepart}
            </if>
            <if test="param.medicaltype!=null and param.medicaltype!=''">
                AND p.medicaltype = #{param.medicaltype}
                AND p.id_examtype <![CDATA[ <> ]]> 0
            </if>
            <if test="param.idOpendoctor!=null and param.idOpendoctor!=''">
                AND (p.id_opendoctor = #{param.idOpendoctor} or p.insuranceno like concat('%',#{param.idOpendoctor},'%'))
            </if>
            <if test="param.ddh!=null and param.ddh!=''">
                AND p.numorgresv = #{param.ddh}
            </if>
            <if test="param.idPatientclass!=null and param.idPatientclass!=''">
                AND p.id_patientclass = #{param.idPatientclass}
            </if>
            <if test="param.branchIds!=null">
                AND p.hospitalcode IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
        </where>
        GROUP BY p.patientcode
        ORDER BY p.dateregister DESC
    </select>

    <!-- 批量登记查询-->
    <select id="getPatientForOrderIdSql" resultType="com.center.medical.reception.bean.vo.PatientForOrderIdVo">
        SELECT
        p.id,
        p.patientcode,
        p.patientname,
        p.id_sex,
        p.age,
        p.birthdate,
        p.id_marriage,
        p.id_nation nation,
        p.org_name,
        p.org_depart,
        p.workno,
        p.phone,
        p.idcardno,
        u.user_name sellname,
        p.numorgresv ddh
        FROM
        md_peispatient p
        INNER JOIN md_peisorgreservation pgv ON pgv.id = p.id_orgreservation
        LEFT JOIN sys_user u ON pgv.id_salesperson = u.user_no
        WHERE
        1 = 1
        <if test="patientcode!=null and patientcode!=''">
            AND p.patientcode = #{patientcode}
        </if>
    </select>

    <!-- 导出excel数据-->
    <select id="getExportData" resultType="com.center.medical.reception.bean.vo.RCExportVo">
        SELECT
        p.id,
        p.patientcode,
        p.patientname,
        p.id_sex,
        p.age,
        p.birthdate,
        cs.khdwmc,
        p.id_examtype AS idExamtype,
        psg.id_examsuite,
        IFNULL( cm.tjtcmc, cc.tjtcmc ) AS tjtcmc,
        p.f_paused,
        psg.orgreservationgroupname,
        u.user_name AS registerR,
        p.numorgresv,
        p.org_depart,
        psg.f_groupstarted,
        psg.f_grouppaused,
        p.tmyd,
        p.guide_signle_count AS guideSignleCount,
        p.id_patientclass3,
        p.idcardno,
        p.countreportoccupation,
        p.f_outpatient AS FOutpatient,
        p.phone,
        p.dateguidancereturned as medicaldate,
        pt.patient_name AS idPatientClass,
        p.doctorapply,
        (CASE WHEN charge.note LIKE '预收' THEN 1 ELSE 0 END) AS sfys,
        (CASE WHEN charge.note LIKE '预收' THEN sum(charge.moneyamountpaid) ELSE 0 END) AS ysje
        FROM
        md_peispatient p
        LEFT JOIN md_peisorgreservationgroup psg ON p.id_orgreservationgroup = psg.id
        AND psg.is_delete = 0
        <if test="param.branchIds!=null">
            AND psg.fzxid IN
            <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                #{brandId}
            </foreach>
        </if>
        LEFT JOIN md_peisorgreservation ps ON psg.id_orgreservation = ps.id
        LEFT JOIN crm_sellcustomer cs ON ps.id_org = cs.id
        LEFT JOIN md_createcombo cc ON p.id_tjtc = cc.id
        LEFT JOIN md_createmeal cm ON p.id_tjtc = cm.id
        LEFT JOIN sys_user u ON p.id_doctorreg = u.user_no
        LEFT JOIN md_patienttype pt ON pt.id = p.id_patientclass
        LEFT JOIN md_peispatientcharge charge ON p.patientcode = charge.patientcode
        and charge.is_delete != 1
        LEFT JOIN md_createorder co ON co.ddh = p.numorgresv
        <where>
            <if test="param.idOpendoctor!=null and param.idOpendoctor!=''">
                AND (p.id_opendoctor = #{param.idOpendoctor} or p.insuranceno like concat('%',#{param.idOpendoctor},'%'))
            </if>
            <if test="param.ptcodeFrom != null and param.ptcodeFrom != ''">
                AND p.patientcode <![CDATA[ >= ]]> #{param.ptcodeFrom}
            </if>
            <if test="param.ptcodeTo != null and param.ptcodeTo != ''">
                AND p.patientcode <![CDATA[ <= ]]> #{param.ptcodeTo}
            </if>
            <if test="param.orgDepart!=null and param.orgDepart!=''">
                AND p.org_depart LIKE concat('%',#{param.orgDepart},'%')
            </if>
            <if test="param.inputCode!=null and param.inputCode!=''">
                AND p.input_code = #{param.inputCode}
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND p.patientname LIKE concat('%',#{param.patientname},'%')
            </if>
            <if test="param.sellId!=null and param.sellId!=''">
                AND p.id_org = #{param.sellId}
            </if>
            <if test="param.idDoctorreg!=null and param.idDoctorreg!=''">
                AND p.id_doctorreg LIKE concat('%',#{param.idDoctorreg},'%')
            </if>
            <if test="param.orderFinished!=null">
                <choose>
                    <when test="param.orderFinished == 1">
                        AND ps.f_finished = 1
                    </when>
                    <otherwise>
                        AND (ps.f_finished = 0 or ps.f_finished is null)
                    </otherwise>
                </choose>
            </if>
            <if test="param.idPatientclass3!=null">
                <choose>
                    <when test="param.idPatientclass3 == 0">
                        AND p.id_patientclass3 = #{param.idPatientclass3}
                        OR p.id_patientclass3 IS NULL
                    </when>
                    <otherwise>
                        AND p.id_patientclass3 = #{param.idPatientclass3}
                    </otherwise>
                </choose>
            </if>
            <if test="param.phone!=null and param.phone!=''">
                AND p.phone LIKE concat('%',#{param.phone},'%')
            </if>
            <if test="param.idcardno!=null and param.idcardno!=''">
                AND p.idcardno LIKE concat('%',#{param.idcardno},'%')
            </if>
            <if test="param.startTime!=null">
                AND p.createdate <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.createdate <![CDATA[ < ]]> #{param.endTime}
            </if>
            <if test="param.idPatientclass!=null">
                AND p.id_patientclass = #{param.idPatientclass}
            </if>
            <if test="param.numorgresv!=null and param.numorgresv!=''">
                AND p.numorgresv = #{param.numorgresv}
            </if>
            <if test="param.dateTime!=null">
                AND p.medicaldate = #{param.dateTime}
            </if>
            <if test="param.paused!=null">
                <choose>
                    <when test="param.paused == 0">
                        AND p.f_paused = 0
                    </when>
                    <otherwise>
                        AND p.f_paused = 1
                    </otherwise>
                </choose>
            </if>

            <if test="param.printType != null">
                <choose>
                    <when test="param.printType == 1">
                        <if test="param.pCount == 0">
                            AND p.tmyd = 0
                        </if>
                        <if test="param.pCount == 1">
                            AND p.tmyd > 0
                        </if>
                    </when>
                    <when test="param.printType == 2">
                        <if test="param.pCount == 0">
                            AND p.guide_signle_count = 0
                        </if>
                        <if test="param.pCount == 1">
                            AND p.guide_signle_count > 0
                        </if>
                    </when>
                    <otherwise>
                        <if test="param.pCount == 0">
                            AND (p.tmyd = 0 AND p.guide_signle_count = 0)
                        </if>
                        <if test="param.pCount == 1">
                            AND (p.tmyd > 0 AND p.guide_signle_count > 0)
                        </if>
                    </otherwise>
                </choose>
            </if>

            <if test="param.useCodeHiden!=null">
                AND p.f_usecodehiden = #{param.useCodeHiden}
            </if>
            AND p.f_registered = 0
            <!--            <choose>-->
            <!--                <when test="param.jm!=null and param.jm!=''">-->
            <!--                    AND p.patientbizno IS NOT NULL-->
            <!--                </when>-->
            <!--                <otherwise>-->
            <!--                    AND p.patientbizno IS NULL-->
            <!--                </otherwise>-->
            <!--            </choose>-->
            <if test="param.sfys!=null">
                <choose>
                    <when test="param.sfys == 1">
                        and charge.note LIKE '预收'
                    </when>
                    <otherwise>
                        and (charge.note NOT LIKE '预收' OR charge.note IS NULL )
                    </otherwise>
                </choose>
            </if>
            <if test="param.khdwmcid!=null and param.khdwmcid!=''">
                AND p.id_org = #{param.khdwmcid}
            </if>
            <if test="param.userNo!=null and param.userNo!=''">
                AND (p.id_opendoctor = #{param.userNo}
                or p.insuranceno like concat('%',#{param.userNo},'%')
                or co.kdzl_name like concat('%', #{param.userName},'%'))
            </if>
            <if test="param.lowerLevelIds!=null">
                AND p.id_opendoctor IN
                <foreach collection="param.lowerLevelIds" item="lowerLevelId" open="(" close=")" separator=",">
                    #{lowerLevelId}
                </foreach>
            </if>
        </where>
        GROUP BY p.patientcode
        ORDER BY
        p.createdate DESC,
        ps.createdate ASC,
        p.patientcode DESC,
        p.id DESC
    </select>


    <!-- 导出登记信息列表-->
    <select id="getPaExportData" resultType="com.center.medical.reception.bean.vo.PaForReVo">
        SELECT
        p.id,
        p.patientcode,
        p.patientname,
        p.id_sex,
        p.age,
        p.birthdate,
        p.org_name,
        p.id_examtype,
        p.id_patientclass,
        p.id_tjtc AS idExamsuite,
        IFNULL( md_createmeal.tjtcmc, md_createcombo.tjtcmc ) AS tcmc,
        p.numorgresv as ddh,
        p.id_payway,
        mpg.orgreservationgroupname AS groupname,
        p.medicaldate,
        p.createdate,
        p.id_org,
        mpg.orgreservationgroupname AS idgroup,
        STR_TO_DATE( p.dateregister, '%Y-%m-%d %T' ) AS dateregister,
        #{param.p} AS dbtype,
        IFNULL( p.f_closed, 0 ) AS close,
        p.jktjzt AS jk,
        p.zytjzt AS zy,
        p.idcardno,
        p.phone,
        p.doctorapply,
        p.countreportcompare,
        p.doctorreg,
        p.patientbizno,
        p.countreportxml,
        p.tjr,
        linshi.create_status AS FPdfcreated,
        r.url_pdf AS pdfUrl,
        p.org_depart AS orgDepart,
        p.countreportoccupation,
        p.f_outpatient,
        p.medicaltype,
        p.isjj,
        ys.create_status AS orgDepartsubb,
        ot.create_status AS jyPdfcreated,
        js.payway_name,
        mpt.patient_name AS patientName1,
        p.doctorapply
        FROM
        <if test="param.p!=null">
            <choose>
                <when test="param.p == 0">
                    md_peispatient p
                </when>
                <when test="param.p == 1">
                    md_peispatienthistory p
                </when>
            </choose>
        </if>
        LEFT JOIN md_other_report linshi ON linshi.patientcode = p.patientcode
        AND linshi.report_type = 3
        LEFT JOIN md_peisorgreservationgroup mpg ON p.id_orgreservationgroup = mpg.id
        LEFT JOIN md_peisorgreservation mp ON mpg.id_orgreservation = mp.id
        LEFT JOIN md_createcombo ON p.id_tjtc = md_createcombo.id
        LEFT JOIN md_createmeal ON p.id_tjtc = md_createmeal.id
        LEFT JOIN md_createorder ON mp.ddh = md_createorder.id
        LEFT JOIN md_report r ON r.patientcode = p.patientcode
        AND r.disease_health = 0
        LEFT JOIN md_other_report ot ON ot.patientcode = p.patientcode
        AND ot.report_type = 0
        LEFT JOIN md_other_report ys ON ys.patientcode = p.patientcode
        AND ys.report_type = 2
        <if test="param.idDepart!=null and param.idDepart!=''">
            LEFT JOIN sys_user_dep qud ON qud.user_id = p.id_doctorreg
        </if>
        LEFT JOIN md_dictpayway js ON p.id_payway = js.id
        LEFT JOIN md_patienttype mpt ON mpt.id = p.id_patientclass
        <where>
            1 = 1
            <if test="param.fRegistered!=null">
                AND p.f_registered = 1
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND p.patientcode LIKE concat('%',#{param.patientcode},'%')
            </if>
            <if test="param.inputCode!=null and param.inputCode!=''">
                AND (p.input_code LIKE concat('%',#{param.inputCode},'%')
                OR p.patientname LIKE concat('%',#{param.inputCode},'%'))
            </if>
            <if test="param.phone!=null and param.phone!=''">
                AND p.phone LIKE concat('%',#{param.phone},'%')
            </if>
            <if test="param.idcardno!=null and param.idcardno!=''">
                AND p.idcardno LIKE concat('%',#{param.idcardno},'%')
            </if>
            <if test="param.idOrg!=null and param.idOrg!=''">
                AND p.id_org = #{param.idOrg}
            </if>
            <if test="param.idExamtype!=null and param.idExamtype!=''">
                AND p.id_examtype = #{param.idExamtype}
            </if>
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endTime}
            </if>
            <if test="param.idArchive!=null and param.idArchive!=''">
                AND p.id_examtype = #{param.idExamtype}
            </if>
            <if test="param.jkreportStatus!=null and param.jkreportStatus!=''">
                AND IFNULL(p.jktjzt, -1) = #{param.jkreportStatus}
            </if>
            <if test="param.orgDepart!=null and param.orgDepart!=''">
                AND p.org_depart LIKE concat('%',#{param.orgDepart},'%')
            </if>
            <if test="param.zyreportStatus!=null and param.zyreportStatus!=''">
                AND IFNULL(p.zytjzt, -1) = #{param.zyreportStatus}
            </if>
            <if test="param.close!=null and param.close!=''">
                AND IFNULL(p.f_closed, 0) = #{param.close}
            </if>
            <if test="param.countreportcompare!=null">
                <choose>
                    <when test="param.countreportcompare == 1">
                        AND p.countreportcompare = 1
                    </when>
                    <otherwise>
                        AND p.countreportcompare = 0
                    </otherwise>
                </choose>
            </if>
            <if test="param.idDoctorreg!=null and param.idDoctorreg!=''">
                AND p.id_doctorreg = #{param.idDoctorreg}
            </if>
            <if test="param.idDepart!=null and param.idDepart!=''">
                AND qud.dep_id = #{param.idDepart}
            </if>
            <if test="param.medicaltype!=null and param.medicaltype!=''">
                AND p.medicaltype = #{param.medicaltype}
                AND p.id_examtype <![CDATA[ <> ]]> 0
            </if>
            <if test="param.idOpendoctor!=null and param.idOpendoctor!=''">
                AND (p.id_opendoctor = #{param.idOpendoctor} or p.insuranceno like concat('%',#{param.idOpendoctor},'%'))
            </if>
            <if test="param.ddh!=null and param.ddh!=''">
                AND md_createorder.ddh = #{param.ddh}
            </if>
            <if test="param.idPatientclass!=null and param.idPatientclass!=''">
                AND p.id_patientclass = #{param.idPatientclass}
            </if>
            <if test="param.branchIds!=null">
                AND p.hospitalcode IN
                <foreach collection="param.branchIds" item="brandId" open="(" close=")" separator=",">
                    #{brandId}
                </foreach>
            </if>
        </where>
        GROUP BY p.patientcode
        ORDER BY p.dateregister DESC
    </select>
    <!--通过身份证号获取体检号-->
    <select id="getPatientcodeByIdcard" resultType="com.center.medical.reception.bean.vo.IdcarPatientVo">
        select id,
               numorgresv AS orderNum,
               org_name,
               org_depart,
               patientcode,
               patientname,
               idcardno,
               phone,
               id_sex,
               id_examtype,
               examsuite_name
        from md_peispatient
        where idcardno = #{idCard}
          AND f_registered = 0
          AND (f_paused IS NULL OR f_paused = 0)
    </select>

    <!--退款管理-->
    <select id="refundManagement" resultType="com.center.medical.reception.bean.vo.RefundManagementVo">
        select p.numorgresv,
        p.org_name,
        p.patientcode,
        p.patientname,
        u.user_name,
        pc.moneyamountpaid,
        pc.feechargetime
        from md_peispatientcharge pc
        INNER JOIN md_peispatient p on p.patientcode = pc.patientcode
        INNER JOIN sys_user u ON u.user_no = pc.id_feecharger
        <where>
            pc.is_delete = 0
            and pc.id_payway in (22,25)
            <if test="param.fIsreturn!=null ">
                <choose>
                    <when test="param.fIsreturn == 1">
                        and pc.f_isreturn = 1
                    </when>
                    <otherwise>
                        and (pc.f_isreturn = 0 or pc.f_isreturn is null)
                    </otherwise>
                </choose>
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND p.patientcode like concat('%',#{param.patientcode},'%')
            </if>
            <if test="param.numorgresv!=null and param.numorgresv!=''">
                AND p.numorgresv =#{param.numorgresv}
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND p.patientname like concat('%',#{param.patientname},'%')
            </if>
            <if test="param.startTime!=null">
                AND pc.createdate <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND pc.createdate <![CDATA[ <= ]]> #{param.endTime}
            </if>
        </where>
        ORDER BY pc.createdate DESC
    </select>


    <!--导出退款管理-->
    <select id="exportData" resultType="com.center.medical.reception.bean.vo.RefundManagementVo">
        select p.numorgresv,
        p.org_name,
        p.patientcode,
        p.patientname,
        u.user_name,
        pc.moneyamountpaid,
        pc.feechargetime
        from md_peispatientcharge pc
        INNER JOIN md_peispatient p on p.patientcode = pc.patientcode
        INNER JOIN sys_user u ON u.user_no = pc.id_feecharger
        <where>
            pc.is_delete = 0
            and pc.id_payway in (22,25)
            <if test="param.fIsreturn!=null ">
                <choose>
                    <when test="param.fIsreturn == 1">
                        and pc.f_isreturn = 1
                    </when>
                    <otherwise>
                        and (pc.f_isreturn = 0 or pc.f_isreturn is null)
                    </otherwise>
                </choose>
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND p.patientcode like concat('%',#{param.patientcode},'%')
            </if>
            <if test="param.numorgresv!=null and param.numorgresv!=''">
                AND p.numorgresv =#{param.numorgresv}
            </if>
            <if test="param.patientname!=null and param.patientname!=''">
                AND p.patientname like concat('%',#{param.patientname},'%')
            </if>
            <if test="param.startTime!=null">
                AND pc.createdate <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND pc.createdate <![CDATA[ <= ]]> #{param.endTime}
            </if>
        </where>
        ORDER BY pc.createdate DESC
    </select>



    <!--获取最近人员列表-->
    <select id="getRecentPersonnelList" resultType="com.center.medical.reception.bean.vo.RecentPersonnelListVo">
        SELECT
        p.id,
        p.patientcode,
        p.patientname,
        p.id_sex,
        p.age,
        IFNULL( md_createmeal.tjtcmc, md_createcombo.tjtcmc ) AS tcmc,
        p.org_name,
        mpg.orgreservationgroupname
        FROM md_peispatient p
        LEFT JOIN md_createcombo ON p.id_tjtc = md_createcombo.id
        LEFT JOIN md_createmeal ON p.id_tjtc = md_createmeal.id
        LEFT JOIN md_peisorgreservationgroup mpg ON p.id_orgreservationgroup = mpg.id
        <where>
            1 = 1
            <if test="param.fRegistered!=null and param.fRegistered == 0">
                AND p.f_registered = 1
            </if>
            <if test="param.patientcode!=null and param.patientcode!=''">
                AND p.patientcode LIKE concat('%',#{param.patientcode},'%')
            </if>
            <if test="param.inputCode!=null and param.inputCode!=''">
                AND (p.input_code LIKE concat('%',#{param.inputCode},'%')
                OR p.patientname LIKE concat('%',#{param.inputCode},'%'))
            </if>
            <if test="param.orgName!=null and param.orgName!=''">
                AND p.org_name LIKE concat('%',#{param.orgName},'%')
            </if>
            <if test="param.startTime!=null">
                AND p.dateregister <![CDATA[ >= ]]> #{param.startTime}
            </if>
            <if test="param.endTime!=null">
                AND p.dateregister <![CDATA[ <= ]]> #{param.endTime}
            </if>
        </where>
        GROUP BY p.patientcode
        ORDER BY p.dateregister DESC
    </select>



    <!--获取最近人员列表-->
    <select id="checkPatientarchiveno" resultType="com.center.medical.reception.bean.dto.CheckPaNoDto">
        SELECT
            p.id,
            p.patientcode,
            pa.patientarchiveno
        FROM
            md_peispatient p
                INNER JOIN md_peispatientarchive pa ON pa.id = p.patientarchiveno
    </select>
</mapper>

