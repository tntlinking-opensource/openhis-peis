<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.center.medical.workflow.dao.WorkflowReservationTypeMapper">

    <resultMap type="com.center.medical.workflow.bean.model.WorkflowReservationType" id="WorkflowReservationTypeMap">
        <id property="id" column="id"/>
        <result property="caseId" column="case_id"/>
        <result property="patientcode" column="patientcode"/>
        <result property="idPatientclass" column="id_patientclass"/>
        <result property="moneyamount" column="moneyamount"/>
        <result property="createdate" column="createdate"/>
        <result property="creator" column="creator"/>
        <result property="orderId" column="order_id"/>
    </resultMap>

    <!-- 数据表字段属性 -->
    <sql id="selectWorkflowReservationTypeVo">
        select id, case_id, patientcode, id_patientclass, moneyamount, createdate, creator,order_id
        from md_workflow_reservation_type
    </sql>

    <!-- 查询列表数据 -->
    <select id="getPage" resultMap="WorkflowReservationTypeMap">
        <include refid="selectWorkflowReservationTypeVo"/>
    </select>

    <!-- 根据主键id获取记录详情 -->
    <select id="getInfoById" resultMap="WorkflowReservationTypeMap">
        <include refid="selectWorkflowReservationTypeVo"/>
        <where>
            id = #{id}
        </where>
    </select>


    <!-- 查询待提交的审批 -->
    <select id="getToBeSubmitted" resultType="com.center.medical.workflow.bean.vo.ToBeSubmittedVo">
        SELECT
            wrt.id,
            wrt.patientcode,
            p.patientname,
            p.id_sex,
            p.idcardno,
            p.phone,
            wrt.id_patientclass,
            pcm.moneyamount,
            wrt.createdate
        FROM
            md_workflow_reservation_type wrt
                LEFT JOIN md_peispatient_charge_main pcm ON pcm.patientcode = wrt.patientcode
                LEFT JOIN md_peispatient p ON p.patientcode = wrt.patientcode
        <where>
            wrt.order_id = #{orderId}
            AND wrt.case_id is null
            <if test="groupId != null and groupId != ''">
                AND p.id_orgreservationgroup = #{groupId}
            </if>
        </where>
        order by wrt.createdate desc
    </select>



    <!-- 查询今天预约审批的人数 -->
    <select id="getTodayCount" resultType="java.lang.Integer">
        SELECT
        count(*)
        FROM
        md_workflow_reservation_type wrt
        inner join md_workflow_case wc on wc.id = wrt.case_id
        <where>
            wc.biz_id = #{orderId}
            AND wc.type_flag = 'OVER_RESERVATION'
            AND DATE(wc.createdate) = CURDATE()
        </where>
    </select>


    <!-- 根据实例ID获取审批用户 -->
    <select id="getListByCaseId" resultType="com.center.medical.workflow.bean.vo.ToBeSubmittedVo">
        SELECT
        wrt.id,
        wrt.patientcode,
        p.patientname,
        p.id_sex,
        p.idcardno,
        p.phone,
        wrt.id_patientclass,
        wrt.moneyamount,
        wrt.createdate
        FROM
        md_workflow_reservation_type wrt
        LEFT JOIN md_peispatient p ON p.patientcode = wrt.patientcode
        <where>
            wrt.case_id = #{caseId}
        </where>
        order by wrt.createdate desc
    </select>
</mapper>

